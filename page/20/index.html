<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>UBeaRLy</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="UBeaRLy&#039;s Proxy"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="UBeaRLy&#039;s Proxy"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="UBeaRLy"><meta property="og:url" content="https://xyy15926.github.io/"><meta property="og:site_name" content="UBeaRLy"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://xyy15926.github.io/img/og_image.png"><meta property="article:author" content="UBeaRLy"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://xyy15926.github.io"},"headline":"UBeaRLy","image":["https://xyy15926.github.io/img/og_image.png"],"author":{"@type":"Person","name":"UBeaRLy"},"publisher":{"@type":"Organization","name":"UBeaRLy","logo":{"@type":"ImageObject","url":"https://xyy15926.github.io/img/logo.svg"}},"description":""}</script><link rel="alternate" href="/atom.xml" title="UBeaRLy" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/darcula.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600&amp;family=Roboto+Mono"><link rel="stylesheet" href="/css/cyberpunk.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><script data-ad-client="ca-pub-5385776267343559" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><meta name="follow_it-verification-code" content="SVBypAPPHxjjr7Y4hHfn"><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="UBeaRLy" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Visit on GitHub" href="https://github.com/xyy15926/proxy"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-07-09T16:48:32.000Z" title="7/10/2019, 12:48:32 AM">2019-07-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-07-09T16:48:32.000Z" title="7/10/2019, 12:48:32 AM">2019-07-10</time></span><span class="level-item"><a class="link-muted" href="/categories/Java/">Java</a><span> / </span><a class="link-muted" href="/categories/Java/Scala/">Scala</a></span><span class="level-item">12 minutes read (About 1849 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Java/Scala/sbt.html">SBT</a></h1><div class="content"><h2 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h2><p>SBT：<em>simple build tools</em>，Scala世界的Maven</p>
<ul>
<li>下载、解压、将<code>SBT_HOME/bin</code>添加进<code>$PATH</code>即可</li>
<li>SBT中包含的Scala可通过<code>$ scala console</code>交互式启动解释器</li>
</ul>
<h3 id="参数命令"><a href="#参数命令" class="headerlink" title="参数命令"></a>参数命令</h3><ul>
<li><code>clean</code>：删除所有构建文件</li>
<li><code>compile</code>：编译源文件：<code>src/main/scala</code>、<code>src/main/java</code></li>
<li><code>test</code>：编译运行所有测试</li>
<li><code>console</code>：进入包含所有编译文件、依赖的classpath的scala
解释器<ul>
<li><code>:q[uit]</code>：退出</li>
</ul>
</li>
<li><code>run &lt;args&gt;</code>：在和SBT所处同一虚拟机上执行项目main class</li>
<li><code>package</code>：将<code>src/main/resources</code>、<code>src/main/scala</code>、
<code>src/main/java</code>中编译出class打包为jar</li>
<li><code>help &lt;cmd&gt;</code>：帮助</li>
<li><code>reload</code>：重新加载构建定义：<code>build.sbt</code>、<code>project.scala</code>
、<code>project.sbt</code></li>
<li><code>inspect &lt;key&gt;</code>：查看key描述</li>
<li><code>show &lt;key[:subkey]&gt;</code>：查看key对应value执行结果<ul>
<li>例：<code>show compile:dependencyClasspath</code></li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>以上命令可以在shell中作参数、在SBT命令行作命令</li>
<li>SBT命令行中历史记录查找同shell</li>
<li><code>~</code>前缀执行命令表示监视变化，源文件改变时自动执行该命令</li>
</ul>
</blockquote>
<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><ul>
<li><p><code>src</code>：<code>src</code>中其他目录将被忽略</p>
<ul>
<li><code>main</code>：主源码目录<ul>
<li><code>scala</code></li>
<li><code>java</code></li>
<li><code>resources</code>：存储资源，会被打进jar包<ul>
<li>分布式执行则每个节点可以访问全体资源，相当于
broadcast</li>
<li>访问时<code>resources</code>作为根目录，直接<code>/</code>列出相对
<code>resource</code>路径</li>
</ul>
</li>
</ul>
</li>
<li><code>test</code>：测试源码目录<ul>
<li><code>scala</code></li>
<li><code>java</code></li>
<li><code>resources</code></li>
</ul>
</li>
</ul>
</li>
<li><p><code>project</code>：可以包含<code>.scala</code>文件，和<code>.sbt</code>文件共同构成
完整构建定义</p>
<ul>
<li><code>Build.scala</code></li>
<li><code>plugins.sbt</code>：添加sbt插件</li>
</ul>
</li>
<li><p><code>target</code>：包含构建出的文件：classes、jar、托管文件、
caches、文档</p>
</li>
<li><p><code>lib</code>：存放非托管依赖</p>
<ul>
<li>其中jar被添加进<code>CLASSPATH</code>环境变量</li>
</ul>
</li>
<li><p><code>build.sbt</code>：包含构建定义</p>
<ul>
<li>其中隐式导入有<ul>
<li><code>sbt.Keys._</code>：包含内建key</li>
<li><code>sbt._</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="SBT配置"><a href="#SBT配置" class="headerlink" title="SBT配置"></a>SBT配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> # ~/.sbt/repositories</span><br><span class="line"> # 默认依赖仓库设置</span><br><span class="line"></span><br><span class="line">[repositories]</span><br><span class="line">	local</span><br><span class="line">	&lt;maven_repo_name&gt;: &lt;repo_address&gt;</span><br><span class="line">	&lt;ivy_repo_naem&gt;: &lt;repo_address&gt;, &lt;address_formation&gt;</span><br><span class="line"></span><br><span class="line"> # 地址格式可能如下</span><br><span class="line">[orgnanization]/[module]/(scala_[scalaVersion]/)(sbt_[sbtVersion]/)[revision]/[type]s/[artifact](-[classifier]).[ext]</span><br><span class="line"></span><br><span class="line"> # ali Maven2 repo</span><br><span class="line">aliyun: https://maven.aliyun.com/nexus/content/groups/public/</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>需要添加sbt启动参数<code>-Dsbt.override.build.repos=true</code>使
  覆盖默认生效</li>
</ul>
</blockquote>
<h2 id="Build-Definition"><a href="#Build-Definition" class="headerlink" title="Build Definition"></a><em>Build Definition</em></h2><p>构建定义：定义在<code>build.sbt</code>中、包含项目构建信息</p>
<blockquote>
<ul>
<li>多工程<code>.sbt</code>构建定义：可为代码中定义多个子项目，结构灵活</li>
<li>bare <code>.sbt</code>构建定义</li>
</ul>
</blockquote>
<ul>
<li>构建定义可以包含位于<code>project</code>目录下的<code>.scala</code>下的文件，
用于定义常用函数、值</li>
</ul>
<h3 id="多工程-sbt构建定义"><a href="#多工程-sbt构建定义" class="headerlink" title="多工程.sbt构建定义"></a>多工程<code>.sbt</code>构建定义</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义`TaskKey`</span></span><br><span class="line">lazy val hello = taskKey[Unit](<span class="string">&quot;example task&quot;</span>)</span><br><span class="line"><span class="comment">// 定义库ID</span></span><br><span class="line">val derby = <span class="string">&quot;org.apache.derby&quot;</span> % <span class="string">&quot;derby&quot;</span> % <span class="string">&quot;10.4.1.3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建名为`root`、位于当前目录的子项目</span></span><br><span class="line">lazy val root = (project in file(<span class="string">&quot;.&quot;</span>))</span><br><span class="line">	<span class="comment">// 在`.settings`方法中设置*setting expression*键值对</span></span><br><span class="line">	.settings(</span><br><span class="line">		name := <span class="string">&quot;hello&quot;</span>,</span><br><span class="line">		hello := &#123;prinln(<span class="string">&quot;hello&quot;</span>)&#125;,</span><br><span class="line">		libraryDependencies += derby</span><br><span class="line">	)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>构建定义拥有不可变的<code>Setting[T]</code>类型映射描述项目属性，
是会影响sbt保存键值对的map的转换</p>
<ul>
<li><code>T</code>：映射表中值类型</li>
<li>Setting描述<code>.settings</code>是对映射表的转换，增加新键值、
追加至已有值，转换后的映射成为sbt新映射</li>
</ul>
</li>
<li><p><code>build.sbt</code>文件中除设置外，可以包含<code>val</code>、<code>def</code>定义</p>
<ul>
<li>所有定义都在设置之前被计算，无论在文件中所处位置</li>
<li>一般使用<code>lazy val</code>避免初始化顺序问题</li>
</ul>
</li>
</ul>
<h3 id="Bare-sbt构建定义"><a href="#Bare-sbt构建定义" class="headerlink" title="Bare.sbt构建定义"></a>Bare<code>.sbt</code>构建定义</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">name := <span class="string">&quot;hello&quot;</span></span><br><span class="line">version := <span class="string">&quot;1.0&quot;</span></span><br><span class="line">scalaVersion := <span class="string">&quot;2.12.8&quot;</span></span><br><span class="line">library.<span class="type">Dependencies</span> += <span class="string">&quot;org.apache.derby&quot;</span> % <span class="string">&quot;derby&quot;</span> % <span class="string">&quot;10.4.1.3&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>bare <code>.sbt</code>构建定义由<code>Setting[_]</code>表达式列表组成</li>
</ul>
<h3 id="Keys"><a href="#Keys" class="headerlink" title="Keys"></a>Keys</h3><blockquote>
<ul>
<li><code>SettingKey[T]</code>：值仅在子项目载入时计算一次</li>
<li><code>TaskKey[T]</code>：值每次都需要被计算，可能有副作用</li>
<li><code>InputKey[T]</code>：值以命令行参数作为输入的任务</li>
</ul>
</blockquote>
<ul>
<li><p>可以通过各自创建方法创建自定义key</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给定value（返回）类型、键值对描述</span></span><br><span class="line"><span class="keyword">lazy</span> <span class="keyword">val</span> hello = taskKey[<span class="type">Unit</span>](<span class="string">&quot;task key demo&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>在sbt交互模式下，可以输入key名称获取、执行value</p>
<ul>
<li>setting key：获取、显示value</li>
<li>task key：执行value，但不会显示执行结果，需要
<code>show &lt;task&gt;</code>才会打印执行结果</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>Key可以视为<strong>为项目定义的属性、trigger</strong></li>
<li><code>taskiness</code>（每次执行）可以视为task key的属性</li>
</ul>
</blockquote>
<h3 id="sbt-Keys内建Key"><a href="#sbt-Keys内建Key" class="headerlink" title="sbt.Keys内建Key"></a><code>sbt.Keys</code>内建Key</h3><ul>
<li>内建Key中泛型参数已经确定，定制需要满足类型要求</li>
</ul>
<h4 id="项目属性"><a href="#项目属性" class="headerlink" title="项目属性"></a>项目属性</h4><ul>
<li><code>name</code>：项目名称，默认为项目变量名</li>
<li><code>baseDirectory</code>：项目根目录</li>
<li><code>sourceDirectories</code>：源码目录<ul>
<li><code>compile:_</code>：编译时设置</li>
</ul>
</li>
<li><code>sourceDirectory</code>：源码上层目录？</li>
</ul>
<h4 id="依赖相关"><a href="#依赖相关" class="headerlink" title="依赖相关"></a>依赖相关</h4><ul>
<li><code>unmanageBase</code>：指定非托管依赖目录</li>
<li><code>unmanagedJars</code>：列举<code>unmanagedBase</code>目录下所有jar
的task key</li>
<li><code>dependencyClasspath</code>：非托管依赖classpath<ul>
<li><code>compile:_</code>：编译时设置</li>
<li><code>runtime:_</code>：运行时设置</li>
</ul>
</li>
<li><code>libraryDependecies</code>：指定依赖、设置classpath<ul>
<li>直接列出</li>
<li>Maven POM文件</li>
<li>Ivy配置文件</li>
</ul>
</li>
<li><code>resolvers</code>：指定额外解析器，Ivy搜索服务器指示</li>
<li><code>externalResolvers</code>：组合<code>resolvers</code>、默认仓库的task key<ul>
<li>定制其以覆盖默认仓库</li>
</ul>
</li>
</ul>
<h4 id="运行相关"><a href="#运行相关" class="headerlink" title="运行相关"></a>运行相关</h4><ul>
<li><p><code>package</code>：打包系列Task</p>
<ul>
<li>类型：<code>TaskKey[File]</code>的task key</li>
<li>返回值：生成的jar文件</li>
</ul>
</li>
<li><p><code>compile</code>：编译系列Task</p>
</li>
</ul>
<h3 id="sbt特殊方法"><a href="#sbt特殊方法" class="headerlink" title=".sbt特殊方法"></a><code>.sbt</code>特殊方法</h3><blockquote>
<ul>
<li>常用类型<code>String</code>等的方法仅在<code>.sbt</code>中可用</li>
<li>方法的具体行为、返回值略有差异</li>
</ul>
</blockquote>
<h4 id="XXXXKey-T-："><a href="#XXXXKey-T-：" class="headerlink" title="XXXXKey[T]："></a><code>XXXXKey[T]</code>：</h4><ul>
<li><p><code>:=</code>：给<code>Setting[T]</code>赋值、计算，并返回<code>Setting[T]</code></p>
<ul>
<li><code>SettingKey[T].:=</code>返回<code>Setting[T]</code></li>
<li><code>TaskKey[T].:=</code>返回<code>Setting[Task[T]]</code></li>
</ul>
</li>
<li><p><code>in</code>：获取其他Key的子Key</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sourceDirectories in <span class="type">Compile</span> += <span class="type">Seq</span>(file(<span class="string">&quot;1&quot;</span>), file(<span class="string">&quot;2&quot;</span>))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="SettingKey-T-："><a href="#SettingKey-T-：" class="headerlink" title="SettingKey[T]："></a><code>SettingKey[T]</code>：</h4><ul>
<li><code>+=</code>：<strong>追加</strong>单个元素至列表</li>
<li><code>++=</code>：连接两个列表</li>
</ul>
<h4 id="String"><a href="#String" class="headerlink" title="String"></a><code>String</code></h4><ul>
<li><code>%</code>：从字符串构造Ivy <code>ModuleID</code>对象</li>
<li><code>%%</code>：sbt会在actifact中加上项目的scala版本号<ul>
<li>也可手动添加版本号替代</li>
<li>很多依赖会被编译给多个Scala版本，可以确保兼容性</li>
</ul>
</li>
<li><code>at</code>：创建<code>Resolver</code>对象</li>
</ul>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><h3 id="非托管依赖"><a href="#非托管依赖" class="headerlink" title="非托管依赖"></a>非托管依赖</h3><p>非托管依赖：<code>lib/</code>目录下的jar文件</p>
<ul>
<li>其中jar被添加进classpath<ul>
<li>对<code>compile</code>、<code>test</code>、<code>run</code>、<code>console</code>都成立</li>
<li>可通过<code>dependencyClasspath</code>改变设置[某个]classpath</li>
</ul>
</li>
</ul>
<h4 id="相关Key使用"><a href="#相关Key使用" class="headerlink" title="相关Key使用"></a>相关Key使用</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定制非托管依赖目录</span></span><br><span class="line">dependencyClasspath in <span class="type">Compile</span> += &lt;path&gt;</span><br><span class="line">dependencyClasspath in <span class="type">Runtime</span> += &lt;path&gt;</span><br><span class="line"><span class="comment">// 定制非托管目录</span></span><br><span class="line">unmanagedBase := baseDirectory.value / <span class="string">&quot;custom_lib&quot;</span></span><br><span class="line"><span class="comment">// 清空`compile`设置列表</span></span><br><span class="line">unmanagedJars in <span class="type">Compile</span> := <span class="type">Seq</span>.empty[sbt.<span class="type">Attributed</span>[java.io.<span class="type">File</span>]]</span><br></pre></td></tr></table></figure>
<h3 id="托管依赖"><a href="#托管依赖" class="headerlink" title="托管依赖"></a>托管依赖</h3><p>托管依赖：由sbt根据<code>build.sbt</code>中设置自动维护依赖</p>
<ul>
<li>使用<em>Apache Ivy</em>实现托管依赖</li>
<li>默认使用Maven2仓库</li>
</ul>
<h4 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dep_exp ::= &lt;groupID&gt; % &lt;artifactID&gt; % &lt;revision&gt;[% &lt;configuraion&gt;] [% <span class="string">&quot;test&quot;</span> | % <span class="type">Test</span>] [% <span class="string">&quot;provided&quot;</span>]</span><br><span class="line"></span><br><span class="line">resolver_exp ::= &lt;name&gt; at &lt;location&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>groupID</code>：</li>
<li><code>acrtifactID</code>：工件名称</li>
<li><code>revision</code>：版本号，无需是固定版本号<ul>
<li><code>&quot;latest.integration&quot;</code></li>
<li><code>&quot;2.9.+&quot;</code></li>
<li><code>[1.0,)</code></li>
</ul>
</li>
<li>可选选项<ul>
<li><code>&quot;test&quot;|Test</code>：仅在<code>Test</code>配置的classpath中出现</li>
<li><code>&quot;provided&quot;</code>：由环境提供，assembly打包时将不打包该
依赖</li>
</ul>
</li>
<li><code>name</code>：指定Maven仓库名称</li>
<li><code>location</code>：服务器地址</li>
</ul>
<h4 id="依赖添加"><a href="#依赖添加" class="headerlink" title="依赖添加"></a>依赖添加</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `sbt.Keys`中依赖声明</span></span><br><span class="line"><span class="keyword">val</span> libraryDependencies = settingKey[<span class="type">Seq</span>[<span class="type">ModuleID</span>]](<span class="string">&quot;Delares managed dependencies&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加单个依赖</span></span><br><span class="line">libraryDependencies += dep_exp</span><br><span class="line"><span class="comment">// 添加多个依赖</span></span><br><span class="line">libraryDependencies ++= <span class="type">Seq</span>(</span><br><span class="line">	dep_exp,</span><br><span class="line">	dep_exp,</span><br><span class="line">	&lt;groupID&gt; %% &lt;artifactID&gt; % &lt;revision&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="解析器添加"><a href="#解析器添加" class="headerlink" title="解析器添加"></a>解析器添加</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `sbt.Keys`中解析器声明</span></span><br><span class="line"><span class="keyword">val</span> resolvers += settingKeys[<span class="type">Seq</span>[<span class="type">Resolver</span>]](<span class="string">&quot;extra resolvers&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加本地Maven仓库</span></span><br><span class="line">resolvers += resolver_exp</span><br><span class="line">resolvers += <span class="type">Resolver</span>.mavenLocal</span><br><span class="line">resolvers += <span class="string">&quot;Loal Maven Repo&quot;</span> at <span class="string">&quot;file://&quot;</span> + <span class="type">Path</span>.userHome.absolutePath+<span class="string">&quot;/.m2/repository&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将自定义解析器至于默认`externalResolvers`前</span></span><br><span class="line">externalResolvers := <span class="type">Seq</span>(</span><br><span class="line">	resolver_exp</span><br><span class="line">) ++ externalResolvers.values</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>externalResolvers</code>中包含默认解析器，sbt会将此列表值拼接
  至<code>resolvers</code>之前，即仅修改<code>resolvers</code>仍然会有限使用默认
  解析器</li>
</ul>
</blockquote>
<h2 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h2><h3 id="project-plugins-sbt"><a href="#project-plugins-sbt" class="headerlink" title="project/plugins.sbt"></a><code>project/plugins.sbt</code></h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// assembly插件</span></span><br><span class="line"><span class="comment">// `assembly`：将依赖加入jar包，修改jar包配置文件</span></span><br><span class="line">addSbtPlugin(<span class="string">&quot;com.eed3si9n&quot;</span> % <span class="string">&quot;sbt-assembly&quot;</span> % <span class="string">&quot;0.14.6&quot;</span>)</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-30T12:16:34.000Z" title="6/30/2019, 8:16:34 PM">2019-06-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-07-12T10:10:43.000Z" title="7/12/2020, 6:10:43 PM">2020-07-12</time></span><span class="level-item"><a class="link-muted" href="/categories/Linux/">Linux</a><span> / </span><a class="link-muted" href="/categories/Linux/Tool/">Tool</a></span><span class="level-item">8 minutes read (About 1160 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Linux/Tool/tmux.html">Tmux</a></h1><div class="content"><h2 id="Tmux"><a href="#Tmux" class="headerlink" title="Tmux"></a>Tmux</h2><ul>
<li><p>Session：用户与计算计算机的交互</p>
<ul>
<li>一般而言，temrinal窗口、Session进程绑定<ul>
<li>打开窗口，Session开始</li>
<li>关闭窗口，Session结束</li>
</ul>
</li>
</ul>
</li>
<li><p>Tmux：终端复用软件，将terminal窗口、Session解绑</p>
<ul>
<li>允许多个窗口接入、断开多个Session<ul>
<li>新增多个Session</li>
<li>接入已有Session，共享Session</li>
</ul>
</li>
<li>支持窗口竖直、水平拆分</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man1/tmux.1.html">https://man7.org/linux/man-pages/man1/tmux.1.html</a></p>
<h2 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h2><ul>
<li><code>-S &lt;socket-file&gt;</code>：指定tmux使用socket文件（位置）</li>
</ul>
<h3 id="Session管理"><a href="#Session管理" class="headerlink" title="Session管理"></a>Session管理</h3><ul>
<li><code>tmux new -s &lt;session-name&gt;</code>：创建指定名称session<ul>
<li>缺省数字命名</li>
</ul>
</li>
<li><code>tmux detach</code>：detach当前接入会话</li>
<li><code>tmux ls/list-session</code>：列出session列表</li>
<li><code>tmux rename -t &lt;s1&gt; &lt;s2&gt;</code>：重命名session</li>
<li><code>tmux a [-t &lt;session-name&gt;]</code>：attach指定session<ul>
<li>缺省连接上个session</li>
</ul>
</li>
<li><code>tmux switch -t &lt;session-name&gt;</code>：切换至指定session</li>
<li><code>tmux kill-session [[-a] -t s1]</code>：关闭session<ul>
<li>缺省关闭上次session</li>
<li><code>-a</code>：关闭除指定session外其他session</li>
</ul>
</li>
<li><code>tmux kill-server</code>：关闭所有session</li>
</ul>
<h3 id="Tab（Windows）管理"><a href="#Tab（Windows）管理" class="headerlink" title="Tab（Windows）管理"></a>Tab（Windows）管理</h3><ul>
<li><code>tmux new-window [-n &lt;win-name&gt;]</code>：创建新窗口</li>
<li><code>tmux switch-window -t &lt;win-name&gt;</code>：切换到指定窗口</li>
<li><code>tmux rename-window &lt;win-name&gt;</code>：重命名当前窗口</li>
</ul>
<h3 id="Pane管理"><a href="#Pane管理" class="headerlink" title="Pane管理"></a>Pane管理</h3><ul>
<li><code>tmux split-window [-h]</code>：竖直/水平划分窗口</li>
<li><code>tmux select-pane -U/-D/-L/-R</code>：激活上、下、左、右侧Pane</li>
<li><code>tmux swap-pange -U/-D/-L/-R</code>：当前Pane上、下、左、右
移动</li>
</ul>
<h3 id="帮助"><a href="#帮助" class="headerlink" title="帮助"></a>帮助</h3><ul>
<li><code>tmux list-key</code>：列出所有绑定键</li>
<li><code>tmux list-command</code>：列出所有命令</li>
<li><code>tmux info</code>：列出当前所有Tmux会话信息</li>
<li><code>tmux source-file &lt;tmux-conf&gt;</code>：重新加载Tmux配置文件</li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="set"><a href="#set" class="headerlink" title="set"></a><code>set</code></h3><blockquote>
<ul>
<li>默认配置文件为<code>~/.tmux.conf</code></li>
</ul>
</blockquote>
<ul>
<li><p><code>set[-option] [-g] [-a]</code>：session选项</p>
<ul>
<li>全局、追加标志<ul>
<li><code>-g</code>：全局设置</li>
<li><code>-a</code>：追加设置，适合<code>option</code>需要字符串、样式值</li>
</ul>
</li>
<li><code>default-terminal</code></li>
<li><code>display-time</code></li>
<li><code>escape-time</code></li>
<li><code>history-limit</code></li>
<li><code>base-index</code></li>
<li><code>pane-base-index</code></li>
</ul>
</li>
<li><p><code>setw/set-window-option [-g] [-a]</code>：window选项</p>
<ul>
<li>全局、追加标志同<code>set[-option]</code></li>
<li><code>allow-rename</code></li>
<li><code>mode-keys</code>：快捷键模式，可以设置为<code>vi</code></li>
<li><code>synchronize-panes</code></li>
</ul>
</li>
<li><p><code>set[-option] -s</code>：server选项</p>
</li>
</ul>
<h4 id="StatusBar设置"><a href="#StatusBar设置" class="headerlink" title="StatusBar设置"></a>StatusBar设置</h4><ul>
<li><p>StatusBar主要由5部分组成</p>
<ul>
<li>windows列表<ul>
<li><code>windows-status-*</code>：默认windows</li>
<li><code>windows-status-current-*</code>：当前windows</li>
<li><code>windows-status-bell-*</code>：后台有活动windows
（需开启支持）</li>
</ul>
</li>
<li>左侧显示区</li>
<li>右侧显示区</li>
<li>message显示条：占据整个status bar</li>
<li>command输入条：占据整个status bar</li>
</ul>
</li>
<li><p><code>*-style bg=&lt;color&gt;,fg=&lt;color&gt;,&lt;ATTR&gt;</code>指定样式</p>
<ul>
<li>颜色可以用名称、<code>colour[0-255]</code>、<code>#RGB</code>方式指定</li>
<li>属性包括（前加<code>no</code>表关闭）<ul>
<li><code>bright</code></li>
<li><code>dim</code></li>
<li><code>underscore</code></li>
<li><code>blink</code></li>
<li><code>reverse</code></li>
<li><code>hidden</code></li>
<li><code>italics</code></li>
<li><code>strikethrough</code></li>
</ul>
</li>
</ul>
</li>
<li><p><code>*-format</code>：设置格式</p>
<ul>
<li><code>#&#123;&#125;</code>中变量名称会被替换为相应值，支持alias缩写的变量
可以省略<code>&#123;&#125;</code><ul>
<li><code>host</code>：<code>#H</code></li>
<li><code>host_short</code>：<code>#h</code></li>
<li><code>pane_id</code>：<code>#D</code></li>
<li><code>pane_index</code>：<code>#P</code></li>
<li><code>pane_title</code>：<code>#T</code></li>
<li><code>session_name</code>：<code>#S</code></li>
<li><code>window_flags</code>：<code>#F</code><ul>
<li><code>*</code>：当前窗口</li>
<li><code>-</code>：最后打开的窗口</li>
<li><code>z</code>：Zoom窗口</li>
</ul>
</li>
<li><code>window_index</code>：<code>#I</code></li>
<li><code>window_name</code>：<code>#W</code></li>
</ul>
</li>
<li><code>#()</code>会被作为shell命令执行并被替换<ul>
<li>命令执行不会阻塞tmux，而是展示最近一次命令执行
结果</li>
<li>刷新频率由<code>status-interval</code>控制</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>这里介绍2.9之后配置风格</li>
</ul>
</blockquote>
<h3 id="bind"><a href="#bind" class="headerlink" title="bind"></a><code>bind</code></h3><ul>
<li><code>bind[-key] [-n] [-r] &lt;key&gt;</code>：key mapping<ul>
<li><code>-n</code>：无需prefix</li>
<li><code>-r</code>：此键可能重复</li>
</ul>
</li>
<li><code>unbind &lt;key&gt;</code>：解绑捕获</li>
</ul>
<h2 id="默认KeyMappings"><a href="#默认KeyMappings" class="headerlink" title="默认KeyMappings"></a>默认KeyMappings</h2><ul>
<li>快捷键前缀缺省为<code>C-b</code></li>
<li><code>&lt;prefix&gt;:</code>：进入命令行</li>
</ul>
<blockquote>
<ul>
<li>以下快捷键都是缺省值，可以解绑</li>
</ul>
</blockquote>
<h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h3><ul>
<li><code>s</code>：列出session，可用于切换</li>
<li><code>$</code>：重命名session</li>
<li><code>d</code>：detach当前session</li>
<li><code>D</code>：detach指定session</li>
</ul>
<h3 id="Tab-Windows"><a href="#Tab-Windows" class="headerlink" title="Tab/Windows"></a>Tab/Windows</h3><ul>
<li><code>c</code>：创建新tab</li>
<li><code>&amp;</code>：关闭当前tab</li>
<li><code>,</code>：重命名当前tab</li>
<li><code>.</code>：修改当前tab索引编号</li>
<li><code>w</code>：列出所有tab</li>
<li><code>n</code>/<code>p</code>/<code>l</code>：进入下个/上个/之前操作tab</li>
<li><code>[tab-n]</code>：切换到指定<strong>编号</strong>窗口</li>
<li><code>f</code>：根据显示内容搜索tab</li>
</ul>
<blockquote>
<ul>
<li>tmux中window相当于tab</li>
</ul>
</blockquote>
<h3 id="Panes"><a href="#Panes" class="headerlink" title="Panes"></a>Panes</h3><ul>
<li><code>%</code>：水平方向创建窗口</li>
<li><code>&quot;</code>：竖直方向创建窗口</li>
<li><code>Up/Down/Left/Right</code>：根据箭头访问切换窗口</li>
<li><code>q</code>：显示窗口编号</li>
<li><code>o</code>：顺时针切换窗口</li>
<li><code>&#125;</code>/<code>&#123;</code>：与下个/上个窗口交换位置</li>
<li><code>space</code>：在预置面板布局中循环切换<ul>
<li>even-horizontal</li>
<li>even-vertical</li>
<li>main-horizontal</li>
<li>main-vertical</li>
<li>tiled</li>
</ul>
</li>
<li><code>!</code>：将当前窗口置于新tab</li>
<li><code>C-o</code>/<code>M-o</code>：顺/逆时针旋转当前窗口，即所有窗口循环前/后
移动一个位次</li>
<li><code>t</code>：在当前窗口显示时间</li>
<li><code>z</code>：最大/恢复当前窗口</li>
<li><code>i</code>：显示当前窗口信息</li>
<li><code>x</code>：关闭当前窗口</li>
<li><code>q</code>：显示当前窗口编号</li>
<li><code>[</code>：进入自由复制模式，<em>VI</em> 模式下快捷键同 <em>VI</em>，且<ul>
<li><code>&lt;space&gt;</code>：从光标处开始选择（支持 <code>V</code> 选择行）</li>
<li><code>&lt;enter&gt;</code>：复制选择部分</li>
</ul>
</li>
<li><code>]</code>：粘贴</li>
</ul>
<blockquote>
<ul>
<li>tmux中pane相当于vim中windows</li>
</ul>
</blockquote>
<h3 id="信息"><a href="#信息" class="headerlink" title="信息"></a>信息</h3><ul>
<li><code>?</code>：列出所有绑定键</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-26T17:01:10.000Z" title="6/27/2019, 1:01:10 AM">2019-06-27</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-06-26T17:01:10.000Z" title="6/27/2019, 1:01:10 AM">2019-06-27</time></span><span class="level-item"><a class="link-muted" href="/categories/Math-Analysis/">Math Analysis</a><span> / </span><a class="link-muted" href="/categories/Math-Analysis/Optimization/">Optimization</a></span><span class="level-item">7 minutes read (About 999 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Math-Analysis/Optimization/lagrange_duality.html">Lagrange 对偶</a></h1><div class="content"><h2 id="Langrangian-Duality"><a href="#Langrangian-Duality" class="headerlink" title="Langrangian Duality"></a><em>Langrangian Duality</em></h2><p>拉格朗日对偶</p>
<ul>
<li><p>考虑优化问题：找到$f(x)$满足约束的最好下界</p>
<script type="math/tex; mode=display">
z^{*} = \min_{x} f(x) \\
\begin{align*}
s.t. \quad & g_i(x) \leq 0, i=1,2,\cdots,m \\
   & x \in X
\end{align*}</script></li>
<li><p>考虑方程组</p>
<script type="math/tex; mode=display">
\left \{ \begin{array}{l}
f(x) < v \\
g_i(x) \leq 0, i=1,2,\cdots,m
\end{array} \right.</script><ul>
<li><p><strong>方程组无解</strong>：$v$是优化问题的一个下界</p>
</li>
<li><p><strong>方程组有解</strong>：则可以推出</p>
<script type="math/tex; mode=display">
\forall \lambda \geq 0, \exists x, 
f(x) + \sum_{i=1}^m \lambda_ig_i(x) < v</script><blockquote>
<ul>
<li>显然，取$g_1 + g_2 = 0, g_1(x) &gt; 0$是反例，不能
推出原方程有解</li>
</ul>
</blockquote>
</li>
<li><p>由以上方程组有解逆否命题：方程组无解<strong>充分条件</strong>如下</p>
<script type="math/tex; mode=display">
\exists \lambda \geq 0,
\min_{x} f(x) + \sum _{i=1}^m \lambda_ig_i(x) \geq v</script></li>
</ul>
</li>
<li><p>由此方法推出的最好下界，即拉格朗日对偶问题</p>
<script type="math/tex; mode=display">
v^{*} = \max_{\lambda \geq 0} \min_{x} f(x) +
   \sum_{i=1}^m \lambda_ig_i(x)</script></li>
</ul>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><ul>
<li><p>拉格朗日对偶对实数域上的优化问题都存在，对目标函数、
约束函数都没有要求</p>
</li>
<li><p>强对偶定理：$v^{<em>} = z^{</em>}$，需要$f,g$满足特定条件才成立</p>
<ul>
<li>线性规划</li>
<li>半正定规划</li>
<li>凸优化</li>
</ul>
<blockquote>
<ul>
<li>即需要给约束条件加以限制，使得<script type="math/tex; mode=display">
 \forall \lambda \geq 0, \exists x, 
 f(x) + \sum_{i=1}^m \lambda_ig_i(x) < v</script> 是上述方程组有解的冲要条件</li>
</ul>
</blockquote>
</li>
<li><p>弱对偶定理：$v^{<em>} \leq z^{</em>}$，永远成立（以上即可证）</p>
<ul>
<li>通过弱对偶定理，可以得到原问题的一个下界</li>
<li>对求解原问题有帮助，比如：分支界限法中快速求下界</li>
</ul>
</li>
<li><p>对偶问题相关算法往往原问题算法在实际应用中往往更加有效</p>
<ul>
<li><em>dual-simplex</em></li>
<li><em>primal-dual interior point method</em></li>
<li><em>augmented Lagrangian Method</em></li>
</ul>
</li>
</ul>
<h2 id="原始问题"><a href="#原始问题" class="headerlink" title="原始问题"></a>原始问题</h2><p>约束最优化问题</p>
<script type="math/tex; mode=display">\begin{array}{l}
\min_{x \in R^n} & f(x) \\
s.t. & c_i(x) \leq 0, i = 1,2,\cdots,k \\
& h_j(x) = 0, j = 1,2,\cdots,l
\end{array}</script><h3 id="Generalized-Lagrange-Function"><a href="#Generalized-Lagrange-Function" class="headerlink" title="Generalized Lagrange Function"></a><em>Generalized Lagrange Function</em></h3><ul>
<li><p>引入<em>Generalized Lagrange Function</em></p>
<script type="math/tex; mode=display">
L(x, \alpha, \beta) = f(x) + \sum_{i=1}^k \alpha_i
   c_i(x) + \sum_{j=1}^l \beta_j h_j(x)</script><blockquote>
<ul>
<li>$x=(x_1, x_2, \cdots, x_n) \in R^n$</li>
<li>$\alpha_i \geq 0, \beta_j$：拉格朗日乘子</li>
</ul>
</blockquote>
</li>
<li><p>考虑关于x的函数</p>
<script type="math/tex; mode=display">
\theta_P(x) = \max_{\alpha, \beta: \alpha_i \geq 0}
   L(x, \alpha, \beta)</script><blockquote>
<ul>
<li>$P$：primal，原始问题</li>
</ul>
</blockquote>
<ul>
<li><p>若x满足原始问题的两组约束条件，则$\theta_P(x)=f(x)$</p>
</li>
<li><p>若x违反等式约束j，取$\beta_j \rightarrow \infty$，
则有$\theta_P(x) \rightarrow \infty$</p>
</li>
<li><p>若x违反不等式约束i，取$\alpha_i \rightarrow \infty$
，则有$\theta_P(x) \rightarrow \infty$</p>
</li>
</ul>
<p>则有</p>
<script type="math/tex; mode=display">\theta_P(x) = \left \{ \begin{array}{l}
f(x), & x 满足原始问题约束条件 \\
+\infty, & 其他
\end{array} \right.</script></li>
<li><p>则极小化问题，称为广义拉格朗日函数的极小极大问题</p>
<script type="math/tex; mode=display">
\min_x \theta_P(x) = \max_{\alpha, \beta: \alpha_i \geq 0}
   L(x, \alpha, \beta)</script><p>与原始最优化问题等价，两问题最优值相同，记为</p>
<script type="math/tex; mode=display">
p^{*} = \min_x \theta_P(x)</script></li>
</ul>
<h2 id="对偶问题"><a href="#对偶问题" class="headerlink" title="对偶问题"></a>对偶问题</h2><ul>
<li><p>定义</p>
<script type="math/tex; mode=display">
\theta_D (\alpha, \beta) = \min_x L(x, \alpha, \beta)</script></li>
<li><p>再考虑极大化$\theta_D(\alpha, \beta)$，得到广义拉格朗日
函数的极大极小问题，即</p>
<script type="math/tex; mode=display">
\max_{\alpha, \beta: \alpha \geq 0}
   \theta_D(\alpha, \beta) =
   \max_{\alpha, \beta: \alpha \geq 0} \min_x
   L(x, \alpha, \beta)</script><p>表示为约束最优化问题如下</p>
<script type="math/tex; mode=display">\begin{align*}
\max_{\alpha, \beta} & \theta_D(\alpha, \beta) =
   \max_{\alpha, \beta} \min_x L(x, \alpha, \beta) \\
s.t. & \alpha_i \geq 0, i=1,2,\cdots,k
\end{align*}</script><p>称为原始问题的对偶问题，其最优值定义记为</p>
<script type="math/tex; mode=display">
d^{*} = \max_{\alpha, \beta: \alpha \geq 0}
   \theta_D(\alpha, \beta)</script></li>
</ul>
<h2 id="原始、对偶问题关系"><a href="#原始、对偶问题关系" class="headerlink" title="原始、对偶问题关系"></a>原始、对偶问题关系</h2><h3 id="定理1"><a href="#定理1" class="headerlink" title="定理1"></a>定理1</h3><blockquote>
<ul>
<li>若原始问题、对偶问题都有最优值，则<script type="math/tex; mode=display">
  d^{*} = \max_{\alpha, \beta: \alpha \geq 0} \min_x
      L(x, \alpha, \beta) \leq
  \min_x \max_{\alpha, \beta: \alpha \geq 0}
      L(x, \alpha, \beta) = p^{*}</script></li>
</ul>
</blockquote>
<ul>
<li><p>$\forall x, \alpha, \beta$有</p>
<script type="math/tex; mode=display">
\theta_D(\alpha, \beta) = \min_x L(x, \alpha, \beta)
   \leq L(x, \alpha, \beta) \leq
   \max_{\alpha, \beta: \alpha \geq 0} = \theta_P(x)</script><p>即</p>
<script type="math/tex; mode=display">
\theta_D(\alpha, \beta) \leq \theta_P(x)</script></li>
<li><p>而原始、对偶问题均有最优值，所以得证</p>
</li>
</ul>
<blockquote>
<ul>
<li>设$x^{<em>}$、$\alpha^{</em>}, \beta^{<em>}$分别是原始问题、对偶
  问题的可行解，且$d^{</em>} = p^{*}$，则其分别是原始问题、
  对偶问题的最优解</li>
</ul>
</blockquote>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-11T09:32:52.000Z" title="6/11/2019, 5:32:52 PM">2019-06-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-02T03:46:49.000Z" title="8/2/2021, 11:46:49 AM">2021-08-02</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3Ref/">Py3Ref</a></span><span class="level-item">10 minutes read (About 1484 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3Ref/execution_model.html">Python执行模型</a></h1><div class="content"><h2 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h2><h3 id="Code-Blocks"><a href="#Code-Blocks" class="headerlink" title="Code Blocks"></a><em>Code Blocks</em></h3><p>代码块：作为一个单元执行的一段python文本，代码块构成python
程序</p>
<ul>
<li>模块、函数体、类定义</li>
<li>交互式输入的每条命令</li>
<li>作为标准输入、命令行参数发送给解释器的脚本文件</li>
<li>脚本命令</li>
<li>传递给<code>eval()</code>、<code>exec()</code>的字符串参数</li>
</ul>
<blockquote>
<ul>
<li>代码块在执行帧中执行，执行帧包含某些用于调试的管理信息
  并决定代码块执行完成后操作</li>
</ul>
</blockquote>
<h2 id="Naming、Binding"><a href="#Naming、Binding" class="headerlink" title="Naming、Binding"></a><em>Naming</em>、<em>Binding</em></h2><h3 id="Binding-of-Names"><a href="#Binding-of-Names" class="headerlink" title="Binding of Names"></a><em>Binding of Names</em></h3><blockquote>
<ul>
<li>名称：用于<strong>指代对象</strong>，通过名称绑定操作引入</li>
</ul>
</blockquote>
<ul>
<li><p>名称绑定方法</p>
<ul>
<li>传递参数</li>
<li><code>import</code>语句<ul>
<li><code>from ... import *</code>会绑定被导入模块中定义的所有
公有名称（仅在模块层级上被使用）</li>
</ul>
</li>
<li>类、函数定义</li>
<li>以标识符为目标的赋值</li>
<li><p><code>for</code>循环开头、<code>with</code>和<code>except</code>子句的<code>as</code>之后</p>
</li>
<li><p><code>del</code>语句的目标也被视为绑定，虽然实际语义为解除名称
绑定</p>
</li>
</ul>
</li>
<li><p>变量类型</p>
<ul>
<li>局部变量：绑定在代码块中的名称，且未声明为<code>nonlocal</code>
、或<code>global</code></li>
<li>全局变量：绑定在模块层级的名称<ul>
<li>模块代码块中变量既为全局变量、也是局部变量</li>
</ul>
</li>
<li>自由变量：在代码块中使用但未在其中定义的变量</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>自由变量不同于闭包变量，函数闭包变量<code>__closure__</code>要求
  自由变量来自于父函数作用域</li>
</ul>
</blockquote>
<h3 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a><em>Scope</em></h3><p>作用域：定义了代码块中名称的可见性</p>
<ul>
<li><p>名称的作用域包含</p>
<ul>
<li>定义该变量代码块</li>
<li>定义变量代码块所包含的代码块
（除非被包含代码块中引入对该名称不同绑定）</li>
</ul>
</li>
<li><p>名称作用域虽然包括定义变量代码块所包含的代码块</p>
<ul>
<li>可以直接访问变量</li>
<li>但修改变量必须使用<code>global</code>、<code>local</code>等声明</li>
</ul>
</li>
<li><p>在代码块内任何位置进行名称绑定，则代码块内所有对该名称
的使用被认为是<strong>对代码块的引用</strong></p>
<blockquote>
<ul>
<li>python没有声明语法，则代码块中局部变量可通过，在整个
 代码块文本中扫描名称绑定来确定</li>
</ul>
</blockquote>
</li>
<li><p><strong>模块作用域在模块第一次被导入时创建</strong></p>
</li>
</ul>
<h3 id="Resolution-of-Names"><a href="#Resolution-of-Names" class="headerlink" title="Resolution of Names"></a><em>Resolution of Names</em></h3><ul>
<li><p>若名称在代码块中被使用，会由<strong>包含它的最近作用域</strong>来解析</p>
</li>
<li><p>若名称完全无法找到将<code>raise NameError</code></p>
</li>
<li><p>若当前作用域为函数作用域，且名称指向局部变量，若名称被
绑定值前被被使用将<code>raise UnboundLocalError</code>
（<code>UnboundLocalError</code>是<code>NameError</code>子类）</p>
</li>
</ul>
<blockquote>
<ul>
<li>（代码块）环境：对代码块可见的所作用域集合</li>
</ul>
</blockquote>
<h4 id="global"><a href="#global" class="headerlink" title="global"></a><code>global</code></h4><ul>
<li><p>对<code>global</code>指定名称的使用是对<strong>最高层级命名空间</strong>中该名称
绑定的引用</p>
<ul>
<li>全局命名空间：包含代码块的模块命名空间</li>
<li>内置命名空间：<code>builtins</code>模块的命名空间</li>
</ul>
</li>
<li><p><code>global</code>语句与同一代码块中名称绑定具有相同作用域</p>
<ul>
<li>若自由变量最近包含作用域中有<code>global</code>语句，其也会被
当作全局变量</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li><code>global</code>语句须在名称使用之前声明</li>
</ul>
</blockquote>
<h4 id="nonlocal"><a href="#nonlocal" class="headerlink" title="nonlocal"></a><code>nonlocal</code></h4><ul>
<li><p><code>nonlocal</code>使得相应名称指向最近包含函数作用域的中绑定的
变量</p>
</li>
<li><p>指定名称不存在于任何包含函数作用域则<code>raise SyntaxError</code></p>
</li>
</ul>
<h4 id="内置命名空间"><a href="#内置命名空间" class="headerlink" title="内置命名空间"></a>内置命名空间</h4><ul>
<li><p>与代码块执行相关联的内置命名空间实际上是通过其在全局命名
空间中搜索名称<code>__builtins__</code>找到，一般是字典、模块
（此时使用模块的命名空间字典）</p>
</li>
<li><p>默认情况下</p>
<ul>
<li><code>__main__</code>模块中：<code>__builtins__</code>为内置模块<code>builtins</code></li>
<li>非<code>__main__</code>模块中：<code>__buitlins__</code>是<code>builtins</code>模块
自身的字典别名</li>
</ul>
</li>
</ul>
<h4 id="动态特性"><a href="#动态特性" class="headerlink" title="动态特性"></a>动态特性</h4><ul>
<li><p>自由变量的名称解析</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>():</span></span><br><span class="line">	<span class="built_in">print</span>(i)</span><br><span class="line">i = <span class="number">42</span></span><br><span class="line">f()</span><br><span class="line">	<span class="comment"># 打印`42`</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>发生在运行时，而不是编译时</strong></li>
<li><strong>在全局命名空间中</strong>，而不是最近包含命名空间中</li>
</ul>
</li>
</ul>
<h4 id="eval-、exec"><a href="#eval-、exec" class="headerlink" title="eval()、exec()"></a><code>eval()</code>、<code>exec()</code></h4><ul>
<li><p><code>eval()</code>、<code>exec()</code>没有对完整环境的访问权限来解析名称</p>
<ul>
<li>有可选参数用于重载全局、局部命名空间</li>
<li>若只指定一个命名空间，则会同时作用于两者</li>
</ul>
</li>
</ul>
<h4 id="类"><a href="#类" class="headerlink" title="类"></a>类</h4><ul>
<li><p>类中名称解析遵守大部分情况下同普通规则，但
<strong>未绑定局部变将在全局命名空间中搜索</strong></p>
</li>
<li><p>类定义的命名空间<code>__dict__</code>会成为类的属性字典</p>
</li>
<li><p>类代码块中定义的名称的作用域会被限制在类代码块中，不会
扩展到方法代码块中，包括推导式、生成器表达式</p>
   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">	a = <span class="number">42</span></span><br><span class="line">	b = <span class="built_in">list</span>(a + i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a><em>Exception</em></h2><p>异常：中断代码块的正常控制流程以便处理错误、其他异常条件的
方式</p>
<ul>
<li><p>在错误被检测到的位置引发</p>
<ul>
<li>解释器检测到运行时错误时错误</li>
<li><code>raise</code>语句显式引发</li>
</ul>
</li>
<li><p>可被当前包围代码块、任何直接或间接主调代码块捕获、处理</p>
<ul>
<li><code>try...except</code>指定错误处理，<code>finally</code>子句清理代码</li>
<li>异常通过实例标识、根据器类型选择执行<code>except</code>子句</li>
</ul>
</li>
<li><p>错误处理采用“终止”模型</p>
<ul>
<li>异常处理器可以找出发生的问题，在外层继续执行</li>
<li>但不能修复错误的根源，并重试失败操作</li>
<li>异常完全未被处理时，解释器会终止程序执行、或返回交互
模式循环，并打印栈回溯信息，除非为<code>SystemExit</code>异常</li>
</ul>
</li>
<li><p>异常实例可以携带关于异常状态的额外信息</p>
<blockquote>
<ul>
<li>异常信息不是python API一部分，内容可能在不同python
 版本间不经警告的改变</li>
</ul>
</blockquote>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-11T07:56:31.000Z" title="6/11/2019, 3:56:31 PM">2019-06-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-06-11T07:56:31.000Z" title="6/11/2019, 3:56:31 PM">2019-06-11</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3Ref/">Py3Ref</a></span><span class="level-item">31 minutes read (About 4695 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3Ref/simple_stmts.html">Simple Statements</a></h1><div class="content"><p>简单语句：由单个逻辑行构成</p>
<ul>
<li>多条简单语句可以在同一物理行内、并以分号分隔</li>
</ul>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">simple_stmt ::=  expression_stmt</span><br><span class="line">                 | assert_stmt</span><br><span class="line">                 | assignment_stmt</span><br><span class="line">                 | augmented_assignment_stmt</span><br><span class="line">                 | annotated_assignment_stmt</span><br><span class="line">                 | pass_stmt</span><br><span class="line">                 | del_stmt</span><br><span class="line">                 | return_stmt</span><br><span class="line">                 | yield_stmt</span><br><span class="line">                 | raise_stmt</span><br><span class="line">                 | break_stmt</span><br><span class="line">                 | continue_stmt</span><br><span class="line">                 | import_stmt</span><br><span class="line">                 | future_stmt</span><br><span class="line">                 | global_stmt</span><br><span class="line">                 | nonlocal_stmt</span><br></pre></td></tr></table></figure>
<h2 id="Expression-Statements"><a href="#Expression-Statements" class="headerlink" title="Expression Statements"></a><em>Expression Statements</em></h2><p>表达式语句：用于计算、写入值（交互模式下），或调用过程（不
返回有意义结果的函数）</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expresssion_stmt ::= starred_expression</span><br></pre></td></tr></table></figure>
<ul>
<li>用途：表达式语句对指定表达式[列表]进行求值</li>
<li>交互模式下<ul>
<li>若值不为<code>None</code>：通过内置<code>repr()</code>函数转换为字符串，
单独一行写入标准输出</li>
<li>值为<code>None</code>：不产生任何输出</li>
</ul>
</li>
</ul>
<h2 id="Assignment-Statements"><a href="#Assignment-Statements" class="headerlink" title="Assignment Statements"></a><em>Assignment Statements</em></h2><p>赋值语句：将名称[重]绑定到特定值、修改属性或可变对象成员项</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">assignment_stmt ::=  (target_list <span class="string">&quot;=&quot;</span>)+ (starred_expression | yield_expression)</span><br><span class="line">target_list     ::=  target (<span class="string">&quot;,&quot;</span> target)* [<span class="string">&quot;,&quot;</span>]</span><br><span class="line">target          ::=  identifier</span><br><span class="line">                     | &quot;(&quot; [target_list] &quot;)&quot;</span><br><span class="line">                     | &quot;[&quot; [target_list] &quot;]&quot;</span><br><span class="line">                     | attributeref</span><br><span class="line">                     | subscription</span><br><span class="line">                     | slicing</span><br><span class="line">                     | &quot;*&quot; target</span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：对指定表达式列表求值，将单一结果对象从左至右逐个
赋值给目标列表</p>
</li>
<li><p>赋值根据目标列表的格式递归定义，目标为可变对象组成部分时
（属性引用、抽取、切片），可变对象赋值有效性会被检查，
赋值操作不可接受可能引发异常</p>
</li>
<li><p>赋值顺序：将赋值看作是左、右端项重叠</p>
<ul>
<li>根据定义赋值语句内多个赋值是同时重叠，如：<code>a,b=b,a</code>
交换两变量值</li>
<li><p>但赋值语句左端项包含集合类型时，重叠从左到右依次执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = [<span class="number">0</span>,<span class="number">1</span>]</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">i, x[i] = <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">	<span class="comment"># `x`现在为`[0, 2]`</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>LOAD_XXX</code>指令将右端项<strong>从左到右依次压栈</strong></li>
<li><code>ROT_N</code>指令交换栈顶元素</li>
<li><code>STORE_XXX</code>指令将栈顶元素弹出<strong>从左到右</strong>依次给
右端项赋值</li>
</ul>
</blockquote>
<ul>
<li>以上语句中，计算表达式<code>x[i]</code>前<code>i</code>已经被赋新值</li>
</ul>
<blockquote>
<ul>
<li><code>dis.dis()</code>查看代码块指令</li>
</ul>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="赋值目标为列表"><a href="#赋值目标为列表" class="headerlink" title="赋值目标为列表"></a>赋值目标为列表</h3><p>赋值目标（左端项）为列表（可选包含在圆括号、方括号内）</p>
<ul>
<li><p>若目标列表为不带逗号、可以包含在圆括号内的单一目标，将
右端项赋值给该目标</p>
</li>
<li><p>否则：右端项须为<strong>与目标列表相同项数</strong>的可迭代对象，其中
元素将从左至右顺序被赋值给对应目标</p>
</li>
<li><p>若目标列表包含带<code>*</code>元素：则类似实参解包，其须为可迭代
对象，且右端项至少包含目标列表项数-1</p>
<ul>
<li>加星目标前元素被右端项前段元素一一赋值</li>
<li>加星目标后元素被右端项后段元素一一赋值</li>
<li>加星目标被赋予剩余目标元素<strong>构成的列表</strong></li>
</ul>
</li>
</ul>
<h3 id="赋值目标为单个目标"><a href="#赋值目标为单个目标" class="headerlink" title="赋值目标为单个目标"></a>赋值目标为单个目标</h3><h4 id="目标为标识符（名称）"><a href="#目标为标识符（名称）" class="headerlink" title="目标为标识符（名称）"></a>目标为标识符（名称）</h4><ul>
<li><p>名称未出现在当前代码块<code>global</code>、<code>nonlocal</code>语句中：名称
被绑定到/赋值为当前局部命名空间对象</p>
</li>
<li><p>否则：名称被分别绑定到/赋值为全局命名空间、或<code>nonlocal</code>
确定的外层命名空间中对象</p>
</li>
</ul>
<blockquote>
<ul>
<li>若名称已经被绑定则被重新绑定，可能导致之前被绑定名称
  对象引用计数变为0，对象进入释放过程并调用其析构器</li>
</ul>
</blockquote>
<h4 id="目标为属性引用"><a href="#目标为属性引用" class="headerlink" title="目标为属性引用"></a>目标为属性引用</h4><ul>
<li><p>引用中原型表达式被求值：应产生具有可赋值属性的对象，
否则<code>raise TypeError</code></p>
</li>
<li><p>该对象指定属性将被赋值，若无法赋值将
<code>raise AttributeError</code></p>
</li>
</ul>
<h4 id="目标为抽取项"><a href="#目标为抽取项" class="headerlink" title="目标为抽取项"></a>目标为抽取项</h4><ul>
<li><p>引用中原型表达式被求值：应产生可变序列对象（列表）、
映射对象（字典）</p>
</li>
<li><p>引用中抽取表达式被求值</p>
<ul>
<li><p>若原型表达式求值为可变序列对象</p>
<ul>
<li>抽取表达式产生整数，包含负数则取模，结果只须为
小于序列长度非负整数</li>
<li>整数指定的索引号的项将被赋值</li>
<li>若索引超出范围将<code>raise IndexError</code></li>
</ul>
</li>
<li><p>若原型表达式求值为映射对象</p>
<ul>
<li>抽取表达式须产生与该映射键类型兼容的类型</li>
<li>映射可以创建、更新抽取表达式指定键值对</li>
</ul>
</li>
</ul>
</li>
<li><p>对用户自定义对象，将调用<code>__setitem__</code>方法并附带适当参数</p>
</li>
</ul>
<h4 id="目标为切片"><a href="#目标为切片" class="headerlink" title="目标为切片"></a>目标为切片</h4><ul>
<li><p>引用中原型表达式被求值：应当产生可变序列对象</p>
<ul>
<li>右端项应当是相同类型的序列对象</li>
</ul>
</li>
<li><p>上界、下界表达式若存在将被求值</p>
<ul>
<li>其应为整数，若为负数将对原型表达式序列长度求模，最终
边界被裁剪至0、序列长度开区间中</li>
<li>默认值分别为零、序列长度</li>
</ul>
</li>
<li><p>切片被赋值为右端项</p>
<ul>
<li>若切片长度和右端项长度不同，将在目标序列允许情况下
改变目标序列长度</li>
</ul>
</li>
</ul>
<h4 id="Augmented-Assignment-Statements"><a href="#Augmented-Assignment-Statements" class="headerlink" title="Augmented Assignment Statements"></a><em>Augmented Assignment Statements</em></h4><p>增强赋值语句：在单个语句中将二元运算和赋值语句合为一体</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">augmented_assignment_stmt ::=  augtarget augop (expression_list | yield_expression)</span><br><span class="line">augtarget                 ::=  identifier | attributeref | subscription | slicing</span><br><span class="line">augop                     ::=  <span class="string">&quot;+=&quot;</span> | <span class="string">&quot;-=&quot;</span> | <span class="string">&quot;*=&quot;</span> | <span class="string">&quot;@=&quot;</span> | <span class="string">&quot;/=&quot;</span> | <span class="string">&quot;//=&quot;</span> | <span class="string">&quot;%=&quot;</span> | <span class="string">&quot;**=&quot;</span></span><br><span class="line">                               | &quot;&gt;&gt;=&quot; | &quot;<span class="attribute">&lt;&lt;=&quot; | &quot;&amp;=&quot; | &quot;^=&quot; | &quot;|=&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>增强赋值语句不能类似普通赋值语句为可迭代对象拆包</li>
</ul>
</blockquote>
<ul>
<li><p>赋值增强语句对目标和表达式列表求值</p>
<ul>
<li>依据两操作数类型指定执行二元运算</li>
<li>将结果赋给原始目标</li>
</ul>
</li>
<li><p>增强赋值语句可以被改写成类似、但非完全等价的普通赋值语句</p>
<ul>
<li>增强赋值语句中目标仅会被求值一次</li>
<li>在可能情况下，运算是原地执行的，即直接修改原对象而
不是创建新对象并赋值给原对象</li>
<li>所以增强赋值<strong>先对左端项求值</strong></li>
</ul>
</li>
<li><p>其他增强赋值语句和普通赋值语句不同点</p>
<ul>
<li>单条语句中对元组、多目标赋值赋值操作处理不同</li>
</ul>
</li>
</ul>
<h4 id="Annotated-Assignment-Statements"><a href="#Annotated-Assignment-Statements" class="headerlink" title="Annotated Assignment Statements"></a><em>Annotated Assignment Statements</em></h4><p>带标注的赋值语句：在单个语句中将变量、或属性标注同可选赋值
赋值语句合并</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">annotated_assignment_stmt ::=  augtarget <span class="string">&quot;:&quot;</span> expression [<span class="string">&quot;=&quot;</span> expression]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>与普通赋值语句区别仅在于：仅有单个目标、且仅有单个右端项
才被允许</p>
</li>
<li><p>在类、模块作用域中</p>
<ul>
<li>若赋值目标为简单名称，标注会被存入类、模块的
<code>__annotations__</code>属性中</li>
<li>若赋值目标为表达式，标注被求值但不会被保存</li>
</ul>
</li>
<li><p>在函数作用域内，标注不会被求值、保存</p>
</li>
<li><p>若存在右端项，带标注赋值在对标注值求值前执行实际赋值；
否则仅对赋值目标求值，不执行<code>__setitem__</code>、<code>__setattr__</code></p>
<blockquote>
<ul>
<li>参见<em>cs_python/py3ref/#todo</em></li>
</ul>
</blockquote>
</li>
</ul>
<h2 id="关键字语句"><a href="#关键字语句" class="headerlink" title="关键字语句"></a>关键字语句</h2><h3 id="assert"><a href="#assert" class="headerlink" title="assert"></a><code>assert</code></h3><p>assert语句：在程序中插入调试性断言的简便方式</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert_stmt ::= <span class="string">&quot;assert&quot;</span> expression [<span class="string">&quot;,&quot;</span> expression]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>assert语句等价于</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="literal">__debug__</span>:</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> expression:</span><br><span class="line">		<span class="keyword">raise</span> AssertionError</span><br><span class="line">	<span class="comment"># 等价于`assert expression`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="literal">__debug__</span>:</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> expression1:</span><br><span class="line">		<span class="keyword">raise</span> AssertionError(expression2)</span><br><span class="line">	<span class="comment"># 等价于`assert expression1, expression2`</span></span><br></pre></td></tr></table></figure>
<ul>
<li>无需再错误信息中包含失败表达式源码，其会被作为栈追踪
一部分被显示</li>
</ul>
</li>
<li><p>假定<code>__debug__</code>、<code>AssertionError</code>指向具有特定名称的内置
变量，当前实现中</p>
<ul>
<li>对<code>__debug__</code>赋值是非法的，其值在解释器启动时确定</li>
<li>默认内置变量<code>__debug__=True</code></li>
<li>请求优化时<code>__debug__</code>置为<code>False</code><ul>
<li><code>-0</code>命令行参数开启</li>
<li>若编译时请求优化，代码生成器不会为assert语句生成
代码</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="pass"><a href="#pass" class="headerlink" title="pass"></a><code>pass</code></h3><p>pass语句：空操作，被执行时无事情发生</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pass_stmt ::= <span class="string">&quot;pass&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>适合语法上需要语句、但不需要执行代码时临时占位</li>
</ul>
<h3 id="del"><a href="#del" class="headerlink" title="del"></a><code>del</code></h3><p>del语句：从局部、全局命名空间中移除名称的绑定，若名称未绑定
将<code>raise NameError</code></p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del_stmt ::= <span class="string">&quot;del&quot;</span> target_list</span><br></pre></td></tr></table></figure>
<ul>
<li><p>删除是递归定义的</p>
<ul>
<li>类似赋值的定义方式</li>
<li>从左至右递归的删除目标列表中每个目标</li>
</ul>
</li>
<li><p>属性、抽取、切片的删除会被传递给相应原型对象</p>
<ul>
<li>删除切片基本等价于赋值为目标类型的空切片？？？</li>
</ul>
</li>
</ul>
<h3 id="return"><a href="#return" class="headerlink" title="return"></a><code>return</code></h3><p>return语句：离开当前函数调用，返回列表表达式值、<code>None</code></p>
<ul>
<li><p>在生成器函数中，return语句表示生成器已完成</p>
<ul>
<li>并<code>raise StopIteration</code></li>
<li>返回值作为参数构建<code>StopIteration</code>，并作为
<code>StopIteration.value</code>属性</li>
</ul>
</li>
<li><p>异步生成器函数中，return语句表示异步生成器已完成</p>
<ul>
<li>并<code>raise StopAsyncIteration</code></li>
<li>非空<code>return</code>返回值在将导致语法错误</li>
</ul>
</li>
</ul>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return_stmt ::= <span class="string">&quot;return&quot;</span> [expression_list]</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>return</code>语法上只会出现于函数定义代码块中，不会出现于
类定义所嵌套代码中</p>
</li>
<li><p>若提供表达式列表，其将被求值；否则缺省为<code>None</code></p>
</li>
<li><p><code>return</code>将控制流传出带有<code>finally</code>子句的<code>try</code>语句时，
<code>finally</code>子句会先被执行然后真正离开函数</p>
</li>
</ul>
<h3 id="yield"><a href="#yield" class="headerlink" title="yield"></a><code>yield</code></h3><p>yield语句：语义上等于yield表达式</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yield_stmt ::= yield_expression</span><br></pre></td></tr></table></figure>
<ul>
<li><p>可用于省略在使用等效yield表达式必须的圆括号</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">yield</span> &lt;expr&gt;</span><br><span class="line"><span class="keyword">yield</span> <span class="keyword">from</span> &lt;expr&gt;</span><br><span class="line">	<span class="comment"># 以上yield语句、以下yield表达式等价</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">yield</span> &lt;expr&gt;)</span><br><span class="line">(<span class="keyword">yield</span> <span class="keyword">from</span> &lt;expr&gt;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>yeild表达式、语句仅在定义[异步]生成器函数时使用，且仅
用于函数体内部，且函数体包含<code>yield</code>就使得该定义创建
生成器函数而非普通函数</p>
</li>
</ul>
<blockquote>
<ul>
<li>yield表达式参见<em>cs_python/py3ref/#todo</em></li>
</ul>
</blockquote>
<h3 id="raise"><a href="#raise" class="headerlink" title="raise"></a><code>raise</code></h3><p>raise语句：引发异常</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">raise_stmt ::= <span class="string">&quot;raise&quot;</span> [expression [<span class="string">&quot;from&quot;</span> expression]]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>若不带表达式：<code>raise</code>将重新引发当前作用域最后一个激活
异常</p>
<ul>
<li>若当前作用域内没有激活异常，将引发<code>RuntimeError</code>
提示错误</li>
</ul>
</li>
<li><p>否则计算表达式作为异常对象</p>
<ul>
<li>异常对象须为<code>BaseException</code>子类、实例</li>
<li>若其为类，则通过不带参数的实例化该类作为异常实例</li>
</ul>
</li>
<li><p>异常被引发时会自动创建回溯对象，并被关联至可写
<code>__traceback__</code>属性</p>
<ul>
<li><p>可以创建异常时同时使用<code>.with_traceback()</code>异常方法
自定义回溯对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">raise</span> Exception(<span class="string">&quot;foo occured&quot;</span>).with_traceback(tbobj)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="异常串联"><a href="#异常串联" class="headerlink" title="异常串联"></a>异常串联</h4><ul>
<li><p><code>from</code>子句用于异常串联：其后表达式求值需要为另一个异常</p>
<ul>
<li>其将作为可写<code>__cause__</code>属性被关联到引发的第一个异常</li>
<li>若引发异常未被处理，两个异常都将被打印</li>
</ul>
</li>
<li><p>若异常在try语句中<code>finally</code>子句、其他子句后、先中引发，
类似机制发挥作用，之前异常被关联到新异常的<code>__context__</code>
属性</p>
</li>
</ul>
<blockquote>
<ul>
<li>异常串联可以通过在<code>from</code>子句中指定<code>None</code>显式抑制</li>
</ul>
</blockquote>
<h3 id="break"><a href="#break" class="headerlink" title="break"></a><code>break</code></h3><p>break语句：终结最近外层循环、<strong>循环的可选<code>else</code>子句</strong></p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">break_stmt ::= <span class="string">&quot;break&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>break</code>在语法上只出现在<code>for</code>、<code>while</code>所嵌套代码</p>
<ul>
<li>不包括循环内函数定义、类定义所嵌套代码</li>
</ul>
</li>
<li><p>若<code>for</code>循环被<code>break</code>终结，循环控制目标保持当前值</p>
</li>
<li><p>当<code>break</code>将控制流传出带有<code>finally</code>子句的<code>try</code>语句时，
<code>finally</code>子句会先被执行，然后真正离开循环</p>
</li>
</ul>
<h3 id="continue"><a href="#continue" class="headerlink" title="continue"></a><code>continue</code></h3><p>continue语句：继续执行最近外层循环的下一伦茨</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">continue_stmt ::= <span class="string">&quot;continue&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>continue</code>在语法上只出现在<code>for</code>、<code>while</code>所嵌套代码</p>
<ul>
<li>不包括循环内函数定义、类定义、<code>finally</code>子句所嵌套
代码</li>
</ul>
</li>
<li><p>当<code>continue</code>将控制流传出带有<code>finally</code>子句的<code>try</code>语句时，
<code>finally</code>子句会先被执行，然后真正开始循环下一个轮次</p>
</li>
</ul>
<h3 id="import"><a href="#import" class="headerlink" title="import"></a><code>import</code></h3><p>import语句</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import_stmt     ::=  <span class="string">&quot;import&quot;</span> module [<span class="string">&quot;as&quot;</span> identifier] (<span class="string">&quot;,&quot;</span> module [<span class="string">&quot;as&quot;</span> identifier])*</span><br><span class="line">                     | &quot;from&quot; relative_module &quot;import&quot; identifier [&quot;as&quot; identifier]</span><br><span class="line">                     (&quot;,&quot; identifier [&quot;as&quot; identifier])*</span><br><span class="line">                     | &quot;from&quot; relative_module &quot;import&quot; &quot;(&quot; identifier [&quot;as&quot; identifier]</span><br><span class="line">                     (&quot;,&quot; identifier [&quot;as&quot; identifier])* [&quot;,&quot;] &quot;)&quot;</span><br><span class="line">                     | &quot;from&quot; module &quot;import&quot; &quot;*&quot;</span><br><span class="line">module          ::=  (identifier <span class="string">&quot;.&quot;</span>)* identifier</span><br><span class="line">relative_module ::=  <span class="string">&quot;.&quot;</span>* module | <span class="string">&quot;.&quot;</span>+</span><br></pre></td></tr></table></figure>
<ul>
<li><p>基本<code>import</code>子句执行步骤</p>
<ul>
<li>查找模块，若有必要加载并初始化模块</li>
<li>为<code>import</code>所处作用域的局部命名空间定义名称</li>
</ul>
<blockquote>
<ul>
<li>语句包含多个子句（逗号分隔）时，以上两个步骤将分别
 对每个子句执行，如同子句被分成独立<code>import</code>语句</li>
</ul>
</blockquote>
</li>
<li><p>默认情况下，导入的父模块中命名空间中不包含子模块属性，
即导入父模块<strong>不能直接通过属性<code>.</code>引用子模块</strong></p>
<ul>
<li>有些包会在父模块中导入子模块，则初始化模块时父模块
中即有子模块属性</li>
<li>在当前模块手动导入子模块，子模块绑定至父模块命名空间
中同名属性</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>导入机制参见<em>cs_python/py3ref/import_system</em></li>
</ul>
</blockquote>
<h4 id="绑定"><a href="#绑定" class="headerlink" title="绑定"></a>绑定</h4><ul>
<li><p>若模块名称后带有<code>as</code>，则在<code>as</code>之后名称将直接绑定到所导入
模块</p>
</li>
<li><p>若没有指定其他名称、且被导入模块为最高层级模块，则模块
名称被绑定到局部命名空间作为对所导入模块的引用</p>
</li>
<li><p>若被导入模块不是最高级模块，则包含该模块的最高层级包名将
被绑定到局部命名空间作为的该最高层级包的引用，所导入模块
必须使用完整限定名称访问而不能直接访问</p>
</li>
</ul>
<h4 id="from子句"><a href="#from子句" class="headerlink" title="from子句"></a><code>from</code>子句</h4><ul>
<li><p>查找<code>from</code>子句中指定模块，若有必要则加载并初始化模块</p>
</li>
<li><p>对<code>import</code>子句中指定的每个标识符</p>
<ul>
<li>检查被导入模块是否有<strong>该名称属性</strong></li>
<li>若没有，尝试导入具有该名称子模块，然后再次检查
<strong>被导入（上级）模块</strong>是否具有该属性</li>
<li>若未找到该属性，则<code>raise ImportError</code></li>
<li>否则将对该值引用存入局部命名空间，若有<code>as</code>子句则
使用其指定名称，否则使用该属性名称</li>
</ul>
</li>
</ul>
<h5 id="通配符"><a href="#通配符" class="headerlink" title="*通配符"></a><code>*</code>通配符</h5><p>标识符列表为通配符<code>*</code>形式：模块中定义的全部公有名称都被绑定
至<code>import</code>语句作用域对应局部命名空间</p>
<ul>
<li><p>模块命名空间中<code>__all__</code>属性：字符串列表，指定模块
<strong>定义的公有名称</strong></p>
<ul>
<li>其中字符串项为模块中定义、导入的名称</li>
<li>其中中所给出的名称被视为公有、应当存在</li>
<li>应该包含所有公有API、避免意外导出不属于API部分项</li>
</ul>
</li>
<li><p>若<code>__all__</code>属性未定义：则公有名称集合将包括在模块
命名空间中找到的、所有不以<code>_</code>开头名称</p>
</li>
</ul>
<blockquote>
<ul>
<li>通配符模式仅在模块层级允许使用，在类、函数中使用将
  <code>raise SyntaxError</code></li>
</ul>
</blockquote>
<h5 id="相对导入"><a href="#相对导入" class="headerlink" title="相对导入"></a>相对导入</h5><p>相对导入：指定导入模块时，无需指定模块绝对名称</p>
<ul>
<li><p>需要导入的模块、包被包含在同一包中时，可在相同顶级包中
进行相对导入，无需指明包名称</p>
</li>
<li><p>在<code>from</code>子句中指定的模块、包中使用前缀点号指明需要上溯
包层级数</p>
<ul>
<li>一个前缀点号：执行导入的模块在当前包</li>
<li>两个前缀点号：上溯一个包层级</li>
<li><p>三个前缀点号：上溯两个包层级，依此类推</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">form ...sub_sub_pkg import mod1</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>相对导入可以避免模块之间产生冲突，适合导入相关性强代码</p>
<ul>
<li>脚本模式（在命令行中执行<code>.py</code>文件）不支持相对导入</li>
<li>要跨越多个文件层级导入，只需要使用多个<code>.</code>，但
<em>PEP 328</em>建议，相对导入层级不要超过两层</li>
</ul>
</li>
</ul>
<h4 id="future语句"><a href="#future语句" class="headerlink" title="future语句"></a><em>future</em>语句</h4><p>future语句：指明莫格特定模块使用在特定、未来某个python发行版
中成为标准特性的语法、语义</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">future_stmt ::=  <span class="string">&quot;from&quot;</span> <span class="string">&quot;__future__&quot;</span> <span class="string">&quot;import&quot;</span> feature [<span class="string">&quot;as&quot;</span> identifier]</span><br><span class="line">                 (&quot;,&quot; feature [&quot;as&quot; identifier])*</span><br><span class="line">                 | &quot;from&quot; &quot;__future__&quot; &quot;import&quot; &quot;(&quot; feature [&quot;as&quot; identifier]</span><br><span class="line">                 (&quot;,&quot; feature [&quot;as&quot; identifier])* [&quot;,&quot;] &quot;)&quot;</span><br><span class="line">feature     ::=  identifier</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>import __future__ [as name]</code>：不是future语句，只是没有
  特殊语义、语法限制的普通import语句</li>
</ul>
</blockquote>
<ul>
<li><p>用途</p>
<ul>
<li>允许模块在包含新特性发行版前使用该特性</li>
<li>目的是使得在迁移至引入不兼容改变的python未来版本
更容易</li>
</ul>
</li>
<li><p>future语句是针对编译器的指令</p>
<ul>
<li><p>在编译时被识别并做特殊对待</p>
<ul>
<li>改变核心构造语义常通过生成不同代码实现</li>
<li>新特性可能会引入不兼容语法，如：新关键字，编译器
可能需要以不同方式解析模块</li>
</ul>
</li>
<li><p>编译器需要知道哪些特性名称已经定义</p>
<ul>
<li>包含未知特性的future语句将引发编译时错误</li>
</ul>
</li>
<li><p>直接运行时语义同其他import语句</p>
<ul>
<li>相应运行时语义取决于future语句启用的指定特性</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>在包含future语句的环境中，通过<code>exec()</code>、<code>compile()</code>
 调用代码<strong>会使用future语句关联的语法、语义</strong>，此行为
 可以通过<code>compile()</code>可选参数加以控制</li>
</ul>
</blockquote>
</li>
<li><p>future语句必须在靠近模块开头位置处出现，可以出现在future
语句前的行</p>
<ul>
<li>模块文档字符串</li>
<li>注释</li>
<li>空行</li>
<li>其他future语句</li>
</ul>
</li>
</ul>
<h3 id="global"><a href="#global" class="headerlink" title="global"></a><code>global</code></h3><p>global语句：声明所列出标识符将被解读为全局变量</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">global_stmt ::= <span class="string">&quot;global&quot;</span> identifier (<span class="string">&quot;,&quot;</span> identifier)*</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>global</code>语句是作用于整个当前代码块的声明</p>
</li>
<li><p>局部作用域中给全局变量<strong>赋值</strong>必须用到<code>global</code>关键字</p>
<ul>
<li>仅仅是获取值无需<code>global</code>语句声明</li>
<li>但自由变量也可以指向全局变量而不必声明为全局变量</li>
</ul>
</li>
<li><p>global语句中列出的名称</p>
<ul>
<li>不能被定义为形参名</li>
<li>不能作为<code>for</code>循环控制目标</li>
<li>不能出现在类定义、函数定义、<code>import</code>语句、变量标注中</li>
</ul>
<blockquote>
<ul>
<li>CPython：暂时未强制要求上述限制，未来可能更改</li>
</ul>
</blockquote>
</li>
<li><p><code>global</code>是对<strong>解释器的指令</strong>，仅对与global语句同时被解析
的代码起作用</p>
<ul>
<li>包含在作为<code>exec()</code>参数的字符串、代码对象中global
语句不会影响<code>exec()</code>所在代码块</li>
<li>反之<code>exec()</code>中代码也不会被调用其代码块影响</li>
</ul>
<blockquote>
<ul>
<li><code>eval()</code>、<code>compile()</code>等函数同</li>
</ul>
</blockquote>
</li>
</ul>
<h3 id="nonlocal"><a href="#nonlocal" class="headerlink" title="nonlocal"></a><code>nonlocal</code></h3><p>nonlocal语句：使得列出的名称指向<strong>之前最近的包含作用域中</strong>
绑定的、除全局变量外的变量</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nonlocal_stmt ::= <span class="string">&quot;nonlocal&quot;</span> indentifier (<span class="string">&quot;,&quot;</span> identifier)*</span><br></pre></td></tr></table></figure>
<ul>
<li><p>nonlocal语句允许被封装代码重新绑定局部作用域以外、且非
全局（模块）作用域当中变量</p>
<ul>
<li><p>即nonlocal语句中列出名称，必须指向<strong>之前存在</strong>于
包含作用域中的绑定</p>
</li>
<li><p>nonlocal语句中列出名称不能与之前存在的局部作用域中
绑定冲突</p>
</li>
</ul>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-09T17:42:37.000Z" title="6/10/2019, 1:42:37 AM">2019-06-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-02T06:47:45.000Z" title="8/2/2021, 2:47:45 PM">2021-08-02</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3std/">Py3std</a></span><span class="level-item">12 minutes read (About 1748 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3std/runtime_service.html">Python 运行时服务</a></h1><div class="content"><h2 id="sys"><a href="#sys" class="headerlink" title="sys"></a><code>sys</code></h2><p><code>sys</code>：与Python解释器<strong>本身相关</strong>的组件</p>
<h3 id="平台、版本"><a href="#平台、版本" class="headerlink" title="平台、版本"></a>平台、版本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.platform</span><br><span class="line">	<span class="comment"># 操作系统名称</span></span><br><span class="line">sys.maxsize</span><br><span class="line">	<span class="comment"># 当前计算机最大容纳“原生”整型</span></span><br><span class="line">	<span class="comment"># 一般就是字长</span></span><br><span class="line">sys.version</span><br><span class="line">	<span class="comment"># python解释器版本号</span></span><br><span class="line">sys.byteorder</span><br><span class="line">	<span class="comment"># 平台字节序</span></span><br><span class="line">sys.hash_info</span><br><span class="line">	<span class="comment"># 数值类型hash信息</span></span><br></pre></td></tr></table></figure>
<h4 id="sys-xxxcheckinterval"><a href="#sys-xxxcheckinterval" class="headerlink" title="sys.xxxcheckinterval"></a><code>sys.xxxcheckinterval</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sys.getcheckinterval()</span><br><span class="line">	<span class="comment"># 查看解释器检查线程切换、信号处理器等的频率</span></span><br><span class="line">sys.setcheckinterval(N)</span><br><span class="line">	<span class="comment"># 设置解释器检查线程切换、信号处理器等的频率</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>参数</p>
<ul>
<li><code>N</code>：线程切换前执行指令的数量</li>
</ul>
</li>
<li><p>对大多数程序无需更改此设置，但是可以用于调试线程性能</p>
<ul>
<li>较大值表示切换频率较低，切换线程开销降低，但是对事件
的应答能力变弱</li>
<li>较小值表示切换频率较高，切换线程开销增加，对事件应答
能力提升</li>
</ul>
</li>
</ul>
<h4 id="sys-hash-info"><a href="#sys-hash-info" class="headerlink" title="sys.hash_info"></a><code>sys.hash_info</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sys.hash_info.width</span><br><span class="line">	<span class="comment"># `hash()`函数截取hash值长度</span></span><br></pre></td></tr></table></figure>
<h3 id="模块搜索路径"><a href="#模块搜索路径" class="headerlink" title="模块搜索路径"></a>模块搜索路径</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.path</span><br></pre></td></tr></table></figure>
<ul>
<li>返回值：目录名称字符串组成的列表<ul>
<li>每个目录名称代表<strong>正在运行</strong>python解释器的运行时模块
搜索路径</li>
<li>可以类似普通列表在运行时被修改、生效</li>
</ul>
</li>
</ul>
<h4 id="sys-path初始化顺序"><a href="#sys-path初始化顺序" class="headerlink" title="sys.path初始化顺序"></a><code>sys.path</code>初始化顺序</h4><ul>
<li><p>脚本主目录指示器：空字符串</p>
<ul>
<li>脚本主目录是指脚本<strong>所在目录</strong>，不是<code>os.getcwd()</code>
获取的当前工作目录</li>
</ul>
</li>
<li><p><code>PYTHONPATH</code>环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> .bashrc</span></span><br><span class="line">export PYTHONPATH=$PYTHONPATH:/path/to/fold/contains/module</span><br></pre></td></tr></table></figure>
</li>
<li><p>标准库目录</p>
</li>
<li><p><code>.pth</code>路径文件：在扫描以上目录过程中，遇到<code>.pth</code>文件会
将其中路径加入<code>sys.path</code>中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># extras.pth</span><br><span class="line">/path/to/fold/contains/module</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="导入模块顺序"><a href="#导入模块顺序" class="headerlink" title="导入模块顺序"></a>导入模块顺序</h4><p>导入模块时，python解释器</p>
<ol>
<li>搜索<strong>内置</strong>模块，即内置模块优先级最高</li>
<li>从左至右扫描<code>sys.path</code>列表，在列表目录下搜索模块文件</li>
</ol>
<h3 id="嵌入解释器的钩子"><a href="#嵌入解释器的钩子" class="headerlink" title="嵌入解释器的钩子"></a>嵌入解释器的钩子</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sys.modules</span><br><span class="line">	<span class="comment"># 已加载模块字典</span></span><br><span class="line">sys.builtin_module_names</span><br><span class="line">	<span class="comment"># 可执行程序的内置模块</span></span><br><span class="line">sys.getrefcount()</span><br><span class="line">	<span class="comment"># 查看对象引用次数</span></span><br></pre></td></tr></table></figure>
<h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.exc_info()</span><br></pre></td></tr></table></figure>
<ul>
<li>返回值：<code>(type, value, trackback)</code><ul>
<li>最近异常的类型、值、追踪对象元组</li>
<li>处理该异常的<code>except</code>执行之后，<code>sys.exc_info</code>被恢复
为原始值</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>追踪对象可以使用<code>traceback</code>模块处理</li>
</ul>
</blockquote>
<h3 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.argv</span><br></pre></td></tr></table></figure>
<ul>
<li>返回值：命令行参数列表<ul>
<li>首项始终为执行脚本名称，交互式python时为空字符串</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>参数可以自行解析，也可以使用以下标准库中模块<blockquote>
<ul>
<li><code>getopt</code>：类似Unix/C同名工具</li>
<li><code>optparse</code>：功能更加强大</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<h3 id="标准流"><a href="#标准流" class="headerlink" title="标准流"></a>标准流</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sys.stdin</span><br><span class="line">	<span class="comment"># 标准输入流</span></span><br><span class="line">sys.stdout</span><br><span class="line">	<span class="comment"># 标准输出流</span></span><br><span class="line">sys.stderr</span><br><span class="line">	<span class="comment"># 标准错误流</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>标准流是<strong>预先打开的python文件对象</strong></p>
<ul>
<li>在python启动时自动链接到程序上、绑定至终端</li>
<li>shell会将相应流链接到指定数据源：用户标准输入、文件</li>
</ul>
</li>
</ul>
<h4 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h4><ul>
<li><p>可以将<code>sys.stdin</code>、<code>sys.stdout</code>重置到文件类的对象，实现
python<strong>内部的</strong>、<strong>普遍的</strong>重定向方式</p>
<ul>
<li>外部：cmd输入输出重定向</li>
<li>局部：指定<code>print</code>参数</li>
</ul>
</li>
<li><p>任何方法上与文件类似的对象都可以充当标准流，与对象类型
无关，只取决于接口</p>
<ul>
<li><p>任何提供了类似文件<code>read</code>方法的对象可以指定给
<code>sys.stdin</code>，以从该对象<code>read</code>读取输入</p>
</li>
<li><p>任何提供了类似文件<code>write</code>方法的对象可以指定给
<code>sys.write</code>，将所有标准输出发送至该对象方法上</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>标准库<code>io</code>提供可以用于重定向的类<code>StringIO</code>、<code>ByteIO</code></li>
<li>重定向之后<code>print</code>、<code>input</code>方法将应用在重定向之后的流</li>
</ul>
</blockquote>
<h4 id="stdin"><a href="#stdin" class="headerlink" title="stdin"></a><code>stdin</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stdin.read()</span><br><span class="line">	<span class="comment"># 从标准输入流引用对象读取数据</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;input a word&quot;</span>)</span><br><span class="line">sys.stdin.readlines()[-<span class="number">1</span>]</span><br><span class="line">	<span class="comment"># 以上两行语句类似</span></span><br><span class="line"></span><br><span class="line">stdin.isatty()</span><br><span class="line">	<span class="comment"># 判断stdin是否连接到终端（是否被重定向）</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在stdin被重定向时，若需要接受用户终端输入，需要使用
特殊接口从键盘直接读取用户输入<ul>
<li>win：<code>msvcrt</code>模块</li>
<li>linux：读取<code>/dev/tty</code>设备文件</li>
</ul>
</li>
</ul>
<h3 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.exit(N)</span><br></pre></td></tr></table></figure>
<ul>
<li>用途：当前<strong>线程</strong>以状态N退出<ul>
<li>实际上只是抛出一个内建的<code>SystemExit</code>异常，可以被正常
捕获</li>
<li>等价于显式<code>raise SystemExit</code></li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>进程退出参见<code>os._exit()</code></li>
</ul>
</blockquote>
<h4 id="sys-exitfuncs"><a href="#sys-exitfuncs" class="headerlink" title="sys.exitfuncs"></a><code>sys.exitfuncs</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.exitfuncs</span><br></pre></td></tr></table></figure>
<h3 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sys.getdefaulencoding()</span><br><span class="line">	<span class="comment"># 文件内容编码，平台默认值</span></span><br><span class="line">	<span class="comment"># 默认输入解码、输出编码方案</span></span><br><span class="line">sys.getfilesystemencoding()</span><br><span class="line">	<span class="comment"># 文件名编码，平台默认体系</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>win10中二者都是<code>utf-8</code>，win7中文件名编码是<code>mbcs</code></li>
</ul>
</blockquote>
<h2 id="sysconfig"><a href="#sysconfig" class="headerlink" title="sysconfig"></a><code>sysconfig</code></h2><h2 id="builtins"><a href="#builtins" class="headerlink" title="builtins"></a><code>builtins</code></h2><h2 id="main"><a href="#main" class="headerlink" title="__main__"></a><code>__main__</code></h2><h2 id="warnings"><a href="#warnings" class="headerlink" title="warnings"></a><code>warnings</code></h2><h2 id="dataclass"><a href="#dataclass" class="headerlink" title="dataclass"></a><code>dataclass</code></h2><h2 id="atexit"><a href="#atexit" class="headerlink" title="atexit"></a><code>atexit</code></h2><p><code>atexit</code>：主要用于在<strong>程序结束前</strong>执行代码</p>
<ul>
<li>类似于析构，主要做资源清理工作</li>
</ul>
<h3 id="atexit-register"><a href="#atexit-register" class="headerlink" title="atexit.register"></a><code>atexit.register</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">	func,</span></span></span><br><span class="line"><span class="params"><span class="function">	*arg,</span></span></span><br><span class="line"><span class="params"><span class="function">	**kwargs</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用途：注册回调函数<ul>
<li>在程序退出之前，按照注册顺序反向调用已注册回调函数</li>
<li>如果程序非正常crash、通过<code>os._exit()</code>退出，注册回调
函数不会被调用</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> atexit</span><br><span class="line"></span><br><span class="line">df func1():</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;atexit func 1, last out&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func2</span>(<span class="params">name, age</span>):</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;atexit func 2&quot;</span>)</span><br><span class="line"></span><br><span class="line">atexit.register(func1)</span><br><span class="line">atexit.register(func2, <span class="string">&quot;john&quot;</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@atexit.register</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func3</span>():</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;atexit func 3, first out&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p><code>atexit</code>内部是通过<code>sys.exitfunc</code>实现的</p>
<ul>
<li><p>将注册函数放到列表中，当程序退出时按照<strong>先进后出</strong>方式
调用注册的回调函数，</p>
</li>
<li><p>若回调函数执行过程中抛出异常，<code>atexit</code>捕获异常然后继续
执行之后回调函数，知道所有回调函数执行完毕再抛出异常</p>
</li>
<li><p>二者同时使用，通过<code>atexit.register</code>注册回调函数可能不会
被正常调用</p>
</li>
</ul>
<h2 id="traceback"><a href="#traceback" class="headerlink" title="traceback"></a><code>traceback</code></h2><h3 id="traceback-print-tb"><a href="#traceback-print-tb" class="headerlink" title="traceback.print_tb"></a><code>traceback.print_tb</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> traceback, sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	...</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">	exc_info = sys.exec_info()</span><br><span class="line">	<span class="built_in">print</span>(exec_info[<span class="number">0</span>], exec_info[<span class="number">1</span>])</span><br><span class="line">	traceback.print_tb(exec_info[<span class="number">2</span>])</span><br></pre></td></tr></table></figure>
<h2 id="future"><a href="#future" class="headerlink" title="__future__"></a><code>__future__</code></h2><h2 id="gc"><a href="#gc" class="headerlink" title="gc"></a><code>gc</code></h2><h2 id="inspect"><a href="#inspect" class="headerlink" title="inspect"></a><code>inspect</code></h2><h2 id="site"><a href="#site" class="headerlink" title="site"></a><code>site</code></h2><h2 id="abc"><a href="#abc" class="headerlink" title="abc"></a><code>abc</code></h2><h3 id="ABCMeta"><a href="#ABCMeta" class="headerlink" title="ABCMeta"></a><code>ABCMeta</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IStream</span>(<span class="params">metaclass=ABCMeta</span>):</span></span><br><span class="line"><span class="meta">	@abstractmethod</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">self, maxbytes=-<span class="number">1</span></span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">	@abstractmethod</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">self, data</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SocketStream</span>(<span class="params">IStream</span>):</span></span><br><span class="line">	<span class="comment"># 抽象类目的就是让别的类继承并实现特定抽象方法</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">self, maxbytes=-<span class="number">1</span></span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">self, data</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serialize</span>(<span class="params">obj, stream</span>):</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(stream, IStream):</span><br><span class="line">		<span class="comment"># 抽象基类的主要用途之一：检查某些类是否为特定类型、</span></span><br><span class="line">			<span class="comment"># 实现特定接口</span></span><br><span class="line">		<span class="keyword">raise</span> TypeError(<span class="string">&quot;expect an IStream&quot;</span>)</span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>(<span class="params">metaclass=ABCMeta</span>):</span></span><br><span class="line"><span class="meta">	@property</span></span><br><span class="line"><span class="meta">	@abstract</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">name</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">	@name.setter</span></span><br><span class="line"><span class="meta">	@abstractmethod</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">name</span>(<span class="params">self, value</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">	@classmethod</span></span><br><span class="line"><span class="meta">	@abstractmethod</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">method1</span>(<span class="params">cls</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">	@staticmethod</span></span><br><span class="line"><span class="meta">	@abstractmethod</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">method2</span>():</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># `@abstract`还能注解静态方法、类方法、`@property`</span></span><br><span class="line">	<span class="comment"># 但是需要保证这个方法**紧靠**函数定义</span></span><br></pre></td></tr></table></figure>
<h3 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h3><p>标准库中有很多用到抽象基类的地方</p>
<ul>
<li><p><code>collections</code>模块定义了很多和容器、迭代器（序列、映射、
集合）有关的抽象基类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> collections <span class="keyword">as</span> clt</span><br><span class="line"></span><br><span class="line">clt.<span class="type">Sequence</span></span><br><span class="line">clt.Iterable</span><br><span class="line">clt.Sized</span><br><span class="line">clt.Mapping</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>numbers</code>库定义了跟数据对象：整数、浮点数、有理数有关的
基类</p>
</li>
<li><p><code>IO</code>库定义了很多跟IO操作相关的基类</p>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-09T17:36:53.000Z" title="6/10/2019, 1:36:53 AM">2019-06-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-02T03:46:05.000Z" title="8/2/2021, 11:46:05 AM">2021-08-02</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3Ref/">Py3Ref</a></span><span class="level-item">29 minutes read (About 4308 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3Ref/dm_gfuncs.html">数据模型--函数决定对象</a></h1><div class="content"><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="用户定义函数"><a href="#用户定义函数" class="headerlink" title="用户定义函数"></a>用户定义函数</h3><p>用户定义函数：通过函数定义创建，调用时附带参数列表</p>
<ul>
<li>函数对象支持获取、设置任意属性<ul>
<li>用于给函数附加元数据</li>
<li>使用属性点号<code>.</code>获取、设置此类属性</li>
</ul>
</li>
</ul>
<h4 id="特殊属性"><a href="#特殊属性" class="headerlink" title="特殊属性"></a>特殊属性</h4><ul>
<li><code>__defaults__</code>：有默认值参数的默认值组成元组<ul>
<li>没有具有默认值参数则为<code>None</code></li>
</ul>
</li>
<li><code>__code__</code>：<strong>编译后</strong>函数体代码对象</li>
<li><code>__globals__</code>：存放函数中全局变量的字典的引用<ul>
<li>即引用函数所属模块的全局命名空间</li>
<li>只读</li>
</ul>
</li>
<li><code>__closure__</code>：包含函数<strong>自由变量</strong>绑定单元的元组<ul>
<li>没有则为<code>None</code></li>
<li>只读</li>
</ul>
</li>
<li><code>__annotations__</code>：包含参数注释的字典<ul>
<li>字典键为参数名、<code>return</code>（若包含返回值）</li>
<li>将变量名称（非私有）映射到标注值的特殊字典</li>
<li>若该属性可写、在类或模块体开始执行时，若静态地发现
标注则被自动创建</li>
</ul>
</li>
<li><code>__kwdefaults__</code>：<code>keyword-only</code>参数的默认值字典</li>
</ul>
<blockquote>
<ul>
<li>大部分可写属性会检查赋值类型</li>
<li>自由变量：上层命名空间中变量，不包括顶级命名空间，即
  全局变量不是自由变量</li>
</ul>
</blockquote>
<h3 id="实例-绑定方法"><a href="#实例-绑定方法" class="headerlink" title="实例/绑定方法"></a>实例/绑定方法</h3><p>实例/绑定方法：使用<strong>属性表示法调用</strong>、<strong>定义在类命名空间</strong>
中的函数</p>
<ul>
<li><p>实例方法用于将类、类实例同可调用对象结合起来</p>
<ul>
<li>可调用对象：<strong>须为类属性，即定义在类命名空间中</strong>，
通常为用户定义函数、类方法对象</li>
</ul>
</li>
<li><p>通过实例访问类命名空间定义函数时<strong>创建</strong>实例/绑定方法</p>
<ul>
<li>通过示例、类访问的命名空间定义函数类型不同<ul>
<li><code>wrapper_descriptor</code>转换为<code>method-wrapper</code></li>
<li><code>function</code>转换为<code>method</code></li>
<li>通过类访问方法，得到是普通函数</li>
</ul>
</li>
<li>绑定：此时会将<code>self</code>作为<strong>首个参数</strong>添加到参数列表</li>
<li>调用实例方法时，调用相应下层函数</li>
</ul>
</li>
<li><p>函数对象到实例方法对象的转换每次获取实例该属性时都会发生</p>
<ul>
<li>有时可将属性赋值给本地变量、调用实现性能优化</li>
<li>非用户定义函数、不可调用对象在被获取时不会发生转换</li>
<li>实例属性的用户定义函数不会被转换为绑定方法，仅在函数
是类的属性时才会发生</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>Py3中以上特性依赖于<code>___getattribute__</code>实现</li>
</ul>
</blockquote>
<h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><ul>
<li><p>绑定方法对象支持只读获取底层函数对象任意属性</p>
<ul>
<li>但方法属性实际保存在下层函数对象中</li>
<li>所以不能直接设置绑定方法的方法属性，必须在下层函数
对象中显式设置，否则<code>raise AttributeError</code></li>
</ul>
</li>
<li><p>绑定方法有两个特殊只读属性</p>
<ul>
<li><code>m.__self__</code>：操作该方法的类实例</li>
<li><code>m.__func__</code>：底层实现该方法的函数</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li><code>m(args,...)</code>完全等价于<code>m.__func__(m.__self__,args,...)</code></li>
</ul>
</blockquote>
<h4 id="特殊元属性"><a href="#特殊元属性" class="headerlink" title="特殊元属性"></a>特殊元属性</h4><ul>
<li><code>__self__</code>：类对象实例</li>
<li><code>__func__</code>：函数对象实例</li>
<li><code>__doc__</code>：方法文档，等同于<code>__func__.__doc__</code></li>
<li><code>__name__</code>：方法名，等同于<code>__func__.__name__</code></li>
<li><code>__module__</code>：定义方法所在模块名</li>
</ul>
<h3 id="Class-Method-Objects"><a href="#Class-Method-Objects" class="headerlink" title="Class Method Objects"></a><em>Class Method Objects</em></h3><p>类方法：提供了<strong>始终将类绑定为函数对象首个参数</strong>的方式</p>
<ul>
<li>对其他对象的封装，通常用于封装用户定义方法对象</li>
<li>会改变从类、类实例获取该对象的方式</li>
<li>用途<ul>
<li>实现自定义、多个构造器，如<ul>
<li>只调用<code>__new__()</code>、绕过<code>__init__</code>，创建未初始化
的实例</li>
<li>反序列化对象：从字节串反序列构造符合要求的对象</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>通过<code>classmethod()</code>构造器创建</li>
<li>Py3中以上特性依赖于<code>___getattribute__</code>实现</li>
</ul>
</blockquote>
<h3 id="Static-Method-Objects"><a href="#Static-Method-Objects" class="headerlink" title="Static Method Objects"></a><em>Static Method Objects</em></h3><p>静态方法：提供了<strong>避免将函数对象转换为方法对象</strong>的方式</p>
<ul>
<li>对任意其他对象的封装，通常用于封装用户定义方法对象</li>
<li>从类、类实例获取静态方法对象时，实际返回的是封装的对象，
不会被进一步转换</li>
<li>静态方法对象自身不是可调用的，但其封装的对象通常可调用</li>
</ul>
<blockquote>
<ul>
<li>通过内置<code>staticmethod()</code>构造器创建</li>
<li>Py3中以上特性依赖于<code>___getattribute__</code>实现</li>
</ul>
</blockquote>
<h3 id="内置函数、方法"><a href="#内置函数、方法" class="headerlink" title="内置函数、方法"></a>内置函数、方法</h3><blockquote>
<ul>
<li>内置函数：对C函数的外部封装</li>
<li>内置方法：内置函数另一种形式，（类似实例方法）隐式传入
  当前实例作为C函数额外参数</li>
</ul>
</blockquote>
<ul>
<li>包括以下两种类型<ul>
<li><code>builtin_function_or_method</code></li>
<li><code>wrapper_descriptor</code></li>
</ul>
</li>
<li>参数数量、类型由C函数决定</li>
<li>内置方法由支持其的类型描述</li>
</ul>
<h4 id="特殊元属性-1"><a href="#特殊元属性-1" class="headerlink" title="特殊元属性"></a>特殊元属性</h4><ul>
<li><code>__self__</code>：<code>&lt;module &#39;builtins&#39; (built-in)&gt;</code></li>
<li><code>__doc__</code>：函数/方法文档</li>
<li><code>__name__</code>：函数/方法名</li>
<li><code>__module__</code>：所在模块名</li>
</ul>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><ul>
<li>函数是描述器，函数类<code>function</code>实现有<code>__get__</code>方法</li>
<li><code>function.__get__</code>即将函数首个参数进行绑定，返回绑定方法</li>
</ul>
<blockquote>
<ul>
<li>参见<em>cs_python/py3ref/cls_special_methods</em></li>
</ul>
</blockquote>
<h2 id="Generator-Functions"><a href="#Generator-Functions" class="headerlink" title="Generator Functions"></a><em>Generator Functions</em></h2><p>生成器函数：使用<code>yield</code>语句的函数、方法称为生成器函数</p>
<ul>
<li>生成器函数调用时返回生成器迭代器对象，控制执行函数体</li>
</ul>
<blockquote>
<ul>
<li><code>yield</code>表达式参见<em>cs_python/py3ref/expressions</em></li>
</ul>
</blockquote>
<h3 id="Generator-Iterator"><a href="#Generator-Iterator" class="headerlink" title="Generator-Iterator"></a><em>Generator-Iterator</em></h3><p>生成器迭代器：生成器函数执行得到的迭代器</p>
<ul>
<li><p>实现有迭代器协议<code>__next__</code>的迭代器类实例不同于
生成器迭代器，其仅实现迭代</p>
<ul>
<li>迭代执行过程即<code>__next__</code>函数调用，重入（状态维护）
由类负责</li>
<li>无不同迭代状态区别</li>
<li>不会自动获得<code>.send</code>、<code>.throw</code>、<code>.close</code>等方法</li>
</ul>
</li>
<li><p>或者说生成器迭代器是：利用yield表达式对迭代器的的简化
实现，并预定义<code>.send</code>、<code>.throw</code>、<code>.close</code>方法</p>
</li>
</ul>
<blockquote>
<ul>
<li>迭代器协议参见<em>cs_python/py3ref/cls_special_methods</em></li>
</ul>
</blockquote>
<h4 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h4><ul>
<li>其某方法被调用时，生成器函数开始执行</li>
<li>执行到第一个yield表达式被挂起，保留所有局部状态<ul>
<li>局部变量当前绑定</li>
<li>指令指针</li>
<li>内部求值栈</li>
<li>任何异常处理状态</li>
</ul>
</li>
<li>返回<code>expression_list</code></li>
<li>调用生成器某方法，生成函数继续执行</li>
<li>执行<code>return</code>、函数体执行完毕将<code>raise StopIteration</code></li>
</ul>
<blockquote>
<ul>
<li>生成器表达式、yield表达式参见
  <em>cs_python/py3ref/expressions</em></li>
</ul>
</blockquote>
<h4 id="生成器迭代器状态"><a href="#生成器迭代器状态" class="headerlink" title="生成器迭代器状态"></a>生成器迭代器状态</h4><p>生成器在声明周期中有如下4中状态</p>
<ul>
<li><code>&quot;GEN_CREATED&quot;</code>：等待执行</li>
<li><code>&quot;GEN_RUNNING&quot;</code>：正在执行，只有多线程中才能看到</li>
<li><code>&quot;GEN_SUSPENDED&quot;</code>：在yield表达式处挂起状态</li>
<li><code>&quot;GEN_CLOSED&quot;</code>：关闭状态</li>
</ul>
<blockquote>
<ul>
<li>可通过<code>inspect.getgeneratorstate()</code>方法查看</li>
</ul>
</blockquote>
<h4 id="next"><a href="#next" class="headerlink" title="__next__"></a><code>__next__</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">generator</span>.<span class="title">__next__</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：开始生成器函数执行、或从上次执行yield表达式处恢复
执行</p>
<ul>
<li>生成器函数通过<code>__next__</code>方法恢复执行时，yield表达式
始终取值为<code>None</code></li>
<li>执行至下个yield表达式</li>
</ul>
</li>
<li><p>返回值：生成器迭代器产生的下个值</p>
<ul>
<li>yield表达式中<code>expression_list</code>值</li>
<li>若生成器没有产生下个值就退出，<code>raise StopIteration</code></li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>此方法通常隐式通过<code>for</code>循环、<code>next()</code>函数调用</li>
</ul>
</blockquote>
<h4 id="send"><a href="#send" class="headerlink" title="send"></a><code>send</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">generator</span>.<span class="title">send</span>(<span class="params">value</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：恢复生成器函数执行并向其“发送”值<code>value</code></p>
<ul>
<li><code>value</code>参数作为yield表达式的结果</li>
<li>执行至下个yield表达式</li>
</ul>
</li>
<li><p>返回值：生成器迭代器产生的下个值</p>
<ul>
<li>yield表达式中<code>expression_list</code>值</li>
<li>若生成器没有产生下个值就退出，<code>raise StopIteration</code></li>
</ul>
</li>
<li><p>说明</p>
<ul>
<li>若生成器中包含子迭代器，<code>send</code>传参数值将被传递给
下层迭代器，若子迭代器没有合适接收方法、处理，将
<code>raise AttributeError</code>、<code>raise TypeError</code></li>
<li><code>.send</code>方法参数为<code>None</code>时实际不会有传递参数行为<ul>
<li>调用<code>.send()</code>启动生成器时，必须以<code>None</code>作为调用
参数，因为此时没有可以接收值的yield表达式</li>
<li>子迭代器中没有处理参数时，<code>.send(None)</code>也能正常
工作</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="throw"><a href="#throw" class="headerlink" title="throw"></a><code>throw</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">generator</span>.<span class="title">throw</span>(<span class="params"><span class="built_in">type</span>[, value[, traceback]]</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：在生成器<strong>暂停位置处</strong>引发<code>type</code>类型异常</p>
<ul>
<li>若异常被处理：则执行直至下个yield表达式</li>
<li>若生成器函数没有捕获传入异常、或引发另一个异常：异常
会被传播给调用者</li>
</ul>
</li>
<li><p>返回值：返回生成器产生的下个值（若异常被处理）</p>
<ul>
<li>若生成器没有产生下个值就退出，<code>raise StopIteration</code></li>
</ul>
</li>
<li><p>说明</p>
<ul>
<li>若生成器中包含子迭代器，<code>throw</code>传入异常将被传递给
子迭代器</li>
<li>调用<code>throw</code>启动生成器，会在生成器函数开头引发错误</li>
</ul>
</li>
</ul>
<h4 id="close"><a href="#close" class="headerlink" title="close"></a><code>close</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">generator</span>.<span class="title">close</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用途：在生成器函数暂停处<code>raise GeneratorExit</code><ul>
<li>若之后生成器函数正常退出、关闭、引发<code>GeneratorExit</code>
（生成器中未捕获该异常）：则关闭生成器并返回调用者</li>
<li>若生成器继续产生值：则<code>raise RuntimeError</code></li>
<li>若生成器引发其他异常：则传播给调用者</li>
<li>若生成器由于异常、或正常而退出：则无操作</li>
</ul>
</li>
</ul>
<h3 id="Yield表达式—调用外部函数"><a href="#Yield表达式—调用外部函数" class="headerlink" title="Yield表达式—调用外部函数"></a>Yield表达式—调用外部函数</h3><blockquote>
<ul>
<li>生成器函数执行yield表达式类似<strong>调用外部函数</strong></li>
</ul>
</blockquote>
<ul>
<li>当前函数栈保留当前状态、挂起</li>
<li>执行yield表达式“完毕”后，“返回”到调用处</li>
<li>yield表达式“返回值”取决于生成器恢复执行所调用方法<ul>
<li><code>.__next__</code>：<code>for</code>、<code>next()</code>调用，返回<code>None</code></li>
<li><code>.send()</code>：返回<code>.send()</code>参数</li>
</ul>
</li>
<li>此时整体类似于<ul>
<li>主调函数调用生成器函数</li>
<li>生成器函数调用yield表达式</li>
</ul>
</li>
</ul>
<h3 id="生成器函数—协程"><a href="#生成器函数—协程" class="headerlink" title="生成器函数—协程"></a>生成器函数—协程</h3><blockquote>
<ul>
<li>生成器函数类似协程，也被称为<em>semi-coroutine</em>，是协程子集</li>
</ul>
</blockquote>
<ul>
<li>相似点<ul>
<li>可<code>yield</code>多次，有多个入口点</li>
<li>执行可以被挂起</li>
<li>可在恢复执行时传递参数控制执行</li>
</ul>
</li>
<li>不同点<ul>
<li><code>yield</code>后控制权总是转移给生成器迭代器调用者，生成器
函数不能控制<code>yield</code>后继续执行的位置
（<code>yield</code>表达式仅仅传递值给父程序，并不是指定需要
跳转的、平等的协程）</li>
</ul>
</li>
</ul>
<h3 id="生成器函数—try"><a href="#生成器函数—try" class="headerlink" title="生成器函数—try"></a>生成器函数—<code>try</code></h3><blockquote>
<ul>
<li><code>try</code>结构中任何位置都允许yield表达式</li>
</ul>
</blockquote>
<ul>
<li><p>若生成器在<strong>销毁之前</strong>没有恢复执行（引用计数为0、被垃圾
回收），<code>try</code>结构中的yield表达式挂起可能导致<code>finally</code>
子句执行失败</p>
</li>
<li><p>此时应由运行该异步生成器的事件循环、或任务调度器负责调用
生成器-迭代器<code>close()</code>方法，从而允许任何挂起的<code>finally</code>
子句得以执行</p>
</li>
</ul>
<h3 id="例"><a href="#例" class="headerlink" title="例"></a>例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">echo</span>(<span class="params">value=<span class="literal">None</span></span>):</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;execution start&quot;</span>)</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				value = (<span class="keyword">yield</span> value)</span><br><span class="line">			<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">				value = e</span><br><span class="line">	<span class="keyword">finally</span>:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;clean up when gen.close() is called&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	gen = echo(<span class="number">1</span>)</span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">next</span>(gen))		<span class="comment"># 1</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">next</span>(gen))		<span class="comment"># None</span></span><br><span class="line">	<span class="built_in">print</span>(gen.send(<span class="number">2</span>))		<span class="comment"># 2</span></span><br><span class="line">	<span class="built_in">print</span>(gen.throw(TypeError, <span class="string">&quot;spam&quot;</span>))	<span class="comment"># TypeError(&#x27;spam&#x27;,)</span></span><br><span class="line">	gen.close()				<span class="comment"># clean up...</span></span><br></pre></td></tr></table></figure>
<h2 id="Coroutine-Function"><a href="#Coroutine-Function" class="headerlink" title="Coroutine Function"></a><em>Coroutine Function</em></h2><p>协程函数：使用<code>async def</code>定义的函数、方法</p>
<ul>
<li>调用时返回一个<code>coroutine</code>对象</li>
<li>可能包含<code>await</code>表达式、<code>async with</code>、<code>async for</code>语句<ul>
<li>即协程函数能在执行过程中挂起、恢复</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>协程参见<em>cs_program/#todo</em></li>
</ul>
</blockquote>
<h3 id="Coroutine-Objects"><a href="#Coroutine-Objects" class="headerlink" title="Coroutine Objects"></a><em>Coroutine Objects</em></h3><p>协程对象：属于<em>awaitable</em>对象</p>
<ul>
<li><p>协程执行：调用<code>__await__</code>，迭代其返回值进行控制</p>
<ul>
<li>协程结束执行、返回时，迭代器<code>raise StopIteration</code>，
异常的<code>value</code>属性将指向返回值</li>
<li>等待协程超过一次将<code>raise RuntimeError</code></li>
</ul>
</li>
<li><p>若协程引发异常，其会被迭代器传播</p>
<ul>
<li>协程不应该直接引发未处理的<code>StopIteration</code></li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>可等待对象参见<em>cs_python/py3ref/cls_special_methods</em></li>
</ul>
</blockquote>
<h4 id="send-1"><a href="#send-1" class="headerlink" title="send"></a><code>send</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span>.<span class="title">send</span>(<span class="params">value</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：开始、恢复协程执行</p>
<ul>
<li><code>value is None</code>：相当于等待<code>__await__()</code>返回迭代器
结果下一项</li>
<li><code>value is not None</code>：此方法将委托给导致协程挂起的
迭代器的<code>send()</code>方法</li>
</ul>
</li>
<li><p>返回值：返回值、异常等同对<code>__await__()</code>返回值迭代结果</p>
</li>
</ul>
<h4 id="throw-1"><a href="#throw-1" class="headerlink" title="throw"></a><code>throw</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span>.<span class="title">throw</span>(<span class="params"><span class="built_in">type</span>[, value[, traceback]]</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：在协程内引发指定异常</p>
<ul>
<li>此方法将委托给导致协程内挂起的迭代器的<code>throw()</code>方法
，若其存在</li>
<li>否则异常在挂起点被引发</li>
</ul>
</li>
<li><p>返回值：返回值、异常等同对<code>__await__()</code>返回值迭代结果</p>
<ul>
<li>若异常未在协程内被捕获，则传回给主调者</li>
</ul>
</li>
</ul>
<h4 id="close-1"><a href="#close-1" class="headerlink" title="close"></a><code>close</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span>.<span class="title">close</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用途：清理自身并退出<ul>
<li>若协程被挂起，此方法先被委托给导致该协程挂起的迭代器
的<code>.close()</code>方法，若其存在</li>
<li>然后在挂起点<code>raise GeneratorExit</code>，使得协程立即清理
自身</li>
<li>最后协程被标记为已结束执行，即使未被启动</li>
<li>协程对象将被销毁时，会被自动调用</li>
</ul>
</li>
</ul>
<h2 id="Asynchronous-Generator-Functions"><a href="#Asynchronous-Generator-Functions" class="headerlink" title="Asynchronous Generator Functions"></a><em>Asynchronous Generator Functions</em></h2><p>异步生成器函数：包含<code>yield</code>语句、使用<code>async def</code>定义函数、
方法（即在协程中）</p>
<ul>
<li>返回异步生成器迭代器对象，控制执行函数体</li>
</ul>
<blockquote>
<ul>
<li><code>yield from</code>表达式在异步生成器函数中使用将引发语法错误</li>
</ul>
</blockquote>
<h3 id="Asynchronous-Generator-Iterator"><a href="#Asynchronous-Generator-Iterator" class="headerlink" title="Asynchronous Generator-Iterator"></a><em>Asynchronous Generator-Iterator</em></h3><p>异步生成器迭代器</p>
<ul>
<li><p>异步体现：<code>async def</code>定义协程函数中可以使用异步代码</p>
</li>
<li><p>异步生成器迭代器方法返回的可等待对象<strong>们</strong>执行同一函数栈</p>
<ul>
<li>可等待对象被<code>await</code><strong>运行时才会执行</strong>异步函数体</li>
<li>类似普通生成器迭代器，执行到yield表达式挂起</li>
<li>则连续返回多个可等待对象可以乱序<code>await</code></li>
</ul>
<blockquote>
<ul>
<li>可以视为返回<strong>待执行函数体</strong></li>
</ul>
</blockquote>
</li>
</ul>
<blockquote>
<ul>
<li><p>异步生成器迭代器执行过程、yield表达式、<code>try</code>结构、同异步
  迭代器协议关联， 均参见普通生成器迭代器</p>
</li>
<li><p>异步迭代器协议参见<em>cs_python/py3ref/cls_special_methods</em></p>
</li>
<li><p>异步生成器函数使用<code>yield from</code>语句将引发语法错误</p>
</li>
</ul>
</blockquote>
<h4 id="最终化处理-todo"><a href="#最终化处理-todo" class="headerlink" title="最终化处理#todo"></a>最终化处理#todo</h4><p>处理最终化：事件循环应该定义终结器函数</p>
<ul>
<li>其接收异步生成器迭代器、且可能调用<code>aclose()</code>方法并执行
协程</li>
<li>终结器可以通过调用<code>sys.set_asyncgen_hooks()</code>注册</li>
<li>首次迭代时，异步生成器迭代器将保存已注册终结器以便最终化
时调用</li>
</ul>
<h4 id="anext"><a href="#anext" class="headerlink" title="__anext__"></a><code>__anext__</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span> <span class="title">agen</span>.<span class="title">__anext__</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：返回可等待对象，可等待对象运行时开始、恢复异步
生成器函数执行</p>
<ul>
<li>异步生成器函数通过<code>__anext__</code>方法恢复执行时，返回的
可等待对象中yield表达式始终取值为<code>None</code></li>
</ul>
</li>
<li><p><strong>可等待对象返回值</strong>：返回异步生成器的下个值</p>
<ul>
<li>执行至下个yield表达式，返回<code>expression_list</code>值</li>
<li>若异步生成器没有产生下个值就退出，则
<code>raise StopAsyncIteration</code>，</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>此方法通常由<code>async for</code>异步循环隐式调用</li>
</ul>
</blockquote>
<h4 id="asend"><a href="#asend" class="headerlink" title="asend"></a><code>asend</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span> <span class="title">agen</span>.<span class="title">asend</span>(<span class="params">value</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：返回可等待对象，可等待对象运行时开始、恢复异步
生成器函数执行，并向其“发送”值<code>value</code></p>
<ul>
<li><code>value</code>参数作为yield表达式的结果</li>
<li>执行至下个yield表达式</li>
</ul>
</li>
<li><p>返回值：异步生成器产生的下个值</p>
<ul>
<li>yield表达式中<code>expression_list</code>值</li>
<li>若生成器没有产生下个值就退出，则
<code>raise StopAsyncIteration</code></li>
</ul>
</li>
<li><p>说明</p>
<ul>
<li>调用<code>.asend()</code>启动生成器时，必须以<code>None</code>作为调用参数</li>
</ul>
</li>
</ul>
<h4 id="athrow"><a href="#athrow" class="headerlink" title="athrow"></a><code>athrow</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span> <span class="title">agen</span>.<span class="title">athrow</span>(<span class="params"><span class="built_in">type</span>[, value[, traceback]]</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：返回可等待对象，可等待对象运行时将在异步生成器函数
<strong>暂停位置处</strong>引发<code>type</code>类型异常</p>
<ul>
<li>若异常被处理：则执行直至下个yield表达式</li>
<li>若异步生成器函数没有捕获传入异常、或引发另一个异常：
可等待对象运行时异常会被传播给调用者</li>
</ul>
</li>
<li><p>返回值：返回生成器产生的下个值（若异常被处理）</p>
<ul>
<li>若生成器没有产生下个值就退出，则
<code>raise StopAsyncIteration</code></li>
</ul>
</li>
<li><p>说明</p>
<ul>
<li>调用<code>athrow</code>启动异步生成器，会在函数开头引发错误</li>
</ul>
</li>
</ul>
<h4 id="aclose"><a href="#aclose" class="headerlink" title="aclose"></a><code>aclose</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span> <span class="title">agen</span>.<span class="title">aclose</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用途：返回可等待对象，可等待对象运行时在异步生成器函数
暂停处<code>raise GeneratorExit</code><ul>
<li>若异步生成器函数正常退出、关闭、引发<code>GeneratorExit</code>
（生成器中未捕获该异常）：则运行可等待对象将
<code>raise StopIteration</code>？？？</li>
<li>后续调用异步生成器迭代器方法返回其他可等待对象：则
运行可等待对象将<code>raise StopAsyncIteration</code></li>
<li>若异步生成器函数产生值：则运行可等待对象将
<code>raise RuntimeError</code></li>
<li>若异步生成器迭代器已经异常、正常退出，则后续调用
<code>aclose</code>方法将返回无行为可等待对象</li>
</ul>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-09T17:11:37.000Z" title="6/10/2019, 1:11:37 AM">2019-06-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-06-09T17:11:37.000Z" title="6/10/2019, 1:11:37 AM">2019-06-10</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3std/">Py3std</a></span><span class="level-item">2 minutes read (About 366 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3std/data_persistence.html">数据持久化</a></h1><div class="content"><h2 id="DBM"><a href="#DBM" class="headerlink" title="DBM"></a>DBM</h2><p>DBM文件：python库中数据库管理的标准工具之一</p>
<ul>
<li>实现了数据的随机访问<ul>
<li>可以使用键访问存储的文本字符串</li>
</ul>
</li>
<li>DBM文件有多个实现<ul>
<li>python标准库中<code>dbm/dbm.py</code></li>
</ul>
</li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ul>
<li>使用DBM文件和使用内存字典类型非常相似<ul>
<li>支持通过键抓取、测试、删除对象</li>
</ul>
</li>
</ul>
<h2 id="pickle"><a href="#pickle" class="headerlink" title="pickle"></a><code>pickle</code></h2><ul>
<li>将内存中的python对象转换为序列化的字节流，可以写入任何
输出流中</li>
<li>根据序列化的字节流重新构建原来内存中的对象</li>
<li>感觉上比较像XML的表示方式，但是是python专用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line">dbfile = <span class="built_in">open</span>(<span class="string">&quot;people.pkl&quot;</span>, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">pickle.dump(db, dbfile)</span><br><span class="line">dbfile.close()</span><br><span class="line">dbfile = <span class="built_in">open</span>(<span class="string">&quot;people.pkl&quot;</span>, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line">db = pickle.load(dbfile)</span><br><span class="line">dbfile.close()</span><br></pre></td></tr></table></figure>
<ul>
<li>不支持<code>pickle</code>序列化的数据类型<ul>
<li>套接字</li>
</ul>
</li>
</ul>
<h2 id="shelves"><a href="#shelves" class="headerlink" title="shelves"></a><code>shelves</code></h2><ul>
<li>就像能必须打开着的、存储持久化对象的词典<ul>
<li>自动处理内容、文件之间的映射</li>
<li>在程序退出时进行持久化，自动分隔存储记录，只获取、
更新被访问、修改的记录</li>
</ul>
</li>
<li>使用像一堆只存储一条记录的pickle文件<ul>
<li>会自动在当前目录下创建许多文件</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> shelves</span><br><span class="line">db = shelves.<span class="built_in">open</span>(<span class="string">&quot;people-shelves&quot;</span>, writeback=<span class="literal">True</span>)</span><br><span class="line">	// `writeback`：载入所有数据进内存缓存，关闭时再写回，</span><br><span class="line">		// 能避免手动写回，但会消耗内存，关闭变慢</span><br><span class="line">db[<span class="string">&quot;bob&quot;</span>] = <span class="string">&quot;Bob&quot;</span></span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>
<h2 id="copyreg"><a href="#copyreg" class="headerlink" title="copyreg"></a><code>copyreg</code></h2><h2 id="marshal"><a href="#marshal" class="headerlink" title="marshal"></a><code>marshal</code></h2><h2 id="sqlite3"><a href="#sqlite3" class="headerlink" title="sqlite3"></a><code>sqlite3</code></h2></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-09T17:10:04.000Z" title="6/10/2019, 1:10:04 AM">2019-06-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-06-09T17:10:04.000Z" title="6/10/2019, 1:10:04 AM">2019-06-10</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3std/">Py3std</a></span><span class="level-item">4 minutes read (About 649 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3std/binary_data.html">二进制数据服务</a></h1><div class="content"><h2 id="struct"><a href="#struct" class="headerlink" title="struct"></a><code>struct</code></h2><p><code>struct</code>模块：用于打包、拆包C<code>struct</code>格式二进制数据</p>
<ul>
<li>使用python字节串存储C<code>struct</code>数据</li>
<li>需要给出格式声明，指定二进制中存储格式</li>
</ul>
<h3 id="格式说明"><a href="#格式说明" class="headerlink" title="格式说明"></a>格式说明</h3><h4 id="字节序、对齐"><a href="#字节序、对齐" class="headerlink" title="字节序、对齐"></a>字节序、对齐</h4><div class="table-container">
<table>
<thead>
<tr>
<th>格式符</th>
<th>字节序（大、小端）</th>
<th>类型大小</th>
<th>字段对齐方式</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@</code>（缺省值）</td>
<td>原生字节序</td>
<td>原生大小</td>
<td>原生对齐</td>
</tr>
<tr>
<td><code>=</code></td>
<td>原生字节序</td>
<td>标准大小</td>
<td>标准对齐</td>
</tr>
<tr>
<td><code>&lt;</code></td>
<td>lb-endian</td>
<td>标准大小</td>
<td>标准对齐</td>
</tr>
<tr>
<td><code>&gt;</code></td>
<td>bl-endian</td>
<td>标准大小</td>
<td>标准对齐</td>
</tr>
<tr>
<td><code>!</code></td>
<td>同<code>&gt;</code></td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<ul>
<li>原生对齐：C对齐方式，字段起始位置须为其长度整数倍</li>
<li>标准对齐：按字节对齐，无需使用<code>0</code>补齐</li>
</ul>
</blockquote>
<h4 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Format</th>
<th>C Type</th>
<th>Python</th>
<th>Bytes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>x</code></td>
<td>pad byte</td>
<td>no value</td>
<td>1</td>
</tr>
<tr>
<td><code>?</code></td>
<td><code>_Bool</code></td>
<td><code>bool</code></td>
<td>1</td>
</tr>
<tr>
<td><code>h</code></td>
<td><code>short</code></td>
<td><code>integer</code></td>
<td>2</td>
</tr>
<tr>
<td><code>H</code></td>
<td><code>unsigned short</code></td>
<td><code>integer</code></td>
<td>2</td>
</tr>
<tr>
<td><code>i</code></td>
<td><code>int</code></td>
<td><code>integer</code></td>
<td>4</td>
</tr>
<tr>
<td><code>I</code></td>
<td><code>unsigned int</code></td>
<td><code>integer</code></td>
<td>4</td>
</tr>
<tr>
<td><code>l</code></td>
<td><code>long</code></td>
<td><code>integer</code></td>
<td>4</td>
</tr>
<tr>
<td><code>L</code></td>
<td><code>unsigned long</code></td>
<td><code>long</code></td>
<td>4</td>
</tr>
<tr>
<td><code>q</code></td>
<td><code>long long</code></td>
<td><code>long</code></td>
<td>8</td>
</tr>
<tr>
<td><code>Q</code></td>
<td><code>unsigned long long</code></td>
<td><code>long</code></td>
<td>8</td>
</tr>
<tr>
<td><code>f</code></td>
<td><code>float</code></td>
<td><code>float</code></td>
<td>4</td>
</tr>
<tr>
<td><code>d</code></td>
<td><code>double</code></td>
<td><code>float</code></td>
<td>4</td>
</tr>
<tr>
<td><code>c</code></td>
<td><code>char</code></td>
<td><code>str</code> of length1</td>
<td>1</td>
</tr>
<tr>
<td><code>b</code></td>
<td><code>signed char</code></td>
<td><code>bytes</code> of length1</td>
<td>1</td>
</tr>
<tr>
<td><code>B</code></td>
<td><code>unsigned char</code></td>
<td><code>bytes</code> of length1</td>
<td>1</td>
</tr>
<tr>
<td><code>s</code></td>
<td><code>char[]</code></td>
<td><code>str</code></td>
<td>1</td>
</tr>
<tr>
<td><code>p</code></td>
<td>pascal string，带长度</td>
<td><code>str</code></td>
<td>NA</td>
</tr>
<tr>
<td><code>n</code></td>
<td><code>ssize_t</code></td>
<td><code>integer</code></td>
<td>NA</td>
</tr>
<tr>
<td><code>N</code></td>
<td><code>size_t</code></td>
<td><code>integer</code></td>
<td>NA</td>
</tr>
<tr>
<td><code>P</code></td>
<td><code>void *</code></td>
<td>足够容纳指针的整形</td>
<td>NA</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><p>在类型符前添加数字可以指定类型重复次数</p>
</li>
<li><p>字符、字符串类型实参须以字节串形式给出</p>
<ul>
<li>字符：必须以长度为1字节串形式给出，重复须对应多参数</li>
<li>字符串：可以是任意长度字节串，重复对应单个字符串<ul>
<li>长于格式指定长度被截断</li>
<li>短于格式指定长度用<code>\0x00</code>补齐</li>
</ul>
</li>
</ul>
</li>
<li><p>python按以上长度封装各类型，但C各类型长度取决于平台，
以上近视64位机器最可能对应C类型</p>
<ul>
<li>非64位机器<code>long long</code>类型大部分为4bytes</li>
</ul>
</li>
<li><p>用途</p>
<ul>
<li>封装、解压数据</li>
<li><code>reinterpret_cast</code>类型转换</li>
</ul>
</li>
</ul>
<h3 id="Struct"><a href="#Struct" class="headerlink" title="Struct"></a><code>Struct</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Struct</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, fmt</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用途：根据指定格式<code>fmt</code>编译<code>Sturct</code>对象<ul>
<li><code>Sturct</code>对象可以调用以下方法，无需再次指定<code>fmt</code></li>
</ul>
</li>
</ul>
<h3 id="Pack"><a href="#Pack" class="headerlink" title="Pack"></a><em>Pack</em></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">struct</span>.<span class="title">pack</span>(<span class="params">fmt, v1, v2,...</span>) -&gt; <span class="built_in">bytes</span>:</span></span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">struct</span>.<span class="title">pack_into</span>(<span class="params">fmt, buffer, offset , v1, v2, ...</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>pack</code>：按照指定格式<code>fmt</code>封装数据为字节串</li>
<li><code>pack_into</code>：将字节串写入<code>buffer</code>指定偏移<code>offset</code>处</li>
</ul>
<h3 id="Unpack"><a href="#Unpack" class="headerlink" title="Unpack"></a><em>Unpack</em></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">struct</span>.<span class="title">unpack</span>(<span class="params">fmt, buffer</span>) -&gt; (v1, v2,...):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">struct</span>.<span class="title">unpack</span>(<span class="params">fmt, buffer, offset=<span class="number">0</span></span>) -&gt; (v1, v2, ...):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">struct</span>.<span class="title">iter_unpack</span>(<span class="params">fmt, buffer</span>) -&gt; iterator(v1, v2,...):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>unpack</code>：按照指定格式<code>fmt</code>拆包字节串<code>buffer</code></li>
<li><code>unpack_from</code>：从偏移<code>offset</code>处开始拆包</li>
<li><code>iter_unpack</code>：迭代解压包含多个<code>fmt</code>的<code>buffer</code></li>
</ul>
<h3 id="calsize"><a href="#calsize" class="headerlink" title="calsize"></a><code>calsize</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">struct</span>.<span class="title">calsize</span>(<span class="params">fmt</span>) -&gt; integer:</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用途：计算封装指定格式<code>fmt</code>所需字节数</li>
</ul>
<h2 id="codecs"><a href="#codecs" class="headerlink" title="codecs"></a><code>codecs</code></h2></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-09T16:08:54.000Z" title="6/10/2019, 12:08:54 AM">2019-06-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-06-09T16:08:54.000Z" title="6/10/2019, 12:08:54 AM">2019-06-10</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3std/">Py3std</a></span><span class="level-item">11 minutes read (About 1595 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3std/interproc_com.html">网络、进程间通信</a></h1><div class="content"><h1 id="asyncio"><a href="#asyncio" class="headerlink" title="asyncio"></a><code>asyncio</code></h1><h2 id="协程与任务"><a href="#协程与任务" class="headerlink" title="协程与任务"></a>协程与任务</h2><blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3.10/library/asyncio-task.html">https://docs.python.org/zh-cn/3.10/library/asyncio-task.html</a></li>
</ul>
</blockquote>
<ul>
<li><p>协程包含两层概念</p>
<ul>
<li>协程函数：定义形式为<code>async def</code>的函数</li>
<li>协程对象：调用协程函数返回的对象</li>
</ul>
</li>
<li><p>可等待对象：可在<code>await</code>语句种使用的对象</p>
<ul>
<li>协程对象</li>
<li><code>asyncio.Future</code>：异步调用结果的占位符<ul>
<li>以便通过<code>async/await</code>使用基于回调的代码</li>
<li>通过情况下无需在应用层级代码中显式创建<code>Future</code>
对象</li>
</ul>
</li>
<li><code>asyncio.Task</code>：<code>Future</code>子类，包装coroutine的future</li>
</ul>
</li>
<li><p>运行协程（对象）的三种方式</p>
<ul>
<li><code>await</code>阻塞式等待协程执行完毕<ul>
<li>只能在<code>async def</code>函数中使用</li>
<li><code>await</code>同样是在事件循环中阻塞执行</li>
</ul>
</li>
<li>将协程对象包装为可并发运行的<code>asyncio.Task</code>，并在事件
循环中并发执行<ul>
<li><code>asyncio.create_task</code></li>
</ul>
</li>
<li><code>asyncio.run()</code>创建、管理事件循环的高层API<ul>
<li>启动事件循环执行是真正运行协程对象的开始</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="asyncio-run"><a href="#asyncio-run" class="headerlink" title="asyncio.run"></a><code>asyncio.run</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">asyncio</span>.<span class="title">run</span>(<span class="params">coro, *, debug=<span class="literal">False</span></span>);</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>功能：创建新的事件循环并在结束时关闭</p>
<ul>
<li>执行传入的协程，并返回结果</li>
<li>管理asyncio事件循环、终结异步生成器、关闭线程池</li>
</ul>
</li>
<li><p>应当被用作asyncio程序的主入口点，理想情况下只被调用一次</p>
</li>
</ul>
<blockquote>
<ul>
<li>同一线程中只能有一个asyncio事件循环运行，若同线程中有
  其他事件循环运行，此函数不能被调用</li>
</ul>
</blockquote>
<h3 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">asyncio</span>.<span class="title">Task</span>(<span class="params">Future</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">coro,*,loop=<span class="literal">None</span>,name=<span class="literal">None</span></span>);</span></span><br><span class="line"><span class="function">	# 1、此方法仅在下轮事件循环中`<span class="title">raise</span> <span class="title">asyncio</span>.<span class="title">CancelledError</span>`</span></span><br><span class="line"><span class="function">	#	给被封包协程，协程自行选择是否取消</span></span><br><span class="line"><span class="function">	# 2、协程等待的`<span class="title">Future</span>`对象同样会被取消</span></span><br><span class="line"><span class="function">	<span class="title">def</span> <span class="title">cancel</span>(<span class="params">msg=<span class="literal">None</span></span>);</span></span><br><span class="line"><span class="function">	<span class="title">bool</span> <span class="title">cancelled</span>();</span></span><br><span class="line"><span class="function">	<span class="title">bool</span> <span class="title">done</span>();</span></span><br><span class="line"><span class="function">	<span class="title">def</span> <span class="title">result</span>();</span></span><br><span class="line"><span class="function">	<span class="title">def</span> <span class="title">exception</span>();</span></span><br><span class="line"><span class="function">	<span class="title">def</span> <span class="title">add_done_callback</span>(<span class="params">callback, *, context=<span class="literal">None</span></span>);</span></span><br><span class="line"><span class="function">	<span class="title">def</span> <span class="title">remove_done_callback</span>(<span class="params">callback</span>);</span></span><br><span class="line"><span class="function">	<span class="title">def</span> <span class="title">get_stack</span>(<span class="params">*, limit=<span class="literal">None</span></span>);</span></span><br><span class="line"><span class="function">	<span class="title">def</span> <span class="title">print_stack</span>(<span class="params">*, limit=<span class="literal">None</span>, file=<span class="literal">None</span></span>);</span></span><br><span class="line"><span class="function">	<span class="title">def</span> <span class="title">get_coro</span>();</span></span><br><span class="line"><span class="function">	<span class="title">def</span> <span class="title">get_name</span>();</span></span><br><span class="line"><span class="function">	<span class="title">def</span> <span class="title">set_name</span>(<span class="params">value</span>);</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>Task</code>：用于在事件循环中运行协程，非线程安全<ul>
<li>若协程在等待<code>Future</code>对象，<code>Task</code>对象会挂起该协程执行
并等待该<code>Future</code>对象完成再执行</li>
<li>事件循环使用协同日程调度，事件循环每次运行一个<code>Task</code>
对象，<code>Task</code>对象会等待<code>Future</code>对象完成，事件循环会
运行其他<code>Task</code>、回调、执行IO操作</li>
<li>不建议手动实例化<code>Task</code>对象，可以使用高层级的
<code>asyncio.create_task()</code>，或低层级的
<code>loop.create_task()</code>、<code>ensure_future()</code>创建</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li><code>asyncio.Task</code>从<code>Future</code>继承了除<code>Future.set_result()</code>、
  <code>Future.set_exception()</code>外的所有API</li>
</ul>
</blockquote>
<h4 id="create-task"><a href="#create-task" class="headerlink" title="create_task"></a><code>create_task</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">asyncio</span>.<span class="title">create_task</span>(<span class="params">coro, *, name=<span class="literal">None</span></span>);</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>功能：将协程打包为task，排入日程准备执行</p>
</li>
<li><p>任务会在<code>get_running_loop()</code>返回的循环中执行</p>
<ul>
<li>若线程中没有在运行的循环则引发<code>RuntimeError</code></li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>python3.7加入，之前版本可以使用<code>asyncio.ensure_future()</code></li>
</ul>
</blockquote>
<h4 id="gather"><a href="#gather" class="headerlink" title="gather"></a><code>gather</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awaitable asyncio.gather(*aws, return_exception=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>功能：并发运行<code>aws</code>序列中的可等待对象</p>
<ul>
<li>若<code>aws</code>中的某个可等待对象为协程对象，则会自动作为
任务加入日程</li>
<li>若所有等待对象都成功完成，结果将是所有返回值列表，
结果顺序同<code>aws</code>中对象顺序</li>
<li>若<code>gather</code>被取消，被提交的可等待对象也被取消</li>
<li>若<code>aws</code>中task、future被取消，将被当作引发
<code>CancelledError</code>处理，<code>gather</code>也不会被取消</li>
</ul>
</li>
<li><p>参数说明</p>
<ul>
<li><code>return_exception</code><ul>
<li><code>False</code>：首个异常被传播给等待<code>gather()</code>的任务</li>
<li><code>True</code>：异常和成功结果一样处理并被聚合至结果列表</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="shield"><a href="#shield" class="headerlink" title="shield"></a><code>shield</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awaitable asyncio.shield(aw);</span><br></pre></td></tr></table></figure>
<ul>
<li><p>功能：保护可等待对象防止其被取消</p>
<ul>
<li>若<code>aw</code>是协程，则将自动作为任务加入日程</li>
<li>包含<code>shield</code>的协程被取消，<code>aw</code>中的任务不会被取消，
但若<code>aw</code>的调用者被取消，<code>await</code>表达式仍然会
<code>raise CancelledError</code></li>
<li>若通过其他方式取消<code>aw</code>，则<code>shield</code>也会被取消</li>
</ul>
</li>
<li><p>希望完全忽略取消操作则需要配合<code>try/except</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	res = <span class="keyword">await</span> shield(aw)</span><br><span class="line"><span class="keyword">except</span> CancelledError:</span><br><span class="line">	res = <span class="literal">None</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul>
<li><p>Task内省</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 返回当前运行Task实例，没有则返回`None`</span></span><br><span class="line">Task = asyncio.current_task(loop=<span class="literal">None</span>)</span><br><span class="line"> <span class="comment"># 返回`loop`事件循环未完成Task对象</span></span><br><span class="line"><span class="type">Set</span>(Task) = asyncio.current_task(loop=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Sleep</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">coroutine asyncio.sleep(delay, result=<span class="literal">None</span>, *, loop=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="等待超时"><a href="#等待超时" class="headerlink" title="等待超时"></a>等待超时</h3><h4 id="wait-for"><a href="#wait-for" class="headerlink" title="wait_for"></a><code>wait_for</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">coroutine asyncio.wait_for(aw, timeout);</span><br></pre></td></tr></table></figure>
<ul>
<li>功能：等待<code>aw</code>可等待对象完成<ul>
<li>发生超时则取消任务并<code>raise asyncio.TimeoutError</code></li>
<li>函数会等待直到<code>aw</code>实际被取消，则总等待时间可能会超过
<code>timeout</code></li>
<li>可以通过<code>shield</code>避免任务被取消</li>
<li>若等待被取消，则<code>aw</code>也被取消</li>
</ul>
</li>
</ul>
<h4 id="wait"><a href="#wait" class="headerlink" title="wait"></a><code>wait</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(done, pending) asyncio.wait(aws, *, timeout=<span class="literal">None</span>,</span><br><span class="line">	return_when=ALL_COMPELTED);</span><br></pre></td></tr></table></figure>
<ul>
<li><p>功能：并发运行<code>aws</code>并阻塞线程直到满足<code>return_when</code>指定
的条件</p>
<ul>
<li>超时不会<code>raise asyncio.TimeoutError</code>，而会在返回未
完成的<code>Future</code>、<code>Task</code></li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li><code>return_when</code><ul>
<li><code>FIRST_COMPLETED</code>：任意可等待对象结束、取消时
返回</li>
<li><code>ALL_COMPLETED</code>：所有可等待对象结束、取消时返回</li>
<li><code>FIRST_EXCEPTION</code>：任意可等待对象引发异常结束时
返回，否则同<code>ALL_COMPLETED</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="as-completed"><a href="#as-completed" class="headerlink" title="as_completed"></a><code>as_completed</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iterator asyncio.as_completed(aws, timeout=<span class="literal">None</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>功能：并发运行<code>aws</code>中可等待对象，返回协程迭代器，返回的
每个协程可被等待以从剩余可等待对象集合中获得最早下个结果<ul>
<li>超时则<code>raise asyncio.TimeoutError</code></li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> coro <span class="keyword">in</span> asyncio.as_completed(aws):</span><br><span class="line">	earliest_result = <span class="keyword">await</span> coro</span><br></pre></td></tr></table></figure>
<h3 id="其他线程中执行"><a href="#其他线程中执行" class="headerlink" title="其他线程中执行"></a>其他线程中执行</h3><h4 id="to-thread"><a href="#to-thread" class="headerlink" title="to_thread"></a><code>to_thread</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">coroutine asyncio.to_thread(func, *args, **kwargs);</span><br></pre></td></tr></table></figure>
<ul>
<li>功能：在不同线程中异步运行函数<code>func</code><ul>
<li><code>args</code>、<code>kwargs</code>会被直接传给<code>func</code></li>
<li>当前<code>contextvars.Context</code>被传播，允许在不同线程中
访问来自事件循环的上下文变量</li>
<li>主要用于执行可能会阻塞事件循环的函数<ul>
<li>对于CPython实现，由于GIL存在，此函数一般只能将
IO密集型函数变为非阻塞</li>
<li>对于会释放GIL的扩展模块、无此限制的替代性python
实现，此函数也可以被用于CPU密集型函数</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="run-coroutine-threadsafe"><a href="#run-coroutine-threadsafe" class="headerlink" title="run_coroutine_threadsafe"></a><code>run_coroutine_threadsafe</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">concurrent.futures.Future asyncio.run_coroutine_threadsafe(coro, loop)</span><br></pre></td></tr></table></figure>
<ul>
<li>功能：向事件循环<code>loop</code>提交协程<code>coro</code><ul>
<li>线程安全</li>
<li>此函数应该从另一个系统线程中调用</li>
</ul>
</li>
</ul>
<h1 id="socket"><a href="#socket" class="headerlink" title="socket"></a><code>socket</code></h1><h1 id="ssl"><a href="#ssl" class="headerlink" title="ssl"></a><code>ssl</code></h1><h1 id="select"><a href="#select" class="headerlink" title="select"></a><code>select</code></h1><h1 id="selectors"><a href="#selectors" class="headerlink" title="selectors"></a><code>selectors</code></h1><h1 id="asyncore"><a href="#asyncore" class="headerlink" title="asyncore"></a><code>asyncore</code></h1><h1 id="asynchat"><a href="#asynchat" class="headerlink" title="asynchat"></a><code>asynchat</code></h1><h1 id="signal"><a href="#signal" class="headerlink" title="signal"></a><code>signal</code></h1><h1 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a><code>mmap</code></h1></div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/19/">Previous</a></div><div class="pagination-next"><a href="/page/21/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/19/">19</a></li><li><a class="pagination-link is-current" href="/page/20/">20</a></li><li><a class="pagination-link" href="/page/21/">21</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/40/">40</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Algorithm/"><span class="level-start"><span class="level-item">Algorithm</span></span><span class="level-end"><span class="level-item tag">36</span></span></a><ul><li><a class="level is-mobile" href="/categories/Algorithm/Data-Structure/"><span class="level-start"><span class="level-item">Data Structure</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/categories/Algorithm/Heuristic/"><span class="level-start"><span class="level-item">Heuristic</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Algorithm/Issue/"><span class="level-start"><span class="level-item">Issue</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Algorithm/Problem/"><span class="level-start"><span class="level-item">Problem</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/Algorithm/Specification/"><span class="level-start"><span class="level-item">Specification</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/C-C/"><span class="level-start"><span class="level-item">C/C++</span></span><span class="level-end"><span class="level-item tag">34</span></span></a><ul><li><a class="level is-mobile" href="/categories/C-C/Cppref/"><span class="level-start"><span class="level-item">Cppref</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/C-C/Cstd/"><span class="level-start"><span class="level-item">Cstd</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/C-C/MPI/"><span class="level-start"><span class="level-item">MPI</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/C-C/STL/"><span class="level-start"><span class="level-item">STL</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/CS/"><span class="level-start"><span class="level-item">CS</span></span><span class="level-end"><span class="level-item tag">14</span></span></a><ul><li><a class="level is-mobile" href="/categories/CS/Character/"><span class="level-start"><span class="level-item">Character</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/CS/Network/"><span class="level-start"><span class="level-item">Network</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/CS/Parallel/"><span class="level-start"><span class="level-item">Parallel</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/CS/Program-Design/"><span class="level-start"><span class="level-item">Program Design</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/CS/Storage/"><span class="level-start"><span class="level-item">Storage</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Daily-Life/"><span class="level-start"><span class="level-item">Daily Life</span></span><span class="level-end"><span class="level-item tag">4</span></span></a><ul><li><a class="level is-mobile" href="/categories/Daily-Life/Maxism/"><span class="level-start"><span class="level-item">Maxism</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Database/"><span class="level-start"><span class="level-item">Database</span></span><span class="level-end"><span class="level-item tag">27</span></span></a><ul><li><a class="level is-mobile" href="/categories/Database/Hadoop/"><span class="level-start"><span class="level-item">Hadoop</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Database/SQL-DB/"><span class="level-start"><span class="level-item">SQL DB</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/Database/Spark/"><span class="level-start"><span class="level-item">Spark</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">5</span></span></a><ul><li><a class="level is-mobile" href="/categories/Java/Scala/"><span class="level-start"><span class="level-item">Scala</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">42</span></span></a><ul><li><a class="level is-mobile" href="/categories/Linux/Bash-Programming/"><span class="level-start"><span class="level-item">Bash Programming</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/Configuration/"><span class="level-start"><span class="level-item">Configuration</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/File-System/"><span class="level-start"><span class="level-item">File System</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/IPC/"><span class="level-start"><span class="level-item">IPC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/Network/"><span class="level-start"><span class="level-item">Network</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/Process-Schedual/"><span class="level-start"><span class="level-item">Process Schedual</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/Shell/"><span class="level-start"><span class="level-item">Shell</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/Tool/"><span class="level-start"><span class="level-item">Tool</span></span><span class="level-end"><span class="level-item tag">14</span></span></a><ul><li><a class="level is-mobile" href="/categories/Linux/Tool/Vi/"><span class="level-start"><span class="level-item">Vi</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/ML-Model/"><span class="level-start"><span class="level-item">ML Model</span></span><span class="level-end"><span class="level-item tag">21</span></span></a><ul><li><a class="level is-mobile" href="/categories/ML-Model/Linear-Model/"><span class="level-start"><span class="level-item">Linear Model</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Model/Model-Component/"><span class="level-start"><span class="level-item">Model Component</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Model/Nolinear-Model/"><span class="level-start"><span class="level-item">Nolinear Model</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Model/Unsupervised-Model/"><span class="level-start"><span class="level-item">Unsupervised Model</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/ML-Specification/"><span class="level-start"><span class="level-item">ML Specification</span></span><span class="level-end"><span class="level-item tag">17</span></span></a><ul><li><a class="level is-mobile" href="/categories/ML-Specification/Click-Through-Rate/"><span class="level-start"><span class="level-item">Click Through Rate</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul><li><a class="level is-mobile" href="/categories/ML-Specification/Click-Through-Rate/Recommandation-System/"><span class="level-start"><span class="level-item">Recommandation System</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/ML-Specification/Computer-Vision/"><span class="level-start"><span class="level-item">Computer Vision</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Specification/FinTech/"><span class="level-start"><span class="level-item">FinTech</span></span><span class="level-end"><span class="level-item tag">5</span></span></a><ul><li><a class="level is-mobile" href="/categories/ML-Specification/FinTech/Risk-Control/"><span class="level-start"><span class="level-item">Risk Control</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/ML-Specification/Graph-Analysis/"><span class="level-start"><span class="level-item">Graph Analysis</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Specification/NLP/"><span class="level-start"><span class="level-item">NLP</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/ML-Technique/"><span class="level-start"><span class="level-item">ML Technique</span></span><span class="level-end"><span class="level-item tag">10</span></span></a><ul><li><a class="level is-mobile" href="/categories/ML-Technique/Feature-Engineering/"><span class="level-start"><span class="level-item">Feature Engineering</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Technique/Neural-Network/"><span class="level-start"><span class="level-item">Neural Network</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/ML-Theory/"><span class="level-start"><span class="level-item">ML Theory</span></span><span class="level-end"><span class="level-item tag">11</span></span></a><ul><li><a class="level is-mobile" href="/categories/ML-Theory/Loss/"><span class="level-start"><span class="level-item">Loss</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Theory/Model-Enhencement/"><span class="level-start"><span class="level-item">Model Enhencement</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Theory/Optimization/"><span class="level-start"><span class="level-item">Optimization</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Math-Algebra/"><span class="level-start"><span class="level-item">Math Algebra</span></span><span class="level-end"><span class="level-item tag">4</span></span></a><ul><li><a class="level is-mobile" href="/categories/Math-Algebra/Linear-Algebra/"><span class="level-start"><span class="level-item">Linear Algebra</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Math-Algebra/Universal-Algebra/"><span class="level-start"><span class="level-item">Universal Algebra</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Math-Analysis/"><span class="level-start"><span class="level-item">Math Analysis</span></span><span class="level-end"><span class="level-item tag">23</span></span></a><ul><li><a class="level is-mobile" href="/categories/Math-Analysis/Fourier-Analysis/"><span class="level-start"><span class="level-item">Fourier Analysis</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Math-Analysis/Functional-Analysis/"><span class="level-start"><span class="level-item">Functional Analysis</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Math-Analysis/Optimization/"><span class="level-start"><span class="level-item">Optimization</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile" href="/categories/Math-Analysis/Real-Analysis/"><span class="level-start"><span class="level-item">Real Analysis</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Math-Mixin/"><span class="level-start"><span class="level-item">Math Mixin</span></span><span class="level-end"><span class="level-item tag">18</span></span></a><ul><li><a class="level is-mobile" href="/categories/Math-Mixin/Statistics/"><span class="level-start"><span class="level-item">Statistics</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Math-Mixin/Time-Series/"><span class="level-start"><span class="level-item">Time Series</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Probability/"><span class="level-start"><span class="level-item">Probability</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">89</span></span></a><ul><li><a class="level is-mobile" href="/categories/Python/Cookbook/"><span class="level-start"><span class="level-item">Cookbook</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Jupyter/"><span class="level-start"><span class="level-item">Jupyter</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Keras/"><span class="level-start"><span class="level-item">Keras</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Matplotlib/"><span class="level-start"><span class="level-item">Matplotlib</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Numpy/"><span class="level-start"><span class="level-item">Numpy</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Pandas/"><span class="level-start"><span class="level-item">Pandas</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Py3Ref/"><span class="level-start"><span class="level-item">Py3Ref</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Py3std/"><span class="level-start"><span class="level-item">Py3std</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Pywin32/"><span class="level-start"><span class="level-item">Pywin32</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Readme/"><span class="level-start"><span class="level-item">Readme</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/TensorFlow/"><span class="level-start"><span class="level-item">TensorFlow</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Twists/"><span class="level-start"><span class="level-item">Twists</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/RLang/"><span class="level-start"><span class="level-item">RLang</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Rust/"><span class="level-start"><span class="level-item">Rust</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/Set/"><span class="level-start"><span class="level-item">Set</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Tool/"><span class="level-start"><span class="level-item">Tool</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/Tool/Editor/"><span class="level-start"><span class="level-item">Editor</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Tool/Markup-Language/"><span class="level-start"><span class="level-item">Markup Language</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Tool/Web-Browser/"><span class="level-start"><span class="level-item">Web Browser</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Tool/Windows/"><span class="level-start"><span class="level-item">Windows</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Web/"><span class="level-start"><span class="level-item">Web</span></span><span class="level-end"><span class="level-item tag">6</span></span></a><ul><li><a class="level is-mobile" href="/categories/Web/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/NPM/"><span class="level-start"><span class="level-item">NPM</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/Proxy/"><span class="level-start"><span class="level-item">Proxy</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/Thrift/"><span class="level-start"><span class="level-item">Thrift</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://octodex.github.com/images/hula_loop_octodex03.gif" alt="UBeaRLy"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">UBeaRLy</p><p class="is-size-6 is-block">Protector of Proxy</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Earth, Solar System</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">392</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">93</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">522</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/xyy15926" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/xyy15926"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-04T15:07:54.896Z">2021-08-04</time></p><p class="title"><a href="/uncategorized/README.html"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-03T07:46:51.000Z">2021-08-03</time></p><p class="title"><a href="/Web/NPM/hexo_config.html">Hexo 建站</a></p><p class="categories"><a href="/categories/Web/">Web</a> / <a href="/categories/Web/NPM/">NPM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-03T02:32:45.000Z">2021-08-03</time></p><p class="title"><a href="/Web/NPM/config.html">NPM 总述</a></p><p class="categories"><a href="/categories/Web/">Web</a> / <a href="/categories/Web/NPM/">NPM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-02T08:11:11.000Z">2021-08-02</time></p><p class="title"><a href="/Python/Py3std/internet_data.html">互联网数据</a></p><p class="categories"><a href="/categories/Python/">Python</a> / <a href="/categories/Python/Py3std/">Py3std</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-29T13:55:00.000Z">2021-07-29</time></p><p class="title"><a href="/Linux/Shell/sh_apps.html">Shell 应用程序</a></p><p class="categories"><a href="/categories/Linux/">Linux</a> / <a href="/categories/Linux/Shell/">Shell</a></p></div></article></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5385776267343559" data-ad-slot="6995841235" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="https://api.follow.it/subscription-form/WWxwMVBsOUtoNTdMSlJ4Z1lWVnRISERsd2t6ek9MeVpEUWs0YldlZGxUdXlKdDNmMEZVV1hWaFZFYWFSNmFKL25penZodWx3UzRiaVkxcnREWCtOYUJhZWhNbWpzaUdyc1hPangycUh5RTVjRXFnZnFGdVdSTzZvVzJBcTJHKzl8aXpDK1ROWWl4N080YkFEK3QvbEVWNEJuQjFqdWdxODZQcGNoM1NqbERXST0=/8" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="UBeaRLy" height="28"></a><p class="is-size-7"><span>&copy; 2021 UBeaRLy</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/xyy15926/proxy"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>