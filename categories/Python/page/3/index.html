<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Category: Python - UBeaRLy</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="UBeaRLy&#039;s Proxy"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="UBeaRLy&#039;s Proxy"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="UBeaRLy"><meta property="og:url" content="https://xyy15926.github.io/"><meta property="og:site_name" content="UBeaRLy"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://xyy15926.github.io/img/og_image.png"><meta property="article:author" content="UBeaRLy"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://xyy15926.github.io"},"headline":"UBeaRLy","image":["https://xyy15926.github.io/img/og_image.png"],"author":{"@type":"Person","name":"UBeaRLy"},"publisher":{"@type":"Organization","name":"UBeaRLy","logo":{"@type":"ImageObject","url":"https://xyy15926.github.io/img/logo.svg"}},"description":""}</script><link rel="alternate" href="/atom.xml" title="UBeaRLy" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/darcula.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600&amp;family=Roboto+Mono"><link rel="stylesheet" href="/css/cyberpunk.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><script data-ad-client="pub-5385776267343559" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><meta name="follow_it-verification-code" content="SVBypAPPHxjjr7Y4hHfn"><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="UBeaRLy" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Visit on GitHub" href="https://github.com/xyy15926/proxy"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">Categories</a></li><li class="is-active"><a href="#" aria-current="page">Python</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-08-19T09:13:00.000Z" title="8/19/2019, 5:13:00 PM">2019-08-19</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-08-19T09:13:00.000Z" title="8/19/2019, 5:13:00 PM">2019-08-19</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/TensorFlow/">TensorFlow</a></span><span class="level-item">5 minutes read (About 714 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/TensorFlow/tf_persistence.html">TensorFlow 持久化</a></h1><div class="content"><h2 id="Session-Checkpoint"><a href="#Session-Checkpoint" class="headerlink" title="Session Checkpoint"></a>Session Checkpoint</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">tf</span>.<span class="title">train</span>.<span class="title">Saver</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,</span></span></span><br><span class="line"><span class="params"><span class="function">		var_list=<span class="literal">None</span>/<span class="built_in">list</span>/<span class="built_in">dict</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		reshape=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		sharded=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		max_to_keep=<span class="number">5</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		keep_checkpoint_every_n_hours=<span class="number">10000.0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		name=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		restore_sequentially=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		saver_def=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		builder=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		defer_build=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		allow_empty=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		write_version=tf.train.SaverDef.V2,</span></span></span><br><span class="line"><span class="params"><span class="function">		pad_step_number=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		save_relative_paths=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		filename=<span class="literal">None</span></span></span></span><br><span class="line"><span class="params"><span class="function">	</span>):</span></span><br><span class="line">		self.last_checkpoints</span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：保存Session中变量（张量值），将变量名映射至张量值</p>
</li>
<li><p>参数</p>
<ul>
<li><code>var_list</code>：待保存、恢复变量，缺省所有<ul>
<li>变量需在<code>tf.train.Saver</code>实例化前创建</li>
</ul>
</li>
<li><code>reshape</code>：允许恢复并重新设定张量形状</li>
<li><code>sharded</code>：碎片化保存至多个设备</li>
<li><code>max_to_keep</code>：最多保存checkpoint数目</li>
<li><code>keep_checkpoint_every_n_hours</code>：checkpoint有效时间</li>
<li><code>restore_sequentially</code>：各设备中顺序恢复变量，可以
减少内存消耗</li>
</ul>
</li>
<li><p>成员</p>
<ul>
<li><code>last_checkpoints</code>：最近保存checkpoints</li>
</ul>
</li>
</ul>
<h3 id="保存Session"><a href="#保存Session" class="headerlink" title="保存Session"></a>保存Session</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Saver</span>.<span class="title">save</span>(<span class="params">self,</span></span></span><br><span class="line"><span class="params"><span class="function">	sess,</span></span></span><br><span class="line"><span class="params"><span class="function">	save_path,</span></span></span><br><span class="line"><span class="params"><span class="function">	global_step=<span class="literal">None</span>/<span class="built_in">str</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	latest_filename=<span class="literal">None</span>(<span class="params"><span class="string">&quot;checkpoint&quot;</span></span>)/<span class="built_in">str</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	meta_graph_suffix=<span class="string">&quot;meta&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	write_meta_graph=<span class="literal">True</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	write_state=<span class="literal">True</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) -&gt; <span class="built_in">str</span>(path):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：保存Session，要求变量已初始化</p>
</li>
<li><p>参数</p>
<ul>
<li><code>global_step</code>：添加至<code>save_path</code>以区别不同步骤</li>
<li><code>latest_filename</code>：checkpoint文件名</li>
<li><code>meta_graph_suffix</code>：MetaGraphDef文件名后缀</li>
</ul>
</li>
</ul>
<h3 id="恢复Session"><a href="#恢复Session" class="headerlink" title="恢复Session"></a>恢复Session</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Saver</span>.<span class="title">restore</span>(<span class="params">sess, save_path(<span class="params"><span class="built_in">str</span></span>)</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用途：从<code>save_path</code>指明的路径中恢复模型</li>
</ul>
<blockquote>
<ul>
<li>模型路径可以通过<code>Saver.last_checkpoints</code>属性、
  <code>tf.train.get_checkpoint_state()</code>函数获得</li>
</ul>
</blockquote>
<h3 id="tf-train-get-checkpoint-state"><a href="#tf-train-get-checkpoint-state" class="headerlink" title="tf.train.get_checkpoint_state"></a><code>tf.train.get_checkpoint_state</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def tf.train.get_checkpoint_state(</span><br><span class="line">	checkpoint_dir(str),</span><br><span class="line">	latest_filename=None</span><br><span class="line">):</span><br><span class="line">	pass</span><br></pre></td></tr></table></figure>
<ul>
<li>用途：获取指定checkpoint目录下checkpoint状态<ul>
<li>需要图结构已经建好、Session开启</li>
<li>恢复模型得到的变量无需初始化</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ckpt = tf.train.get_checkpoint_state(checkpoint_dir)</span><br><span class="line">saver.restore(ckpt.model_checkpoint_path)</span><br><span class="line">saver.restore(ckpt.all_model_checkpoint_paths[-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<h2 id="Graph-Saver"><a href="#Graph-Saver" class="headerlink" title="Graph Saver"></a>Graph Saver</h2><h3 id="tf-train-write-graph"><a href="#tf-train-write-graph" class="headerlink" title="tf.train.write_graph"></a><code>tf.train.write_graph</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tf</span>.<span class="title">train</span>.<span class="title">write_graph</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">	graph_or_graph_def: tf.Graph,</span></span></span><br><span class="line"><span class="params"><span class="function">	logdir: <span class="built_in">str</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	name: <span class="built_in">str</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	as_text=<span class="literal">True</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：存储图至文件中</p>
</li>
<li><p>参数</p>
<ul>
<li><code>as_text</code>：以ASCII方式写入文件</li>
</ul>
</li>
</ul>
<h2 id="Summary-Saver"><a href="#Summary-Saver" class="headerlink" title="Summary Saver"></a>Summary Saver</h2><h3 id="tf-summary-FileWriter"><a href="#tf-summary-FileWriter" class="headerlink" title="tf.summary.FileWriter"></a><code>tf.summary.FileWriter</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">tf</span>.<span class="title">summary</span>.<span class="title">FileWriter</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,</span></span></span><br><span class="line"><span class="params"><span class="function">		?path=<span class="built_in">str</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		graph=tf.Graph</span></span></span><br><span class="line"><span class="params"><span class="function">	</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">	# 添加<span class="title">summary</span>记录</span></span><br><span class="line"><span class="function">	<span class="title">def</span> <span class="title">add_summary</span>(<span class="params">self,</span></span></span><br><span class="line"><span class="params"><span class="function">		summary: OP,</span></span></span><br><span class="line"><span class="params"><span class="function">		global_step</span></span></span><br><span class="line"><span class="params"><span class="function">	</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 关闭`log`记录</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">close</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：创建<code>FileWriter</code>对象用于记录log</p>
<ul>
<li>存储图到<strong>文件夹</strong>中，文件名由TF自行生成</li>
<li>可通过TensorBoard组件查看生成的event log文件</li>
</ul>
</li>
<li><p>说明</p>
<ul>
<li>一般在图定义完成后、Session执行前创建<code>FileWriter</code>
对象，Session结束后关闭</li>
</ul>
</li>
</ul>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 创建自定义summary</span></span><br><span class="line"><span class="keyword">with</span> tf.name_scope(<span class="string">&quot;summaries&quot;</span>):</span><br><span class="line">	tf.summary.scalar(<span class="string">&quot;loss&quot;</span>, self.loss)</span><br><span class="line">	tf.summary.scalar(<span class="string">&quot;accuracy&quot;</span>, self.accuracy)</span><br><span class="line">	tf.summary.histogram(<span class="string">&quot;histogram loss&quot;</span>, self.loss)</span><br><span class="line">	summary_op = tf.summary.merge_all()</span><br><span class="line"></span><br><span class="line">saver = tf.train.Saver()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">	sess.run(tf.global_variables_initializer())</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 从checkpoint中恢复Session</span></span><br><span class="line">	ckpt = tf.train.get_check_state(os.path.dirname(<span class="string">&quot;checkpoint_dir&quot;</span>))</span><br><span class="line">	<span class="keyword">if</span> ckpt <span class="keyword">and</span> ckpt.model_check_path:</span><br><span class="line">		saver.restore(sess, ckpt.mode_checkpoint_path)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># summary存储图</span></span><br><span class="line">	writer = tf.summary.FileWriter(<span class="string">&quot;./graphs&quot;</span>, sess.graph)</span><br><span class="line">	<span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">		loas_batch, _, summary = session.run([loss, optimizer, summary_op])</span><br><span class="line">		writer.add_summary(summary, global_step=index)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (index + <span class="number">1</span>) % <span class="number">1000</span> = <span class="number">0</span>:</span><br><span class="line">			saver.save(sess, <span class="string">&quot;checkpoint_dir&quot;</span>, index)</span><br><span class="line"></span><br><span class="line"> <span class="comment"># 关闭`FileWriter`，生成event log文件</span></span><br><span class="line">write.close()</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-08-19T09:13:00.000Z" title="8/19/2019, 5:13:00 PM">2019-08-19</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-08-19T09:13:00.000Z" title="8/19/2019, 5:13:00 PM">2019-08-19</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/TensorFlow/">TensorFlow</a></span><span class="level-item">a few seconds read (About 26 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/TensorFlow/tf_train.html">TensorFlow训练</a></h1><div class="content"><h2 id="Optimizer"><a href="#Optimizer" class="headerlink" title="Optimizer"></a>Optimizer</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">tf</span>.<span class="title">train</span>.<span class="title">GradientDescentOptimizer</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">tf</span>.<span class="title">train</span>.<span class="title">AdagradOptimizer</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">tf</span>.<span class="title">train</span>.<span class="title">MomentumOptimizer</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">tf</span>.<span class="title">train</span>.<span class="title">AdamOptimizer</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">tf</span>.<span class="title">train</span>.<span class="title">FtrlOptimizer</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">tf</span>.<span class="title">train</span>.<span class="title">RMSPropOptmizer</span>:</span></span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-08-19T09:09:00.000Z" title="8/19/2019, 5:09:00 PM">2019-08-19</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-02T07:07:32.000Z" title="8/2/2021, 3:07:32 PM">2021-08-02</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/TensorFlow/">TensorFlow</a></span><span class="level-item">14 minutes read (About 2161 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/TensorFlow/tf_execution.html">TensorFlow执行</a></h1><div class="content"><h2 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h2><p><em>Session</em>：TF中OPs对象执行、Tensor对象计算的封装环境</p>
<ul>
<li><p>Session管理图、OPs</p>
<ul>
<li>所有图必须Session中执行</li>
<li>将图中OPs、其执行方法分发到CPU、GPU、TPU等设备上</li>
<li>为当前变量值分配内存</li>
</ul>
</li>
<li><p>Session只执行<em>Data/Tensor Flow</em>中OPs，忽略不相关节点</p>
<ul>
<li>即通往<code>fetches</code>的flow中的<strong>OPs构成子图</strong>才会被计算</li>
</ul>
</li>
<li><p>各Session中各值独立维护，不会相互影响</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,</span></span></span><br><span class="line"><span class="params"><span class="function">		target=<span class="built_in">str</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		graph=<span class="literal">None</span>/tf.Graph,</span></span></span><br><span class="line"><span class="params"><span class="function">		config=<span class="literal">None</span>/tf.ConfigProto</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">		# 获取<span class="title">Session</span>中载入图</span></span><br><span class="line"><span class="function">		<span class="title">self</span>.<span class="title">graph</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">	# 关闭会话，释放资源</span></span><br><span class="line"><span class="function">	<span class="title">def</span> <span class="title">close</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 支持上下文语法</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 执行TensorFlow中节点，获取`fetches`中节点值</span></span><br><span class="line">	<span class="comment"># 返回值若为Tensor</span></span><br><span class="line">		<span class="comment"># python中：以`np.ndarray`返回</span></span><br><span class="line">		<span class="comment"># C++/C中：以`tensorflow:Tensor`返回</span></span><br><span class="line">	<span class="comment"># 可直接调用`.eval()`获得单个OP值</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self,</span></span></span><br><span class="line"><span class="params"><span class="function">		fetches=tf.OPs/[tf.OPs],</span></span></span><br><span class="line"><span class="params"><span class="function">		feed_dict=<span class="literal">None</span>/<span class="built_in">dict</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		options=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		run_metadata=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>
<h3 id="tf-InteractiveSession"><a href="#tf-InteractiveSession" class="headerlink" title="tf.InteractiveSession"></a><code>tf.InteractiveSession</code></h3><p><code>tf.InteractiveSession</code>：开启交互式会话</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 开启交互式Session</span></span><br><span class="line">sess = tf.InteractiveSession()</span><br><span class="line">a = tf.constant(<span class="number">5.0</span>)</span><br><span class="line">b = tf.constant(<span class="number">6.0</span>)</span><br><span class="line">c = a * b</span><br><span class="line">x = tf.Variable([<span class="number">1.0</span>, <span class="number">2.0</span>])</span><br><span class="line"> <span class="comment"># 无需显式在`sess.run`中执行</span></span><br><span class="line"> <span class="comment"># 直接调用`OPs.eval/run()`方法得到结果</span></span><br><span class="line">x.initializer.run()</span><br><span class="line"><span class="built_in">print</span>(c.<span class="built_in">eval</span>())</span><br><span class="line">sess.close()</span><br></pre></td></tr></table></figure>
<h3 id="Session执行"><a href="#Session执行" class="headerlink" title="Session执行"></a>Session执行</h3><ul>
<li><p>Fetch机制：<code>sess.run()</code>执行图时，传入需<strong>取回</strong>的结果，
取回操作输出内容</p>
</li>
<li><p>Feed机制：通过<code>feed_dict</code>参数，使用自定义tensor值替代图
中任意feeable OPs的输出</p>
<ul>
<li><code>tf.placeholder()</code>表示创建占位符，执行Graph时必须
使用tensor替代</li>
<li><code>feed_dict</code>只是函数参数，只在调用它的方法内有效，
方法执行完毕则消失</li>
</ul>
</li>
<li><p>可以通过<code>feed_dict</code> feed所有feedable tensor，placeholder
只是指明必须给某些提供值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = tf.add(<span class="number">2</span>, <span class="number">5</span>)</span><br><span class="line">b = tf.multiply(a, <span class="number">3</span>)</span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">	sess.run(b, feed_dict=&#123;a: <span class="number">15</span>&#125;)			<span class="comment"># 45</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="config参数选项"><a href="#config参数选项" class="headerlink" title="config参数选项"></a><code>config</code>参数选项</h3><ul>
<li><code>log_device_placement</code>：打印每个操作所用设备</li>
<li><code>allow_soft_placement</code>：允许不在GPU上执行操作自动迁移到
CPU上执行</li>
<li><code>gpu_options</code><ul>
<li><code>allow_growth</code>：按需分配显存</li>
<li><code>per_process_gpu_memory_fraction</code>：指定每个GPU进程
使用显存比例（无法对单个GPU分别设置）</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>具体配置参见<code>tf.ConfigProto</code></li>
</ul>
</blockquote>
<h2 id="Graph"><a href="#Graph" class="headerlink" title="Graph"></a>Graph</h2><p><em>Graph</em>：表示TF中计算任务，</p>
<ul>
<li><p><em>operation/node</em>：Graph中节点，包括：<em>operator</em>、
<em>variable</em>、<em>constant</em></p>
<ul>
<li>获取一个、多个Tensor执行计算、产生、返回tensor</li>
<li>不能无法对其值直接进行访问、比较、操作</li>
<li>图中节点可以命名，TF会自动给未命名节点命名</li>
</ul>
</li>
<li><p><em>tensor</em>：Graph中边，n维数组</p>
<ul>
<li>TF中所有对象都是Operators</li>
<li>tensor是OPs执行结果，在图中传递/流动</li>
</ul>
</li>
<li><p>图计算模型优势</p>
<ul>
<li>优化能力强、节省计算资源<ul>
<li>缓冲自动重用</li>
<li>常量折叠，只计算取得目标值过程中必须计算的值</li>
<li>方便并行化</li>
<li>自动权衡计算、存储效率</li>
</ul>
</li>
<li>易于部署<ul>
<li>可被割成子图（即极大连通分量），便于自动区分</li>
<li>子图可以分发到不同的设备上分布式执行，即模型并行</li>
<li>许多通用ML模型是通过有向图教学、可视化的</li>
</ul>
</li>
</ul>
</li>
<li><p>图计算模型劣势</p>
<ul>
<li>难以debug<ul>
<li>图定义之后执行才会报错</li>
<li>无法通过pdb、打印状态debug</li>
</ul>
</li>
<li>语法繁复</li>
</ul>
</li>
</ul>
<h3 id="构建图"><a href="#构建图" class="headerlink" title="构建图"></a>构建图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Graph</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 将当前图作为默认图</span></span><br><span class="line">	<span class="comment"># 支持上下文语法</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">as_default</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 强制OPs依赖关系（图中未反映），即优先执行指定OPs</span></span><br><span class="line">	<span class="comment"># 支持上下文语法</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">as_default</span>(<span class="params">self</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">control_dependencies</span>(<span class="params">self,</span></span></span><br><span class="line"><span class="params"><span class="function">		?ops=[tf.OPs]</span>)</span></span><br><span class="line"><span class="function">		<span class="title">pass</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">	# 以<span class="title">ProtoBuf</span>格式展示<span class="title">Graph</span></span></span><br><span class="line"><span class="function">	<span class="title">def</span> <span class="title">as_graph_def</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 判断图中节点是否可以被feed</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">is_feedable</span>(<span class="params">self,</span></span></span><br><span class="line"><span class="params"><span class="function">		?op=tf.OPs</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>可以通过<code>tf.Graph</code>创建新图，但最好在是在一张图中使用多个
不相连的子图，而不是多张图</p>
<ul>
<li>充分性：Session执行图时忽略不必要的OPs</li>
<li>必要性<ul>
<li>多张图需要多个会话，每张图执行时默认尝试使用所有
可能资源</li>
<li>不能通过python/numpy在图间传递数据（分布式系统）</li>
</ul>
</li>
</ul>
</li>
<li><p>初始化即包含默认图，OP构造器默认为其增加节点</p>
<ul>
<li>通过<code>tf.get_default_graph()</code>获取</li>
</ul>
</li>
</ul>
<h3 id="图相关方法"><a href="#图相关方法" class="headerlink" title="图相关方法"></a>图相关方法</h3><ul>
<li><p>获取TF初始化的默认图</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tf</span>.<span class="title">get_default_graph</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 均支持、利用上下文语法，将OPs定义于其下</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tf</span>.<span class="title">name_scope</span>(<span class="params">name(<span class="params"><span class="built_in">str</span></span>)</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tf</span>.<span class="title">variable_scope</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">	name(<span class="params"><span class="built_in">str</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="function">	reuse=tf.AUTO_REUSE</span></span></span><br><span class="line"><span class="params"><span class="function"></span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>tf.name_scope</code>：将变量分组<ul>
<li>只是将变量打包，不影响变量的重用、可见性等</li>
<li>方便管理、查看graph</li>
</ul>
</li>
<li><code>tf.variable_scope</code>：<ul>
<li>对变量有控制能力<ul>
<li>可设置变量重用性</li>
<li>变量可见性局限于该<em>variable scope</em>内，即不同
variable scope间可以有完全同名变量
（未被TF添加顺序后缀）</li>
</ul>
</li>
<li>会隐式创建<em>name scope</em></li>
<li>大部分情况是用于实现变量共享</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fully_connected</span>(<span class="params">x, output_dim, scope</span>):</span></span><br><span class="line">	<span class="comment"># 设置variable scope中变量自动重用</span></span><br><span class="line">	<span class="comment"># 或者调用`scope.reuse_variables()`声明变量可重用</span></span><br><span class="line">	<span class="keyword">with</span> tf.variable_scope(scope, reuse=tf.AUTO_REUSE) <span class="keyword">as</span> scope:</span><br><span class="line">		<span class="comment"># 在当前variable scope中获取、创建变量</span></span><br><span class="line">		w = tf.get_variable(<span class="string">&quot;weights&quot;</span>, [x.shape[<span class="number">1</span>]], output_dim,</span><br><span class="line">							initializer=tf.random_normal_initializer())</span><br><span class="line">		b = tf.get_variable(<span class="string">&quot;biases&quot;</span>, [output_dim],</span><br><span class="line">							initializer=tf.constant_initizer(<span class="number">0.0</span>))</span><br><span class="line">		<span class="keyword">return</span> tf.matmul(x, w) + b</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">two_hidden_layers</span>(<span class="params">x</span>):</span></span><br><span class="line">	h1 = fully_connected(x, <span class="number">50</span>, <span class="string">&quot;h1&quot;</span>)</span><br><span class="line">	h2 =-fully_connected(h1, <span class="number">10</span>, <span class="string">&quot;h2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.variable_scope(<span class="string">&quot;two_layers&quot;</span>) <span class="keyword">as</span> scope:</span><br><span class="line">	logits1 = two_hidden_layers(x1)</span><br><span class="line">	logits2 = two_hidden_layers(x2)</span><br></pre></td></tr></table></figure>
<h3 id="Lazy-Loading"><a href="#Lazy-Loading" class="headerlink" title="Lazy Loading"></a>Lazy Loading</h3><p><em>Lazy Loading</em>：推迟声明/初始化OP对象至载入图时
（不是指TF的延迟计算，是个人代码结构问题，虽然是TF延迟图计算
模型的结果）</p>
<ul>
<li><p>延迟加载容易导致向图中添加大量重复节点，影响图的载入、
传递</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">x = tf.Variable(<span class="number">10</span>, name=<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">y = tf.Variable(<span class="number">20</span>, name=<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">	sess.run(tf.global_variables_initializer())</span><br><span class="line">	writer = tf.summary.FileWriter(<span class="string">&#x27;graphs/lazy_loading&#x27;</span>, sess.graph)</span><br><span class="line">	<span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">		<span class="comment"># 延迟加载节点，每次执行都会添加`tf.add`OP</span></span><br><span class="line">		sess.run(tf.add(x, y))</span><br><span class="line">	<span class="built_in">print</span>(tf.get_default_graph().as_graph_def())</span><br><span class="line">	writer.close()</span><br></pre></td></tr></table></figure>
</li>
<li><p>解决方案</p>
<ul>
<li>总是把（图的搭建）OPs的定义、执行分开</li>
<li>python利用<code>@property</code>装饰器，使用<strong>单例模式函数</strong>
封装变量控制，保证仅首次调用函数时才创建OP</li>
</ul>
</li>
</ul>
<h2 id="Eager-Execution"><a href="#Eager-Execution" class="headerlink" title="Eager Execution"></a>Eager Execution</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> tensorflow.contrib.eager <span class="keyword">as</span> tfe</span><br><span class="line"> <span class="comment"># 启用TF eager execution</span></span><br><span class="line">tfe.enable_eager_execution()</span><br></pre></td></tr></table></figure>
<ul>
<li><p>优势</p>
<ul>
<li>支持python debug工具</li>
<li>提供实时报错</li>
<li>支持python数据结构</li>
<li><p>支持pythonic的控制流</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">i = tf.constant(<span class="number">0</span>)</span><br><span class="line">whlile i &lt; <span class="number">1000</span>:</span><br><span class="line">	i = tf.add(i, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>eager execution开启后</p>
<ul>
<li>tensors行为类似<code>np.ndarray</code></li>
<li>大部分API和未开启同样工作，倾向于使用<ul>
<li><code>tfe.Variable</code></li>
<li><code>tf.contrib.summary</code></li>
<li><code>tfe.Iterator</code></li>
<li><code>tfe.py_func</code></li>
<li>面向对象的layers</li>
<li>需要自行管理变量存储</li>
</ul>
</li>
</ul>
</li>
<li><p>eager execution和graph大部分兼容</p>
<ul>
<li>checkpoint兼容</li>
<li>代码可以同时用于python过程、构建图</li>
<li>可使用<code>@tfe.function</code>将计算编译为图</li>
</ul>
</li>
</ul>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><ul>
<li><p>placeholder、sessions</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 普通TF</span></span><br><span class="line">x = tf.placholder(tf.float32, shape=[<span class="number">1</span>, <span class="number">1</span>])</span><br><span class="line">m = tf.matmul(x, x)</span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">	m_out = sess.run(m, feed_dict=&#123;x: [[<span class="number">2.</span>]]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Eager Execution</span></span><br><span class="line">x = [[<span class="number">2.</span>]]</span><br><span class="line">m = tf.matmul(x, x)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Lazy loading</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x = tf.random_uniform([<span class="number">2</span>, <span class="number">2</span>])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(x.shape[<span class="number">0</span>]):</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(x.shape[<span class="number">1</span>]):</span><br><span class="line">		<span class="comment"># 不会添加多个节点</span></span><br><span class="line">		<span class="built_in">print</span>(x[i, j])</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Device"><a href="#Device" class="headerlink" title="Device"></a>Device</h2><h3 id="设备标识"><a href="#设备标识" class="headerlink" title="设备标识"></a>设备标识</h3><ul>
<li><p>设备标识：设备使用字符串进行标识</p>
<ul>
<li><code>/cpu:0</code>：所有CPU都以此作为名称</li>
<li><code>/gpu:0</code>：第一个GPU，如果有</li>
<li><code>/gpu:1</code>：第二个GPU</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为计算指定硬件资源</span></span><br><span class="line"><span class="keyword">with</span> tf.device(<span class="string">&quot;/gpu:2&quot;</span>):</span><br><span class="line">	a = tf.constant([<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>, <span class="number">5.0</span>], name=<span class="string">&quot;a&quot;</span>)</span><br><span class="line">	b = tf.constant([<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>, <span class="number">5.0</span>], name=<span class="string">&quot;b&quot;</span>)</span><br><span class="line">	c = tf.multiply(a, b)</span><br><span class="line">	<span class="comment"># creates a graph</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>环境变量：python中既可以修改<code>os.environ</code>，也可以直接设置
中设置环境变量</p>
<ul>
<li><code>CUDA_VISIBLE_DEVICES</code>：可被使用的GPU id</li>
</ul>
</li>
</ul>
<h3 id="设备执行"><a href="#设备执行" class="headerlink" title="设备执行"></a>设备执行</h3><p>设备执行：TF将图形定义转换成分布式执行的操作以充分利用计算
资源</p>
<ul>
<li><p>TF默认自动检测硬件配置，尽可能使用找到首个GPU执行操作</p>
</li>
<li><p>TF会默认占用所有GPU及每个GPU的所有显存（可配置）</p>
<ul>
<li>但只有一个GPU参与计算，其他GPU默认不参与计算（显存
仍然被占用），需要明确将OPs指派给其执行</li>
<li>指派GPU数量需通过设置环境变量实现</li>
<li>控制显存占用需设置Session <code>config</code>参数</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>注意：有些操作不能再GPU上完成，手动指派计算设备需要注意</li>
</ul>
</blockquote>
<h2 id="tf-ConfigProto"><a href="#tf-ConfigProto" class="headerlink" title="tf.ConfigProto"></a><code>tf.ConfigProto</code></h2><ul>
<li><p>Session参数配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># `tf.ConfigProto`配置方法</span></span><br><span class="line">conf = tf.ConfigProto(log_device_placement=<span class="literal">True</span>)</span><br><span class="line">conf.gpu_options.allow_growth=<span class="literal">True</span></span><br><span class="line">sess = tf.Session(config=conf)</span><br><span class="line">sess.close()</span><br></pre></td></tr></table></figure>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-07-31T17:38:59.000Z" title="8/1/2019, 1:38:59 AM">2019-08-01</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-07-31T17:38:59.000Z" title="8/1/2019, 1:38:59 AM">2019-08-01</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3Ref/">Py3Ref</a></span><span class="level-item">22 minutes read (About 3283 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3Ref/lexical_analysis.html">Lexical Analysis</a></h1><div class="content"><ul>
<li>python将读取的程序问题转换为Unicode码点<ul>
<li>源文件的文本编码可由编码声明指定</li>
<li>默认<em>UTF-8</em></li>
</ul>
</li>
<li>词法分析器将文件拆分为token</li>
<li>解释器以词法分析器生成的token流作为输入</li>
</ul>
<h2 id="行结构"><a href="#行结构" class="headerlink" title="行结构"></a>行结构</h2><h3 id="逻辑行"><a href="#逻辑行" class="headerlink" title="逻辑行"></a>逻辑行</h3><p>逻辑行：逻辑行的结束以<code>NEWLINE</code> token表示</p>
<ul>
<li>语句不能跨越逻辑行边集，除非其语法允许包含<code>NEWLINE</code>
（如复合语句包含多个子语句）</li>
<li>逻辑行可由一个、多个物理行按照明确、隐含行拼接规则
构成</li>
</ul>
<blockquote>
<p>python程序可以分为很多逻辑行</p>
</blockquote>
<h3 id="物理行"><a href="#物理行" class="headerlink" title="物理行"></a>物理行</h3><p>物理行：以行终止序列结束的字符序列</p>
<ul>
<li>源文件、字符串中可以使用任何标准平台上行终止序列<ul>
<li>Unix：<code>\n</code>换行符<code>LF</code></li>
<li>Win：<code>\r\n</code>回车加换行<code>CR LF</code></li>
<li>Macintosh：<code>\r</code>回车<code>CR</code></li>
</ul>
</li>
<li>输入结束会被作为最后物理行的隐含终止标志</li>
</ul>
<blockquote>
<ul>
<li>嵌入Python源码字符串应使用标准C传统换行符<code>\n</code></li>
</ul>
</blockquote>
<h4 id="显式行拼接"><a href="#显式行拼接" class="headerlink" title="显式行拼接"></a>显式行拼接</h4><p>显式行拼接：两个、多个物理行使用<code>\</code>拼接为一个逻辑行</p>
<ul>
<li>物理行以<strong>不在字符串、注释内</strong>的反斜杠结尾时，将与下行
拼接构成一个单独逻辑行<ul>
<li>反斜杠、其后换行符将被删除</li>
</ul>
</li>
<li>以反斜杠结束的行不能带有注释</li>
<li>反斜杠不能用于<ul>
<li>拼接注释</li>
<li>拼接字符串外token</li>
</ul>
</li>
<li>不允许原文字符串以外反斜杠存在于物理行其他位置</li>
</ul>
<h4 id="隐式行拼接"><a href="#隐式行拼接" class="headerlink" title="隐式行拼接"></a>隐式行拼接</h4><p>隐式行拼接</p>
<ul>
<li><p>圆括号、方括号、花括号内表达式允许被分为多个物理行，无需
使用反斜杠</p>
<ul>
<li>拼接行可以带有注释</li>
<li>后续行缩进不影响程序结构、允许为空白行</li>
<li>拼接行之间不会有<code>NEWLINE</code> token</li>
</ul>
</li>
<li><p>三引号<code>&quot;&quot;&quot;</code>/<code>&#39;&#39;&#39;</code>字符串允许被分为多个物理行</p>
<ul>
<li>拼接行中不允许带有注释</li>
</ul>
</li>
</ul>
<h4 id="空白行"><a href="#空白行" class="headerlink" title="空白行"></a>空白行</h4><p>空白行：只包含空格符、制表符、进纸符、注释的逻辑行会被忽略，
不生成<code>NEWLINE</code> token</p>
<ul>
<li><p>交互式输入语句时，对空白行处理可能因为读取-求值-打印循环
的<strong>具体实现</strong>而存在差异</p>
<ul>
<li>标准交互模式解释器中：完全空白逻辑行将会结束一条多行
复合语句</li>
</ul>
</li>
</ul>
<h4 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h4><p>注释：一不包含在字符串内的<code>#</code>开头，在物理行末尾结束</p>
<ul>
<li>注释标志逻辑行的结束，除非存在隐含行拼接规则</li>
<li>注释在语法分析中被忽略，不属于token</li>
</ul>
<h3 id="编码声明"><a href="#编码声明" class="headerlink" title="编码声明"></a>编码声明</h3><p>编码声明：位于python脚本第一、第二行，匹配正则表达式
<code>coding[=:]\s*([-\w.]+)</code>的注释将被作为编码声明处理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: &lt;encoding-name&gt; -*-</span></span><br></pre></td></tr></table></figure>
<ul>
<li>表达式第一组指定了源码文件编码<ul>
<li>编码声明指定编码名称必须是python所认可的编码</li>
<li>词法分析将使用此编码：语义字符串、注释、标识符</li>
</ul>
</li>
<li>编码声明须独占一行，若在第二行，则第一行也必须为注释</li>
<li>没有编码声明，默认编码为<em>UTF-8</em><ul>
<li>若文件首字节为<em>UTF-8</em>字节顺序标志<code>b\xef\xbb\xbf</code>，
文件编码也声明为<em>UTF-8</em></li>
</ul>
</li>
</ul>
<h3 id="缩进"><a href="#缩进" class="headerlink" title="缩进"></a>缩进</h3><p>缩进：<strong>逻辑行开头</strong>的空白（空格符、制表符）被用于计算该行
的缩进等级，决定语句段落组织结构</p>
<ul>
<li>首个非空白字符之前的空格总数确定该行的缩进层次<ul>
<li>缩进不能使用反斜杠进行拼接，首个反斜杠之前空格将确定
缩进层次</li>
</ul>
</li>
<li>制表符被替换为1-8个空白，使得缩进的空格总数为8倍数<ul>
<li>源文件若混合使用制表符、空格符缩进，并使得确定缩进
层次需要依赖于制表符对应空格数量设置，将引发
<code>TabError</code></li>
<li>由于非Unix平台上文本编辑器本身特性，源文件中混合使用
制表符、空格符是不明智的</li>
</ul>
</li>
<li>进纸符<ul>
<li>在行首时：在缩进层级计算中被忽略</li>
<li>行首空格内其他位置：效果未定义，可能导致空格计数重置
为0</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>不同平台可能会显式限制最大缩进层级</li>
</ul>
</blockquote>
<h4 id="INDENT-DEDENT-token"><a href="#INDENT-DEDENT-token" class="headerlink" title="INDENT/DEDENT token"></a><code>INDENT</code>/<code>DEDENT</code> token</h4><ul>
<li>读取文件第一行前，向堆栈中压入零值，不再弹出</li>
<li>被压入栈的层级数值从底至顶持续增加</li>
<li>每个逻辑行开头的行缩进层级将和栈顶进行比较<ul>
<li>相同：不做处理</li>
<li>新行层级较高：压入栈中，生成<code>INDENT</code> token</li>
<li>新行层级较低：应为栈中层级数值之一<ul>
<li>栈中高于该层级所有数值被弹出</li>
<li>每弹出一级数值生成一个<code>DEDENT</code> token</li>
</ul>
</li>
</ul>
</li>
<li>文件末尾，栈中剩余每个大于0数值生成一个<code>DEDENT</code> token</li>
</ul>
<h2 id="Tokens"><a href="#Tokens" class="headerlink" title="Tokens"></a>Tokens</h2><p>型符</p>
<ul>
<li>空白字符不属于token<ul>
<li>除逻辑行开头、字符串内，空格符、制表符、进纸符等
空白符均可分隔token</li>
<li>否则彼此相连的token会被解析为一个不同的token</li>
</ul>
</li>
<li>若存在二义性，将从左至右尽可能长读取合法字符串组成token</li>
</ul>
<h3 id="Indentifiers"><a href="#Indentifiers" class="headerlink" title="Indentifiers"></a>Indentifiers</h3><p>标识符/名称：python标识符语法基于Unicode标准附件UAX-31，有
修改</p>
<ul>
<li><p>ASCII字符集内可用于标识符与py2一致</p>
<ul>
<li>大、小写字母</li>
<li>下划线<code>_</code></li>
<li>数字<code>0-9</code></li>
</ul>
</li>
<li><p>py3中引入ASCII字符集以外的额外字符</p>
<ul>
<li>其分类使用包含于<code>unicodedata</code>模块中Unicode字符数据库
版本</li>
</ul>
</li>
<li><p>标识符没有长度限制、大小写敏感</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">identifier   ::=  xid_start xid_continue*</span><br><span class="line">id_start     ::=  &lt;all characters in general categories Lu, Ll, Lt, Lm, Lo, Nl, the underscore, and characters with the Other_ID_Start property&gt;</span><br><span class="line">id_continue  ::=  &lt;all characters in id_start, plus characters in the categories Mn, Mc, Nd, Pc and others with the Other_ID_Continue property&gt;</span><br><span class="line">xid_start    ::=  &lt;all characters in id_start whose NFKC normalization is in &quot;id_start xid_continue*&quot;&gt;</span><br><span class="line">xid_continue ::=  &lt;all characters in id_continue whose NFKC normalization is in &quot;id_continue*&quot;&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>Lu</code>：大写字母</li>
<li><code>Ll</code>：小写字母</li>
<li><code>Lt</code>：词首大写字母</li>
<li><code>Lm</code>：修饰字母</li>
<li><code>Lo</code>：其他字母</li>
<li><code>Nl</code>：字母数字</li>
<li><code>Mn</code>：非空白标识</li>
<li><code>Mc</code>：含空白标识</li>
<li><code>Nd</code>：十进制数字</li>
<li><code>Pc</code>：连接标点</li>
<li><code>Other_ID_Start</code>：由<code>PropList.txt</code>定义的显式字符列表，
  用来支持向后兼容</li>
<li><code>Other_ID_Continue</code>：同上</li>
</ul>
</blockquote>
<h4 id="Keywords"><a href="#Keywords" class="headerlink" title="Keywords"></a>Keywords</h4><p>关键字：以下标识符作为语言的保留字、关键字，不能用作普通
标识符</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">False      await      else       import     pass</span><br><span class="line">None       break      except     in         raise</span><br><span class="line">True       class      finally    is         return</span><br><span class="line">and        continue   for        lambda     try</span><br><span class="line">as         def        from       nonlocal   while</span><br><span class="line">assert     del        global     not        with</span><br><span class="line">async      elif       if         or         yield</span><br></pre></td></tr></table></figure>
<h4 id="保留标识符类"><a href="#保留标识符类" class="headerlink" title="保留标识符类"></a>保留标识符类</h4><p>以下划线字符开头、结尾的标识符类：具有特殊函数</p>
<ul>
<li><p><code>_*</code>：不会被<code>from module import *</code>导入</p>
<ul>
<li>特殊标识符<code>_</code>：交互式解释器中用于存放最近一次求值
结果，不处于交互模式时无特殊含义、无预定义</li>
</ul>
</li>
<li><p><code>__*__</code>：系统定义名称</p>
<ul>
<li>由解释器极其实现（包括标准库）定义</li>
<li>任何不遵循文档指定方式使用<code>__*__</code>行为可能导致无警告
出错</li>
</ul>
</li>
<li><p><code>__*</code>：类私有名称</p>
<ul>
<li>在类定义中使用</li>
<li>会以<strong>混合形式</strong>重写避免基类、派生类私有属性之间出现
名称冲突</li>
</ul>
</li>
</ul>
<h3 id="字面值"><a href="#字面值" class="headerlink" title="字面值"></a>字面值</h3><p>字面值：表示一些内置类型常量</p>
<h4 id="字符串、字节串字面值"><a href="#字符串、字节串字面值" class="headerlink" title="字符串、字节串字面值"></a>字符串、字节串字面值</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">stringliteral   ::=  [stringprefix](shortstring | longstring)</span><br><span class="line">stringprefix    ::=  &quot;r&quot; | &quot;u&quot; | &quot;R&quot; | &quot;U&quot; | &quot;f&quot; | &quot;F&quot;</span><br><span class="line">                     | &quot;fr&quot; | &quot;Fr&quot; | &quot;fR&quot; | &quot;FR&quot; | &quot;rf&quot; | &quot;rF&quot; | &quot;Rf&quot; | &quot;RF&quot;</span><br><span class="line">shortstring     ::=  &quot;&#x27;&quot; shortstringitem* &quot;&#x27;&quot; | &#x27;&quot;&#x27; shortstringitem* &#x27;&quot;&#x27;</span><br><span class="line">longstring      ::=  &quot;&#x27;&#x27;&#x27;&quot; longstringitem* &quot;&#x27;&#x27;&#x27;&quot; | &#x27;&quot;&quot;&quot;&#x27; longstringitem* &#x27;&quot;&quot;&quot;&#x27;</span><br><span class="line">shortstringitem ::=  shortstringchar | stringescapeseq</span><br><span class="line">longstringitem  ::=  longstringchar | stringescapeseq</span><br><span class="line">shortstringchar ::=  &lt;any source character except &quot;\&quot; or newline or the quote&gt;</span><br><span class="line">longstringchar  ::=  &lt;any source character except &quot;\&quot;&gt;</span><br><span class="line">stringescapeseq ::=  &quot;\&quot; &lt;any source character&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bytesliteral   ::=  bytesprefix(shortbytes | longbytes)</span><br><span class="line">bytesprefix    ::=  &quot;b&quot; | &quot;B&quot; | &quot;br&quot; | &quot;Br&quot; | &quot;bR&quot; | &quot;BR&quot; | &quot;rb&quot; | &quot;rB&quot; | &quot;Rb&quot; | &quot;RB&quot;</span><br><span class="line">shortbytes     ::=  &quot;&#x27;&quot; shortbytesitem* &quot;&#x27;&quot; | &#x27;&quot;&#x27; shortbytesitem* &#x27;&quot;&#x27;</span><br><span class="line">longbytes      ::=  &quot;&#x27;&#x27;&#x27;&quot; longbytesitem* &quot;&#x27;&#x27;&#x27;&quot; | &#x27;&quot;&quot;&quot;&#x27; longbytesitem* &#x27;&quot;&quot;&quot;&#x27;</span><br><span class="line">shortbytesitem ::=  shortbyteschar | bytesescapeseq</span><br><span class="line">longbytesitem  ::=  longbyteschar | bytesescapeseq</span><br><span class="line">shortbyteschar ::=  &lt;any ASCII character except &quot;\&quot; or newline or the quote&gt;</span><br><span class="line">longbyteschar  ::=  &lt;any ASCII character except &quot;\&quot;&gt;</span><br><span class="line">bytesescapeseq ::=  &quot;\&quot; &lt;any ASCII character&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>stringprefix</code>、<code>bytesprefix</code>与字面值剩余部分之间不允许
  由空白符</li>
<li>源字符集由编码声明定义</li>
<li>字节串字面值只允许ASCII字符（但允许存储不大于256）</li>
</ul>
</blockquote>
<ul>
<li><p>两种字面值都可以使用成对（连续三个）单引号、双引号标示
首尾</p>
<ul>
<li>单引号<code>&#39;&#39;</code>：允许包含双引号<code>&quot;&quot;</code></li>
<li>双引号<code>&quot;&quot;</code>：允许包含单引号<code>&#39;&#39;</code></li>
<li>三重引号<code>&#39;&#39;&#39;</code>、<code>&quot;&quot;&quot;</code><ul>
<li>原样保留：未经转义的换行、（非三联）引号、空白符</li>
</ul>
</li>
</ul>
</li>
<li><p>反斜杠<code>\</code>用于对特殊含义字符进行转义</p>
</li>
</ul>
<h5 id="字符串前缀"><a href="#字符串前缀" class="headerlink" title="字符串前缀"></a>字符串前缀</h5><ul>
<li><p><code>b</code>/<code>B</code>前缀：字节串字面值</p>
<ul>
<li>创建<code>bytes</code>类型而非<code>str</code>类型实例</li>
<li>只能包含ASCII字符</li>
<li>字节对应数值大于128必须以转义形式表示</li>
</ul>
</li>
<li><p><code>r</code>/<code>R</code>：原始字符串/字节串</p>
<ul>
<li>其中反斜杠<code>\</code>被当作其本身字面字符处理</li>
<li>转换序列不在有效</li>
<li>原始字面值不能以单个<code>\</code>结束，会转义之后引号字符</li>
</ul>
</li>
<li><p><code>f</code>/<code>F</code>：格式化字符串字面值</p>
</li>
</ul>
<h5 id="转义规则"><a href="#转义规则" class="headerlink" title="转义规则"></a>转义规则</h5><ul>
<li><p>字符串、字节串字面值中转义序列基本类似标准C转义规则</p>
<ul>
<li><code>\xhh</code>：必须接受2个16进制数码</li>
</ul>
</li>
<li><p>以下转义序列仅在字符串字面值中可用</p>
<ul>
<li><code>\N&#123;name&#125;</code>：Unicode数据库中名称为name的字符</li>
<li><code>\uxxxx</code>：必须接受4个16进制数码</li>
<li><code>\Uxxxxxxxx</code>：必须接受8个16进制数码</li>
</ul>
</li>
<li><p>无法识别的转义序列</p>
<ul>
<li>py3.6之前将原样保留在字符串中</li>
<li>py3.6开始，将引发<code>DeprecationWarning</code>，未来可能会
引发<code>SyntaxError</code></li>
</ul>
</li>
</ul>
<h5 id="字符串字面值拼接"><a href="#字符串字面值拼接" class="headerlink" title="字符串字面值拼接"></a>字符串字面值拼接</h5><ul>
<li><p>多个相邻字符串、字符串字面值（空白符分隔），含义等同于
全部拼接为一体</p>
<ul>
<li>所用引号可以彼此不同（三引号风格也可用）</li>
<li>每部分字符串可以分别加注释</li>
<li>可以包括格式化字符串字面值</li>
</ul>
</li>
<li><p>此特性是在<strong>句法层面定义</strong>，在编译时实现</p>
<ul>
<li>在运行时拼接字符串表达式必须使用<code>+</code>运算符</li>
</ul>
</li>
</ul>
<h5 id="格式化字符串字面值"><a href="#格式化字符串字面值" class="headerlink" title="格式化字符串字面值"></a>格式化字符串字面值</h5><p>格式化字符串字面值：带有<code>f/F</code>前缀的字符串字面值</p>
<ul>
<li><p>包含可替换字段，即以<code>&#123;&#125;</code>标示的格式表达式</p>
<ul>
<li>字符串<code>&#123;&#125;</code>以外部分按字面值处理</li>
<li>双重花括号<code>&#123; &#123; &#125; &#125;</code>被替换为相应单个花括号</li>
</ul>
</li>
<li><p>格式表达式<strong>被当作正常的包含在圆括号中python表达式</strong>处理
，在运行时从左至右被求值</p>
<ul>
<li>不允许空表达式</li>
<li><code>lambda</code>空表达式必须显式加上圆括号</li>
<li>可以包含换行：如三引号字符串</li>
<li>不能包含注释</li>
<li>不能<code>\</code>反斜杠，考虑创建临时变量</li>
</ul>
</li>
<li><p>格式化字符串字面值可以拼接，但是一个替换字段不能拆分到
多个字面值中</p>
</li>
<li><p>格式化字符串不能用作文档字符串，即使其中没有包含表达式</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">f_string          ::=  (literal_char | &quot;&#123;&#123;&quot; | &quot;&#125;&#125;&quot; | replacement_field)*</span><br><span class="line">replacement_field ::=  &quot;&#123;&quot; f_expression [&quot;!&quot; conversion] [&quot;:&quot; format_spec] &quot;&#125;&quot;</span><br><span class="line">f_expression      ::=  (conditional_expression | &quot;*&quot; or_expr)</span><br><span class="line">                         (&quot;,&quot; conditional_expression | &quot;,&quot; &quot;*&quot; or_expr)* [&quot;,&quot;]</span><br><span class="line">                       | yield_expression</span><br><span class="line">conversion        ::=  &quot;s&quot; | &quot;r&quot; | &quot;a&quot;</span><br><span class="line">format_spec       ::=  (literal_char | NULL | replacement_field)*</span><br><span class="line">literal_char      ::=  &lt;any code point except &quot;&#123;&quot;, &quot;&#125;&quot; or NULL&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>!</code>：标识转换字段</p>
<ul>
<li><code>!s</code>：对结果调用<code>str()</code></li>
<li><code>!r</code>：调用<code>repr()</code></li>
<li><code>!a</code>：调用<code>ascii()</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">name = <span class="string">&quot;Fred&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;he said his name is <span class="subst">&#123;name!r&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;he said his name is &#123;repr(name)&#125;&quot;</span>)</span><br><span class="line">	<span class="comment"># 二者等价</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>:</code>：标识格式说明符，结果使用<code>format()</code>协议格式化</p>
<ul>
<li>格式说明符被传入表达式或转换结果的<code>.__format__()</code>
方法</li>
<li>省略格式说明符则传入空字符串</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">width, precision = <span class="number">4</span>, <span class="number">10</span></span><br><span class="line">value = decimal.Deciaml(<span class="string">&quot;12.345&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;result: <span class="subst">&#123;value: &#123;width&#125;</span>.<span class="subst">&#123;precision&#125;</span>&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">today = datetime(yeat=<span class="number">2017</span>, month=<span class="number">1</span>, day=<span class="number">27</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;today: %B %d, %Y&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">number = <span class="number">1024</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;number: #0x&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>顶层格式说明符可以包含嵌套替换字段</p>
<ul>
<li>嵌套字段可以包含有自身的转换字段、格式说明符，但不能
包含更深层嵌套替换字段</li>
</ul>
</li>
</ul>
<h4 id="数字字面值"><a href="#数字字面值" class="headerlink" title="数字字面值"></a>数字字面值</h4><ul>
<li>数字字面值不包括正负号<ul>
<li>负数实际上是由单目运算符<code>-</code>和字面值组合而成</li>
</ul>
</li>
<li>没有专门复数字面值<ul>
<li>复数以一对浮点数表示</li>
<li>取值范围同浮点数</li>
</ul>
</li>
<li>数字字面值可以使用下划线<code>_</code>将数码分组提高可读性<ul>
<li>确定数字大小时，字面值之间的下滑线被忽略</li>
<li>下划线可以放在数码之间、基数说明符<code>0x</code>等之后</li>
<li>浮点数中不能直接放在<code>.</code>后</li>
</ul>
</li>
</ul>
<h5 id="整形数字字面值"><a href="#整形数字字面值" class="headerlink" title="整形数字字面值"></a>整形数字字面值</h5><ul>
<li>整形数字字面值没有长度限制，只受限于内存</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">integer      ::=  decinteger | bininteger | octinteger | hexinteger</span><br><span class="line">decinteger   ::=  nonzerodigit ([&quot;_&quot;] digit)* | &quot;0&quot;+ ([&quot;_&quot;] &quot;0&quot;)*</span><br><span class="line">bininteger   ::=  &quot;0&quot; (&quot;b&quot; | &quot;B&quot;) ([&quot;_&quot;] bindigit)+</span><br><span class="line">octinteger   ::=  &quot;0&quot; (&quot;o&quot; | &quot;O&quot;) ([&quot;_&quot;] octdigit)+</span><br><span class="line">hexinteger   ::=  &quot;0&quot; (&quot;x&quot; | &quot;X&quot;) ([&quot;_&quot;] hexdigit)+</span><br><span class="line">nonzerodigit ::=  &quot;1&quot;...&quot;9&quot;</span><br><span class="line">digit        ::=  &quot;0&quot;...&quot;9&quot;</span><br><span class="line">bindigit     ::=  &quot;0&quot; | &quot;1&quot;</span><br><span class="line">octdigit     ::=  &quot;0&quot;...&quot;7&quot;</span><br><span class="line">hexdigit     ::=  digit | &quot;a&quot;...&quot;f&quot; | &quot;A&quot;...&quot;F&quot;</span><br></pre></td></tr></table></figure>
<h5 id="浮点数字字面值"><a href="#浮点数字字面值" class="headerlink" title="浮点数字字面值"></a>浮点数字字面值</h5><ul>
<li>整形数部分、指数部分解析时总以10为计数</li>
<li>浮点数字面值允许范围依赖于具体实现</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">floatnumber   ::=  pointfloat | exponentfloat</span><br><span class="line">pointfloat    ::=  [digitpart] fraction | digitpart &quot;.&quot;</span><br><span class="line">exponentfloat ::=  (digitpart | pointfloat) exponent</span><br><span class="line">digitpart     ::=  digit ([&quot;_&quot;] digit)*</span><br><span class="line">fraction      ::=  &quot;.&quot; digitpart</span><br><span class="line">exponent      ::=  (&quot;e&quot; | &quot;E&quot;) [&quot;+&quot; | &quot;-&quot;] digitpart</span><br></pre></td></tr></table></figure>
<h5 id="虚数字面值"><a href="#虚数字面值" class="headerlink" title="虚数字面值"></a>虚数字面值</h5><ul>
<li>序数字面值将生成实部为<code>0.0</code>的复数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imagnumber ::=  (floatnumber | digitpart) (&quot;j&quot; | &quot;J&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+       -       *       **      /       //      %      @</span><br><span class="line">&lt;&lt;      &gt;&gt;      &amp;       |       ^       ~</span><br><span class="line">&lt;       &gt;       &lt;=      &gt;=      ==      !=</span><br></pre></td></tr></table></figure>
<h3 id="分隔符"><a href="#分隔符" class="headerlink" title="分隔符"></a>分隔符</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(       )       [       ]       &#123;       &#125;</span><br><span class="line">,       :       .       ;       @       =       -&gt;</span><br><span class="line">+=      -=      *=      /=      //=     %=      @=</span><br><span class="line">&amp;=      |=      ^=      &gt;&gt;=     &lt;&lt;=     **=</span><br></pre></td></tr></table></figure>
<ul>
<li>以上列表中后半部分为<strong>增强赋值操作符</strong><ul>
<li>在词法中作为分隔符，同时起运算作用</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;       &quot;       #       \</span><br></pre></td></tr></table></figure>
<ul>
<li>以上可打印ASCII字符<ul>
<li>作为其他token组成部分时有特殊意义</li>
<li>或对词法分析器有特殊意义</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$       ?</span><br></pre></td></tr></table></figure>
<ul>
<li>以上可打印ASCII字符不再Python词法中使用<ul>
<li>出现在字符串字面值、注释之外将<strong>无条件引发错误</strong></li>
</ul>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-11T09:32:52.000Z" title="6/11/2019, 5:32:52 PM">2019-06-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-02T03:46:49.000Z" title="8/2/2021, 11:46:49 AM">2021-08-02</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3Ref/">Py3Ref</a></span><span class="level-item">10 minutes read (About 1484 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3Ref/execution_model.html">Python执行模型</a></h1><div class="content"><h2 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h2><h3 id="Code-Blocks"><a href="#Code-Blocks" class="headerlink" title="Code Blocks"></a><em>Code Blocks</em></h3><p>代码块：作为一个单元执行的一段python文本，代码块构成python
程序</p>
<ul>
<li>模块、函数体、类定义</li>
<li>交互式输入的每条命令</li>
<li>作为标准输入、命令行参数发送给解释器的脚本文件</li>
<li>脚本命令</li>
<li>传递给<code>eval()</code>、<code>exec()</code>的字符串参数</li>
</ul>
<blockquote>
<ul>
<li>代码块在执行帧中执行，执行帧包含某些用于调试的管理信息
  并决定代码块执行完成后操作</li>
</ul>
</blockquote>
<h2 id="Naming、Binding"><a href="#Naming、Binding" class="headerlink" title="Naming、Binding"></a><em>Naming</em>、<em>Binding</em></h2><h3 id="Binding-of-Names"><a href="#Binding-of-Names" class="headerlink" title="Binding of Names"></a><em>Binding of Names</em></h3><blockquote>
<ul>
<li>名称：用于<strong>指代对象</strong>，通过名称绑定操作引入</li>
</ul>
</blockquote>
<ul>
<li><p>名称绑定方法</p>
<ul>
<li>传递参数</li>
<li><code>import</code>语句<ul>
<li><code>from ... import *</code>会绑定被导入模块中定义的所有
公有名称（仅在模块层级上被使用）</li>
</ul>
</li>
<li>类、函数定义</li>
<li>以标识符为目标的赋值</li>
<li><p><code>for</code>循环开头、<code>with</code>和<code>except</code>子句的<code>as</code>之后</p>
</li>
<li><p><code>del</code>语句的目标也被视为绑定，虽然实际语义为解除名称
绑定</p>
</li>
</ul>
</li>
<li><p>变量类型</p>
<ul>
<li>局部变量：绑定在代码块中的名称，且未声明为<code>nonlocal</code>
、或<code>global</code></li>
<li>全局变量：绑定在模块层级的名称<ul>
<li>模块代码块中变量既为全局变量、也是局部变量</li>
</ul>
</li>
<li>自由变量：在代码块中使用但未在其中定义的变量</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>自由变量不同于闭包变量，函数闭包变量<code>__closure__</code>要求
  自由变量来自于父函数作用域</li>
</ul>
</blockquote>
<h3 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a><em>Scope</em></h3><p>作用域：定义了代码块中名称的可见性</p>
<ul>
<li><p>名称的作用域包含</p>
<ul>
<li>定义该变量代码块</li>
<li>定义变量代码块所包含的代码块
（除非被包含代码块中引入对该名称不同绑定）</li>
</ul>
</li>
<li><p>名称作用域虽然包括定义变量代码块所包含的代码块</p>
<ul>
<li>可以直接访问变量</li>
<li>但修改变量必须使用<code>global</code>、<code>local</code>等声明</li>
</ul>
</li>
<li><p>在代码块内任何位置进行名称绑定，则代码块内所有对该名称
的使用被认为是<strong>对代码块的引用</strong></p>
<blockquote>
<ul>
<li>python没有声明语法，则代码块中局部变量可通过，在整个
 代码块文本中扫描名称绑定来确定</li>
</ul>
</blockquote>
</li>
<li><p><strong>模块作用域在模块第一次被导入时创建</strong></p>
</li>
</ul>
<h3 id="Resolution-of-Names"><a href="#Resolution-of-Names" class="headerlink" title="Resolution of Names"></a><em>Resolution of Names</em></h3><ul>
<li><p>若名称在代码块中被使用，会由<strong>包含它的最近作用域</strong>来解析</p>
</li>
<li><p>若名称完全无法找到将<code>raise NameError</code></p>
</li>
<li><p>若当前作用域为函数作用域，且名称指向局部变量，若名称被
绑定值前被被使用将<code>raise UnboundLocalError</code>
（<code>UnboundLocalError</code>是<code>NameError</code>子类）</p>
</li>
</ul>
<blockquote>
<ul>
<li>（代码块）环境：对代码块可见的所作用域集合</li>
</ul>
</blockquote>
<h4 id="global"><a href="#global" class="headerlink" title="global"></a><code>global</code></h4><ul>
<li><p>对<code>global</code>指定名称的使用是对<strong>最高层级命名空间</strong>中该名称
绑定的引用</p>
<ul>
<li>全局命名空间：包含代码块的模块命名空间</li>
<li>内置命名空间：<code>builtins</code>模块的命名空间</li>
</ul>
</li>
<li><p><code>global</code>语句与同一代码块中名称绑定具有相同作用域</p>
<ul>
<li>若自由变量最近包含作用域中有<code>global</code>语句，其也会被
当作全局变量</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li><code>global</code>语句须在名称使用之前声明</li>
</ul>
</blockquote>
<h4 id="nonlocal"><a href="#nonlocal" class="headerlink" title="nonlocal"></a><code>nonlocal</code></h4><ul>
<li><p><code>nonlocal</code>使得相应名称指向最近包含函数作用域的中绑定的
变量</p>
</li>
<li><p>指定名称不存在于任何包含函数作用域则<code>raise SyntaxError</code></p>
</li>
</ul>
<h4 id="内置命名空间"><a href="#内置命名空间" class="headerlink" title="内置命名空间"></a>内置命名空间</h4><ul>
<li><p>与代码块执行相关联的内置命名空间实际上是通过其在全局命名
空间中搜索名称<code>__builtins__</code>找到，一般是字典、模块
（此时使用模块的命名空间字典）</p>
</li>
<li><p>默认情况下</p>
<ul>
<li><code>__main__</code>模块中：<code>__builtins__</code>为内置模块<code>builtins</code></li>
<li>非<code>__main__</code>模块中：<code>__buitlins__</code>是<code>builtins</code>模块
自身的字典别名</li>
</ul>
</li>
</ul>
<h4 id="动态特性"><a href="#动态特性" class="headerlink" title="动态特性"></a>动态特性</h4><ul>
<li><p>自由变量的名称解析</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>():</span></span><br><span class="line">	<span class="built_in">print</span>(i)</span><br><span class="line">i = <span class="number">42</span></span><br><span class="line">f()</span><br><span class="line">	<span class="comment"># 打印`42`</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>发生在运行时，而不是编译时</strong></li>
<li><strong>在全局命名空间中</strong>，而不是最近包含命名空间中</li>
</ul>
</li>
</ul>
<h4 id="eval-、exec"><a href="#eval-、exec" class="headerlink" title="eval()、exec()"></a><code>eval()</code>、<code>exec()</code></h4><ul>
<li><p><code>eval()</code>、<code>exec()</code>没有对完整环境的访问权限来解析名称</p>
<ul>
<li>有可选参数用于重载全局、局部命名空间</li>
<li>若只指定一个命名空间，则会同时作用于两者</li>
</ul>
</li>
</ul>
<h4 id="类"><a href="#类" class="headerlink" title="类"></a>类</h4><ul>
<li><p>类中名称解析遵守大部分情况下同普通规则，但
<strong>未绑定局部变将在全局命名空间中搜索</strong></p>
</li>
<li><p>类定义的命名空间<code>__dict__</code>会成为类的属性字典</p>
</li>
<li><p>类代码块中定义的名称的作用域会被限制在类代码块中，不会
扩展到方法代码块中，包括推导式、生成器表达式</p>
   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">	a = <span class="number">42</span></span><br><span class="line">	b = <span class="built_in">list</span>(a + i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a><em>Exception</em></h2><p>异常：中断代码块的正常控制流程以便处理错误、其他异常条件的
方式</p>
<ul>
<li><p>在错误被检测到的位置引发</p>
<ul>
<li>解释器检测到运行时错误时错误</li>
<li><code>raise</code>语句显式引发</li>
</ul>
</li>
<li><p>可被当前包围代码块、任何直接或间接主调代码块捕获、处理</p>
<ul>
<li><code>try...except</code>指定错误处理，<code>finally</code>子句清理代码</li>
<li>异常通过实例标识、根据器类型选择执行<code>except</code>子句</li>
</ul>
</li>
<li><p>错误处理采用“终止”模型</p>
<ul>
<li>异常处理器可以找出发生的问题，在外层继续执行</li>
<li>但不能修复错误的根源，并重试失败操作</li>
<li>异常完全未被处理时，解释器会终止程序执行、或返回交互
模式循环，并打印栈回溯信息，除非为<code>SystemExit</code>异常</li>
</ul>
</li>
<li><p>异常实例可以携带关于异常状态的额外信息</p>
<blockquote>
<ul>
<li>异常信息不是python API一部分，内容可能在不同python
 版本间不经警告的改变</li>
</ul>
</blockquote>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-11T07:56:31.000Z" title="6/11/2019, 3:56:31 PM">2019-06-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-06-11T07:56:31.000Z" title="6/11/2019, 3:56:31 PM">2019-06-11</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3Ref/">Py3Ref</a></span><span class="level-item">31 minutes read (About 4695 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3Ref/simple_stmts.html">Simple Statements</a></h1><div class="content"><p>简单语句：由单个逻辑行构成</p>
<ul>
<li>多条简单语句可以在同一物理行内、并以分号分隔</li>
</ul>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">simple_stmt ::=  expression_stmt</span><br><span class="line">                 | assert_stmt</span><br><span class="line">                 | assignment_stmt</span><br><span class="line">                 | augmented_assignment_stmt</span><br><span class="line">                 | annotated_assignment_stmt</span><br><span class="line">                 | pass_stmt</span><br><span class="line">                 | del_stmt</span><br><span class="line">                 | return_stmt</span><br><span class="line">                 | yield_stmt</span><br><span class="line">                 | raise_stmt</span><br><span class="line">                 | break_stmt</span><br><span class="line">                 | continue_stmt</span><br><span class="line">                 | import_stmt</span><br><span class="line">                 | future_stmt</span><br><span class="line">                 | global_stmt</span><br><span class="line">                 | nonlocal_stmt</span><br></pre></td></tr></table></figure>
<h2 id="Expression-Statements"><a href="#Expression-Statements" class="headerlink" title="Expression Statements"></a><em>Expression Statements</em></h2><p>表达式语句：用于计算、写入值（交互模式下），或调用过程（不
返回有意义结果的函数）</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expresssion_stmt ::= starred_expression</span><br></pre></td></tr></table></figure>
<ul>
<li>用途：表达式语句对指定表达式[列表]进行求值</li>
<li>交互模式下<ul>
<li>若值不为<code>None</code>：通过内置<code>repr()</code>函数转换为字符串，
单独一行写入标准输出</li>
<li>值为<code>None</code>：不产生任何输出</li>
</ul>
</li>
</ul>
<h2 id="Assignment-Statements"><a href="#Assignment-Statements" class="headerlink" title="Assignment Statements"></a><em>Assignment Statements</em></h2><p>赋值语句：将名称[重]绑定到特定值、修改属性或可变对象成员项</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">assignment_stmt ::=  (target_list <span class="string">&quot;=&quot;</span>)+ (starred_expression | yield_expression)</span><br><span class="line">target_list     ::=  target (<span class="string">&quot;,&quot;</span> target)* [<span class="string">&quot;,&quot;</span>]</span><br><span class="line">target          ::=  identifier</span><br><span class="line">                     | &quot;(&quot; [target_list] &quot;)&quot;</span><br><span class="line">                     | &quot;[&quot; [target_list] &quot;]&quot;</span><br><span class="line">                     | attributeref</span><br><span class="line">                     | subscription</span><br><span class="line">                     | slicing</span><br><span class="line">                     | &quot;*&quot; target</span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：对指定表达式列表求值，将单一结果对象从左至右逐个
赋值给目标列表</p>
</li>
<li><p>赋值根据目标列表的格式递归定义，目标为可变对象组成部分时
（属性引用、抽取、切片），可变对象赋值有效性会被检查，
赋值操作不可接受可能引发异常</p>
</li>
<li><p>赋值顺序：将赋值看作是左、右端项重叠</p>
<ul>
<li>根据定义赋值语句内多个赋值是同时重叠，如：<code>a,b=b,a</code>
交换两变量值</li>
<li><p>但赋值语句左端项包含集合类型时，重叠从左到右依次执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = [<span class="number">0</span>,<span class="number">1</span>]</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">i, x[i] = <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">	<span class="comment"># `x`现在为`[0, 2]`</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>LOAD_XXX</code>指令将右端项<strong>从左到右依次压栈</strong></li>
<li><code>ROT_N</code>指令交换栈顶元素</li>
<li><code>STORE_XXX</code>指令将栈顶元素弹出<strong>从左到右</strong>依次给
右端项赋值</li>
</ul>
</blockquote>
<ul>
<li>以上语句中，计算表达式<code>x[i]</code>前<code>i</code>已经被赋新值</li>
</ul>
<blockquote>
<ul>
<li><code>dis.dis()</code>查看代码块指令</li>
</ul>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="赋值目标为列表"><a href="#赋值目标为列表" class="headerlink" title="赋值目标为列表"></a>赋值目标为列表</h3><p>赋值目标（左端项）为列表（可选包含在圆括号、方括号内）</p>
<ul>
<li><p>若目标列表为不带逗号、可以包含在圆括号内的单一目标，将
右端项赋值给该目标</p>
</li>
<li><p>否则：右端项须为<strong>与目标列表相同项数</strong>的可迭代对象，其中
元素将从左至右顺序被赋值给对应目标</p>
</li>
<li><p>若目标列表包含带<code>*</code>元素：则类似实参解包，其须为可迭代
对象，且右端项至少包含目标列表项数-1</p>
<ul>
<li>加星目标前元素被右端项前段元素一一赋值</li>
<li>加星目标后元素被右端项后段元素一一赋值</li>
<li>加星目标被赋予剩余目标元素<strong>构成的列表</strong></li>
</ul>
</li>
</ul>
<h3 id="赋值目标为单个目标"><a href="#赋值目标为单个目标" class="headerlink" title="赋值目标为单个目标"></a>赋值目标为单个目标</h3><h4 id="目标为标识符（名称）"><a href="#目标为标识符（名称）" class="headerlink" title="目标为标识符（名称）"></a>目标为标识符（名称）</h4><ul>
<li><p>名称未出现在当前代码块<code>global</code>、<code>nonlocal</code>语句中：名称
被绑定到/赋值为当前局部命名空间对象</p>
</li>
<li><p>否则：名称被分别绑定到/赋值为全局命名空间、或<code>nonlocal</code>
确定的外层命名空间中对象</p>
</li>
</ul>
<blockquote>
<ul>
<li>若名称已经被绑定则被重新绑定，可能导致之前被绑定名称
  对象引用计数变为0，对象进入释放过程并调用其析构器</li>
</ul>
</blockquote>
<h4 id="目标为属性引用"><a href="#目标为属性引用" class="headerlink" title="目标为属性引用"></a>目标为属性引用</h4><ul>
<li><p>引用中原型表达式被求值：应产生具有可赋值属性的对象，
否则<code>raise TypeError</code></p>
</li>
<li><p>该对象指定属性将被赋值，若无法赋值将
<code>raise AttributeError</code></p>
</li>
</ul>
<h4 id="目标为抽取项"><a href="#目标为抽取项" class="headerlink" title="目标为抽取项"></a>目标为抽取项</h4><ul>
<li><p>引用中原型表达式被求值：应产生可变序列对象（列表）、
映射对象（字典）</p>
</li>
<li><p>引用中抽取表达式被求值</p>
<ul>
<li><p>若原型表达式求值为可变序列对象</p>
<ul>
<li>抽取表达式产生整数，包含负数则取模，结果只须为
小于序列长度非负整数</li>
<li>整数指定的索引号的项将被赋值</li>
<li>若索引超出范围将<code>raise IndexError</code></li>
</ul>
</li>
<li><p>若原型表达式求值为映射对象</p>
<ul>
<li>抽取表达式须产生与该映射键类型兼容的类型</li>
<li>映射可以创建、更新抽取表达式指定键值对</li>
</ul>
</li>
</ul>
</li>
<li><p>对用户自定义对象，将调用<code>__setitem__</code>方法并附带适当参数</p>
</li>
</ul>
<h4 id="目标为切片"><a href="#目标为切片" class="headerlink" title="目标为切片"></a>目标为切片</h4><ul>
<li><p>引用中原型表达式被求值：应当产生可变序列对象</p>
<ul>
<li>右端项应当是相同类型的序列对象</li>
</ul>
</li>
<li><p>上界、下界表达式若存在将被求值</p>
<ul>
<li>其应为整数，若为负数将对原型表达式序列长度求模，最终
边界被裁剪至0、序列长度开区间中</li>
<li>默认值分别为零、序列长度</li>
</ul>
</li>
<li><p>切片被赋值为右端项</p>
<ul>
<li>若切片长度和右端项长度不同，将在目标序列允许情况下
改变目标序列长度</li>
</ul>
</li>
</ul>
<h4 id="Augmented-Assignment-Statements"><a href="#Augmented-Assignment-Statements" class="headerlink" title="Augmented Assignment Statements"></a><em>Augmented Assignment Statements</em></h4><p>增强赋值语句：在单个语句中将二元运算和赋值语句合为一体</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">augmented_assignment_stmt ::=  augtarget augop (expression_list | yield_expression)</span><br><span class="line">augtarget                 ::=  identifier | attributeref | subscription | slicing</span><br><span class="line">augop                     ::=  <span class="string">&quot;+=&quot;</span> | <span class="string">&quot;-=&quot;</span> | <span class="string">&quot;*=&quot;</span> | <span class="string">&quot;@=&quot;</span> | <span class="string">&quot;/=&quot;</span> | <span class="string">&quot;//=&quot;</span> | <span class="string">&quot;%=&quot;</span> | <span class="string">&quot;**=&quot;</span></span><br><span class="line">                               | &quot;&gt;&gt;=&quot; | &quot;<span class="attribute">&lt;&lt;=&quot; | &quot;&amp;=&quot; | &quot;^=&quot; | &quot;|=&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>增强赋值语句不能类似普通赋值语句为可迭代对象拆包</li>
</ul>
</blockquote>
<ul>
<li><p>赋值增强语句对目标和表达式列表求值</p>
<ul>
<li>依据两操作数类型指定执行二元运算</li>
<li>将结果赋给原始目标</li>
</ul>
</li>
<li><p>增强赋值语句可以被改写成类似、但非完全等价的普通赋值语句</p>
<ul>
<li>增强赋值语句中目标仅会被求值一次</li>
<li>在可能情况下，运算是原地执行的，即直接修改原对象而
不是创建新对象并赋值给原对象</li>
<li>所以增强赋值<strong>先对左端项求值</strong></li>
</ul>
</li>
<li><p>其他增强赋值语句和普通赋值语句不同点</p>
<ul>
<li>单条语句中对元组、多目标赋值赋值操作处理不同</li>
</ul>
</li>
</ul>
<h4 id="Annotated-Assignment-Statements"><a href="#Annotated-Assignment-Statements" class="headerlink" title="Annotated Assignment Statements"></a><em>Annotated Assignment Statements</em></h4><p>带标注的赋值语句：在单个语句中将变量、或属性标注同可选赋值
赋值语句合并</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">annotated_assignment_stmt ::=  augtarget <span class="string">&quot;:&quot;</span> expression [<span class="string">&quot;=&quot;</span> expression]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>与普通赋值语句区别仅在于：仅有单个目标、且仅有单个右端项
才被允许</p>
</li>
<li><p>在类、模块作用域中</p>
<ul>
<li>若赋值目标为简单名称，标注会被存入类、模块的
<code>__annotations__</code>属性中</li>
<li>若赋值目标为表达式，标注被求值但不会被保存</li>
</ul>
</li>
<li><p>在函数作用域内，标注不会被求值、保存</p>
</li>
<li><p>若存在右端项，带标注赋值在对标注值求值前执行实际赋值；
否则仅对赋值目标求值，不执行<code>__setitem__</code>、<code>__setattr__</code></p>
<blockquote>
<ul>
<li>参见<em>cs_python/py3ref/#todo</em></li>
</ul>
</blockquote>
</li>
</ul>
<h2 id="关键字语句"><a href="#关键字语句" class="headerlink" title="关键字语句"></a>关键字语句</h2><h3 id="assert"><a href="#assert" class="headerlink" title="assert"></a><code>assert</code></h3><p>assert语句：在程序中插入调试性断言的简便方式</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert_stmt ::= <span class="string">&quot;assert&quot;</span> expression [<span class="string">&quot;,&quot;</span> expression]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>assert语句等价于</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="literal">__debug__</span>:</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> expression:</span><br><span class="line">		<span class="keyword">raise</span> AssertionError</span><br><span class="line">	<span class="comment"># 等价于`assert expression`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="literal">__debug__</span>:</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> expression1:</span><br><span class="line">		<span class="keyword">raise</span> AssertionError(expression2)</span><br><span class="line">	<span class="comment"># 等价于`assert expression1, expression2`</span></span><br></pre></td></tr></table></figure>
<ul>
<li>无需再错误信息中包含失败表达式源码，其会被作为栈追踪
一部分被显示</li>
</ul>
</li>
<li><p>假定<code>__debug__</code>、<code>AssertionError</code>指向具有特定名称的内置
变量，当前实现中</p>
<ul>
<li>对<code>__debug__</code>赋值是非法的，其值在解释器启动时确定</li>
<li>默认内置变量<code>__debug__=True</code></li>
<li>请求优化时<code>__debug__</code>置为<code>False</code><ul>
<li><code>-0</code>命令行参数开启</li>
<li>若编译时请求优化，代码生成器不会为assert语句生成
代码</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="pass"><a href="#pass" class="headerlink" title="pass"></a><code>pass</code></h3><p>pass语句：空操作，被执行时无事情发生</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pass_stmt ::= <span class="string">&quot;pass&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>适合语法上需要语句、但不需要执行代码时临时占位</li>
</ul>
<h3 id="del"><a href="#del" class="headerlink" title="del"></a><code>del</code></h3><p>del语句：从局部、全局命名空间中移除名称的绑定，若名称未绑定
将<code>raise NameError</code></p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del_stmt ::= <span class="string">&quot;del&quot;</span> target_list</span><br></pre></td></tr></table></figure>
<ul>
<li><p>删除是递归定义的</p>
<ul>
<li>类似赋值的定义方式</li>
<li>从左至右递归的删除目标列表中每个目标</li>
</ul>
</li>
<li><p>属性、抽取、切片的删除会被传递给相应原型对象</p>
<ul>
<li>删除切片基本等价于赋值为目标类型的空切片？？？</li>
</ul>
</li>
</ul>
<h3 id="return"><a href="#return" class="headerlink" title="return"></a><code>return</code></h3><p>return语句：离开当前函数调用，返回列表表达式值、<code>None</code></p>
<ul>
<li><p>在生成器函数中，return语句表示生成器已完成</p>
<ul>
<li>并<code>raise StopIteration</code></li>
<li>返回值作为参数构建<code>StopIteration</code>，并作为
<code>StopIteration.value</code>属性</li>
</ul>
</li>
<li><p>异步生成器函数中，return语句表示异步生成器已完成</p>
<ul>
<li>并<code>raise StopAsyncIteration</code></li>
<li>非空<code>return</code>返回值在将导致语法错误</li>
</ul>
</li>
</ul>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return_stmt ::= <span class="string">&quot;return&quot;</span> [expression_list]</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>return</code>语法上只会出现于函数定义代码块中，不会出现于
类定义所嵌套代码中</p>
</li>
<li><p>若提供表达式列表，其将被求值；否则缺省为<code>None</code></p>
</li>
<li><p><code>return</code>将控制流传出带有<code>finally</code>子句的<code>try</code>语句时，
<code>finally</code>子句会先被执行然后真正离开函数</p>
</li>
</ul>
<h3 id="yield"><a href="#yield" class="headerlink" title="yield"></a><code>yield</code></h3><p>yield语句：语义上等于yield表达式</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yield_stmt ::= yield_expression</span><br></pre></td></tr></table></figure>
<ul>
<li><p>可用于省略在使用等效yield表达式必须的圆括号</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">yield</span> &lt;expr&gt;</span><br><span class="line"><span class="keyword">yield</span> <span class="keyword">from</span> &lt;expr&gt;</span><br><span class="line">	<span class="comment"># 以上yield语句、以下yield表达式等价</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">yield</span> &lt;expr&gt;)</span><br><span class="line">(<span class="keyword">yield</span> <span class="keyword">from</span> &lt;expr&gt;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>yeild表达式、语句仅在定义[异步]生成器函数时使用，且仅
用于函数体内部，且函数体包含<code>yield</code>就使得该定义创建
生成器函数而非普通函数</p>
</li>
</ul>
<blockquote>
<ul>
<li>yield表达式参见<em>cs_python/py3ref/#todo</em></li>
</ul>
</blockquote>
<h3 id="raise"><a href="#raise" class="headerlink" title="raise"></a><code>raise</code></h3><p>raise语句：引发异常</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">raise_stmt ::= <span class="string">&quot;raise&quot;</span> [expression [<span class="string">&quot;from&quot;</span> expression]]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>若不带表达式：<code>raise</code>将重新引发当前作用域最后一个激活
异常</p>
<ul>
<li>若当前作用域内没有激活异常，将引发<code>RuntimeError</code>
提示错误</li>
</ul>
</li>
<li><p>否则计算表达式作为异常对象</p>
<ul>
<li>异常对象须为<code>BaseException</code>子类、实例</li>
<li>若其为类，则通过不带参数的实例化该类作为异常实例</li>
</ul>
</li>
<li><p>异常被引发时会自动创建回溯对象，并被关联至可写
<code>__traceback__</code>属性</p>
<ul>
<li><p>可以创建异常时同时使用<code>.with_traceback()</code>异常方法
自定义回溯对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">raise</span> Exception(<span class="string">&quot;foo occured&quot;</span>).with_traceback(tbobj)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="异常串联"><a href="#异常串联" class="headerlink" title="异常串联"></a>异常串联</h4><ul>
<li><p><code>from</code>子句用于异常串联：其后表达式求值需要为另一个异常</p>
<ul>
<li>其将作为可写<code>__cause__</code>属性被关联到引发的第一个异常</li>
<li>若引发异常未被处理，两个异常都将被打印</li>
</ul>
</li>
<li><p>若异常在try语句中<code>finally</code>子句、其他子句后、先中引发，
类似机制发挥作用，之前异常被关联到新异常的<code>__context__</code>
属性</p>
</li>
</ul>
<blockquote>
<ul>
<li>异常串联可以通过在<code>from</code>子句中指定<code>None</code>显式抑制</li>
</ul>
</blockquote>
<h3 id="break"><a href="#break" class="headerlink" title="break"></a><code>break</code></h3><p>break语句：终结最近外层循环、<strong>循环的可选<code>else</code>子句</strong></p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">break_stmt ::= <span class="string">&quot;break&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>break</code>在语法上只出现在<code>for</code>、<code>while</code>所嵌套代码</p>
<ul>
<li>不包括循环内函数定义、类定义所嵌套代码</li>
</ul>
</li>
<li><p>若<code>for</code>循环被<code>break</code>终结，循环控制目标保持当前值</p>
</li>
<li><p>当<code>break</code>将控制流传出带有<code>finally</code>子句的<code>try</code>语句时，
<code>finally</code>子句会先被执行，然后真正离开循环</p>
</li>
</ul>
<h3 id="continue"><a href="#continue" class="headerlink" title="continue"></a><code>continue</code></h3><p>continue语句：继续执行最近外层循环的下一伦茨</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">continue_stmt ::= <span class="string">&quot;continue&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>continue</code>在语法上只出现在<code>for</code>、<code>while</code>所嵌套代码</p>
<ul>
<li>不包括循环内函数定义、类定义、<code>finally</code>子句所嵌套
代码</li>
</ul>
</li>
<li><p>当<code>continue</code>将控制流传出带有<code>finally</code>子句的<code>try</code>语句时，
<code>finally</code>子句会先被执行，然后真正开始循环下一个轮次</p>
</li>
</ul>
<h3 id="import"><a href="#import" class="headerlink" title="import"></a><code>import</code></h3><p>import语句</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import_stmt     ::=  <span class="string">&quot;import&quot;</span> module [<span class="string">&quot;as&quot;</span> identifier] (<span class="string">&quot;,&quot;</span> module [<span class="string">&quot;as&quot;</span> identifier])*</span><br><span class="line">                     | &quot;from&quot; relative_module &quot;import&quot; identifier [&quot;as&quot; identifier]</span><br><span class="line">                     (&quot;,&quot; identifier [&quot;as&quot; identifier])*</span><br><span class="line">                     | &quot;from&quot; relative_module &quot;import&quot; &quot;(&quot; identifier [&quot;as&quot; identifier]</span><br><span class="line">                     (&quot;,&quot; identifier [&quot;as&quot; identifier])* [&quot;,&quot;] &quot;)&quot;</span><br><span class="line">                     | &quot;from&quot; module &quot;import&quot; &quot;*&quot;</span><br><span class="line">module          ::=  (identifier <span class="string">&quot;.&quot;</span>)* identifier</span><br><span class="line">relative_module ::=  <span class="string">&quot;.&quot;</span>* module | <span class="string">&quot;.&quot;</span>+</span><br></pre></td></tr></table></figure>
<ul>
<li><p>基本<code>import</code>子句执行步骤</p>
<ul>
<li>查找模块，若有必要加载并初始化模块</li>
<li>为<code>import</code>所处作用域的局部命名空间定义名称</li>
</ul>
<blockquote>
<ul>
<li>语句包含多个子句（逗号分隔）时，以上两个步骤将分别
 对每个子句执行，如同子句被分成独立<code>import</code>语句</li>
</ul>
</blockquote>
</li>
<li><p>默认情况下，导入的父模块中命名空间中不包含子模块属性，
即导入父模块<strong>不能直接通过属性<code>.</code>引用子模块</strong></p>
<ul>
<li>有些包会在父模块中导入子模块，则初始化模块时父模块
中即有子模块属性</li>
<li>在当前模块手动导入子模块，子模块绑定至父模块命名空间
中同名属性</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>导入机制参见<em>cs_python/py3ref/import_system</em></li>
</ul>
</blockquote>
<h4 id="绑定"><a href="#绑定" class="headerlink" title="绑定"></a>绑定</h4><ul>
<li><p>若模块名称后带有<code>as</code>，则在<code>as</code>之后名称将直接绑定到所导入
模块</p>
</li>
<li><p>若没有指定其他名称、且被导入模块为最高层级模块，则模块
名称被绑定到局部命名空间作为对所导入模块的引用</p>
</li>
<li><p>若被导入模块不是最高级模块，则包含该模块的最高层级包名将
被绑定到局部命名空间作为的该最高层级包的引用，所导入模块
必须使用完整限定名称访问而不能直接访问</p>
</li>
</ul>
<h4 id="from子句"><a href="#from子句" class="headerlink" title="from子句"></a><code>from</code>子句</h4><ul>
<li><p>查找<code>from</code>子句中指定模块，若有必要则加载并初始化模块</p>
</li>
<li><p>对<code>import</code>子句中指定的每个标识符</p>
<ul>
<li>检查被导入模块是否有<strong>该名称属性</strong></li>
<li>若没有，尝试导入具有该名称子模块，然后再次检查
<strong>被导入（上级）模块</strong>是否具有该属性</li>
<li>若未找到该属性，则<code>raise ImportError</code></li>
<li>否则将对该值引用存入局部命名空间，若有<code>as</code>子句则
使用其指定名称，否则使用该属性名称</li>
</ul>
</li>
</ul>
<h5 id="通配符"><a href="#通配符" class="headerlink" title="*通配符"></a><code>*</code>通配符</h5><p>标识符列表为通配符<code>*</code>形式：模块中定义的全部公有名称都被绑定
至<code>import</code>语句作用域对应局部命名空间</p>
<ul>
<li><p>模块命名空间中<code>__all__</code>属性：字符串列表，指定模块
<strong>定义的公有名称</strong></p>
<ul>
<li>其中字符串项为模块中定义、导入的名称</li>
<li>其中中所给出的名称被视为公有、应当存在</li>
<li>应该包含所有公有API、避免意外导出不属于API部分项</li>
</ul>
</li>
<li><p>若<code>__all__</code>属性未定义：则公有名称集合将包括在模块
命名空间中找到的、所有不以<code>_</code>开头名称</p>
</li>
</ul>
<blockquote>
<ul>
<li>通配符模式仅在模块层级允许使用，在类、函数中使用将
  <code>raise SyntaxError</code></li>
</ul>
</blockquote>
<h5 id="相对导入"><a href="#相对导入" class="headerlink" title="相对导入"></a>相对导入</h5><p>相对导入：指定导入模块时，无需指定模块绝对名称</p>
<ul>
<li><p>需要导入的模块、包被包含在同一包中时，可在相同顶级包中
进行相对导入，无需指明包名称</p>
</li>
<li><p>在<code>from</code>子句中指定的模块、包中使用前缀点号指明需要上溯
包层级数</p>
<ul>
<li>一个前缀点号：执行导入的模块在当前包</li>
<li>两个前缀点号：上溯一个包层级</li>
<li><p>三个前缀点号：上溯两个包层级，依此类推</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">form ...sub_sub_pkg import mod1</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>相对导入可以避免模块之间产生冲突，适合导入相关性强代码</p>
<ul>
<li>脚本模式（在命令行中执行<code>.py</code>文件）不支持相对导入</li>
<li>要跨越多个文件层级导入，只需要使用多个<code>.</code>，但
<em>PEP 328</em>建议，相对导入层级不要超过两层</li>
</ul>
</li>
</ul>
<h4 id="future语句"><a href="#future语句" class="headerlink" title="future语句"></a><em>future</em>语句</h4><p>future语句：指明莫格特定模块使用在特定、未来某个python发行版
中成为标准特性的语法、语义</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">future_stmt ::=  <span class="string">&quot;from&quot;</span> <span class="string">&quot;__future__&quot;</span> <span class="string">&quot;import&quot;</span> feature [<span class="string">&quot;as&quot;</span> identifier]</span><br><span class="line">                 (&quot;,&quot; feature [&quot;as&quot; identifier])*</span><br><span class="line">                 | &quot;from&quot; &quot;__future__&quot; &quot;import&quot; &quot;(&quot; feature [&quot;as&quot; identifier]</span><br><span class="line">                 (&quot;,&quot; feature [&quot;as&quot; identifier])* [&quot;,&quot;] &quot;)&quot;</span><br><span class="line">feature     ::=  identifier</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>import __future__ [as name]</code>：不是future语句，只是没有
  特殊语义、语法限制的普通import语句</li>
</ul>
</blockquote>
<ul>
<li><p>用途</p>
<ul>
<li>允许模块在包含新特性发行版前使用该特性</li>
<li>目的是使得在迁移至引入不兼容改变的python未来版本
更容易</li>
</ul>
</li>
<li><p>future语句是针对编译器的指令</p>
<ul>
<li><p>在编译时被识别并做特殊对待</p>
<ul>
<li>改变核心构造语义常通过生成不同代码实现</li>
<li>新特性可能会引入不兼容语法，如：新关键字，编译器
可能需要以不同方式解析模块</li>
</ul>
</li>
<li><p>编译器需要知道哪些特性名称已经定义</p>
<ul>
<li>包含未知特性的future语句将引发编译时错误</li>
</ul>
</li>
<li><p>直接运行时语义同其他import语句</p>
<ul>
<li>相应运行时语义取决于future语句启用的指定特性</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>在包含future语句的环境中，通过<code>exec()</code>、<code>compile()</code>
 调用代码<strong>会使用future语句关联的语法、语义</strong>，此行为
 可以通过<code>compile()</code>可选参数加以控制</li>
</ul>
</blockquote>
</li>
<li><p>future语句必须在靠近模块开头位置处出现，可以出现在future
语句前的行</p>
<ul>
<li>模块文档字符串</li>
<li>注释</li>
<li>空行</li>
<li>其他future语句</li>
</ul>
</li>
</ul>
<h3 id="global"><a href="#global" class="headerlink" title="global"></a><code>global</code></h3><p>global语句：声明所列出标识符将被解读为全局变量</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">global_stmt ::= <span class="string">&quot;global&quot;</span> identifier (<span class="string">&quot;,&quot;</span> identifier)*</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>global</code>语句是作用于整个当前代码块的声明</p>
</li>
<li><p>局部作用域中给全局变量<strong>赋值</strong>必须用到<code>global</code>关键字</p>
<ul>
<li>仅仅是获取值无需<code>global</code>语句声明</li>
<li>但自由变量也可以指向全局变量而不必声明为全局变量</li>
</ul>
</li>
<li><p>global语句中列出的名称</p>
<ul>
<li>不能被定义为形参名</li>
<li>不能作为<code>for</code>循环控制目标</li>
<li>不能出现在类定义、函数定义、<code>import</code>语句、变量标注中</li>
</ul>
<blockquote>
<ul>
<li>CPython：暂时未强制要求上述限制，未来可能更改</li>
</ul>
</blockquote>
</li>
<li><p><code>global</code>是对<strong>解释器的指令</strong>，仅对与global语句同时被解析
的代码起作用</p>
<ul>
<li>包含在作为<code>exec()</code>参数的字符串、代码对象中global
语句不会影响<code>exec()</code>所在代码块</li>
<li>反之<code>exec()</code>中代码也不会被调用其代码块影响</li>
</ul>
<blockquote>
<ul>
<li><code>eval()</code>、<code>compile()</code>等函数同</li>
</ul>
</blockquote>
</li>
</ul>
<h3 id="nonlocal"><a href="#nonlocal" class="headerlink" title="nonlocal"></a><code>nonlocal</code></h3><p>nonlocal语句：使得列出的名称指向<strong>之前最近的包含作用域中</strong>
绑定的、除全局变量外的变量</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nonlocal_stmt ::= <span class="string">&quot;nonlocal&quot;</span> indentifier (<span class="string">&quot;,&quot;</span> identifier)*</span><br></pre></td></tr></table></figure>
<ul>
<li><p>nonlocal语句允许被封装代码重新绑定局部作用域以外、且非
全局（模块）作用域当中变量</p>
<ul>
<li><p>即nonlocal语句中列出名称，必须指向<strong>之前存在</strong>于
包含作用域中的绑定</p>
</li>
<li><p>nonlocal语句中列出名称不能与之前存在的局部作用域中
绑定冲突</p>
</li>
</ul>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-09T17:42:37.000Z" title="6/10/2019, 1:42:37 AM">2019-06-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-02T06:47:45.000Z" title="8/2/2021, 2:47:45 PM">2021-08-02</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3std/">Py3std</a></span><span class="level-item">12 minutes read (About 1748 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3std/runtime_service.html">Python 运行时服务</a></h1><div class="content"><h2 id="sys"><a href="#sys" class="headerlink" title="sys"></a><code>sys</code></h2><p><code>sys</code>：与Python解释器<strong>本身相关</strong>的组件</p>
<h3 id="平台、版本"><a href="#平台、版本" class="headerlink" title="平台、版本"></a>平台、版本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.platform</span><br><span class="line">	<span class="comment"># 操作系统名称</span></span><br><span class="line">sys.maxsize</span><br><span class="line">	<span class="comment"># 当前计算机最大容纳“原生”整型</span></span><br><span class="line">	<span class="comment"># 一般就是字长</span></span><br><span class="line">sys.version</span><br><span class="line">	<span class="comment"># python解释器版本号</span></span><br><span class="line">sys.byteorder</span><br><span class="line">	<span class="comment"># 平台字节序</span></span><br><span class="line">sys.hash_info</span><br><span class="line">	<span class="comment"># 数值类型hash信息</span></span><br></pre></td></tr></table></figure>
<h4 id="sys-xxxcheckinterval"><a href="#sys-xxxcheckinterval" class="headerlink" title="sys.xxxcheckinterval"></a><code>sys.xxxcheckinterval</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sys.getcheckinterval()</span><br><span class="line">	<span class="comment"># 查看解释器检查线程切换、信号处理器等的频率</span></span><br><span class="line">sys.setcheckinterval(N)</span><br><span class="line">	<span class="comment"># 设置解释器检查线程切换、信号处理器等的频率</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>参数</p>
<ul>
<li><code>N</code>：线程切换前执行指令的数量</li>
</ul>
</li>
<li><p>对大多数程序无需更改此设置，但是可以用于调试线程性能</p>
<ul>
<li>较大值表示切换频率较低，切换线程开销降低，但是对事件
的应答能力变弱</li>
<li>较小值表示切换频率较高，切换线程开销增加，对事件应答
能力提升</li>
</ul>
</li>
</ul>
<h4 id="sys-hash-info"><a href="#sys-hash-info" class="headerlink" title="sys.hash_info"></a><code>sys.hash_info</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sys.hash_info.width</span><br><span class="line">	<span class="comment"># `hash()`函数截取hash值长度</span></span><br></pre></td></tr></table></figure>
<h3 id="模块搜索路径"><a href="#模块搜索路径" class="headerlink" title="模块搜索路径"></a>模块搜索路径</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.path</span><br></pre></td></tr></table></figure>
<ul>
<li>返回值：目录名称字符串组成的列表<ul>
<li>每个目录名称代表<strong>正在运行</strong>python解释器的运行时模块
搜索路径</li>
<li>可以类似普通列表在运行时被修改、生效</li>
</ul>
</li>
</ul>
<h4 id="sys-path初始化顺序"><a href="#sys-path初始化顺序" class="headerlink" title="sys.path初始化顺序"></a><code>sys.path</code>初始化顺序</h4><ul>
<li><p>脚本主目录指示器：空字符串</p>
<ul>
<li>脚本主目录是指脚本<strong>所在目录</strong>，不是<code>os.getcwd()</code>
获取的当前工作目录</li>
</ul>
</li>
<li><p><code>PYTHONPATH</code>环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> .bashrc</span></span><br><span class="line">export PYTHONPATH=$PYTHONPATH:/path/to/fold/contains/module</span><br></pre></td></tr></table></figure>
</li>
<li><p>标准库目录</p>
</li>
<li><p><code>.pth</code>路径文件：在扫描以上目录过程中，遇到<code>.pth</code>文件会
将其中路径加入<code>sys.path</code>中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># extras.pth</span><br><span class="line">/path/to/fold/contains/module</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="导入模块顺序"><a href="#导入模块顺序" class="headerlink" title="导入模块顺序"></a>导入模块顺序</h4><p>导入模块时，python解释器</p>
<ol>
<li>搜索<strong>内置</strong>模块，即内置模块优先级最高</li>
<li>从左至右扫描<code>sys.path</code>列表，在列表目录下搜索模块文件</li>
</ol>
<h3 id="嵌入解释器的钩子"><a href="#嵌入解释器的钩子" class="headerlink" title="嵌入解释器的钩子"></a>嵌入解释器的钩子</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sys.modules</span><br><span class="line">	<span class="comment"># 已加载模块字典</span></span><br><span class="line">sys.builtin_module_names</span><br><span class="line">	<span class="comment"># 可执行程序的内置模块</span></span><br><span class="line">sys.getrefcount()</span><br><span class="line">	<span class="comment"># 查看对象引用次数</span></span><br></pre></td></tr></table></figure>
<h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.exc_info()</span><br></pre></td></tr></table></figure>
<ul>
<li>返回值：<code>(type, value, trackback)</code><ul>
<li>最近异常的类型、值、追踪对象元组</li>
<li>处理该异常的<code>except</code>执行之后，<code>sys.exc_info</code>被恢复
为原始值</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>追踪对象可以使用<code>traceback</code>模块处理</li>
</ul>
</blockquote>
<h3 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.argv</span><br></pre></td></tr></table></figure>
<ul>
<li>返回值：命令行参数列表<ul>
<li>首项始终为执行脚本名称，交互式python时为空字符串</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>参数可以自行解析，也可以使用以下标准库中模块<blockquote>
<ul>
<li><code>getopt</code>：类似Unix/C同名工具</li>
<li><code>optparse</code>：功能更加强大</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<h3 id="标准流"><a href="#标准流" class="headerlink" title="标准流"></a>标准流</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sys.stdin</span><br><span class="line">	<span class="comment"># 标准输入流</span></span><br><span class="line">sys.stdout</span><br><span class="line">	<span class="comment"># 标准输出流</span></span><br><span class="line">sys.stderr</span><br><span class="line">	<span class="comment"># 标准错误流</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>标准流是<strong>预先打开的python文件对象</strong></p>
<ul>
<li>在python启动时自动链接到程序上、绑定至终端</li>
<li>shell会将相应流链接到指定数据源：用户标准输入、文件</li>
</ul>
</li>
</ul>
<h4 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h4><ul>
<li><p>可以将<code>sys.stdin</code>、<code>sys.stdout</code>重置到文件类的对象，实现
python<strong>内部的</strong>、<strong>普遍的</strong>重定向方式</p>
<ul>
<li>外部：cmd输入输出重定向</li>
<li>局部：指定<code>print</code>参数</li>
</ul>
</li>
<li><p>任何方法上与文件类似的对象都可以充当标准流，与对象类型
无关，只取决于接口</p>
<ul>
<li><p>任何提供了类似文件<code>read</code>方法的对象可以指定给
<code>sys.stdin</code>，以从该对象<code>read</code>读取输入</p>
</li>
<li><p>任何提供了类似文件<code>write</code>方法的对象可以指定给
<code>sys.write</code>，将所有标准输出发送至该对象方法上</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>标准库<code>io</code>提供可以用于重定向的类<code>StringIO</code>、<code>ByteIO</code></li>
<li>重定向之后<code>print</code>、<code>input</code>方法将应用在重定向之后的流</li>
</ul>
</blockquote>
<h4 id="stdin"><a href="#stdin" class="headerlink" title="stdin"></a><code>stdin</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stdin.read()</span><br><span class="line">	<span class="comment"># 从标准输入流引用对象读取数据</span></span><br><span class="line"><span class="built_in">input</span>(<span class="string">&quot;input a word&quot;</span>)</span><br><span class="line">sys.stdin.readlines()[-<span class="number">1</span>]</span><br><span class="line">	<span class="comment"># 以上两行语句类似</span></span><br><span class="line"></span><br><span class="line">stdin.isatty()</span><br><span class="line">	<span class="comment"># 判断stdin是否连接到终端（是否被重定向）</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在stdin被重定向时，若需要接受用户终端输入，需要使用
特殊接口从键盘直接读取用户输入<ul>
<li>win：<code>msvcrt</code>模块</li>
<li>linux：读取<code>/dev/tty</code>设备文件</li>
</ul>
</li>
</ul>
<h3 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.exit(N)</span><br></pre></td></tr></table></figure>
<ul>
<li>用途：当前<strong>线程</strong>以状态N退出<ul>
<li>实际上只是抛出一个内建的<code>SystemExit</code>异常，可以被正常
捕获</li>
<li>等价于显式<code>raise SystemExit</code></li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>进程退出参见<code>os._exit()</code></li>
</ul>
</blockquote>
<h4 id="sys-exitfuncs"><a href="#sys-exitfuncs" class="headerlink" title="sys.exitfuncs"></a><code>sys.exitfuncs</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.exitfuncs</span><br></pre></td></tr></table></figure>
<h3 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sys.getdefaulencoding()</span><br><span class="line">	<span class="comment"># 文件内容编码，平台默认值</span></span><br><span class="line">	<span class="comment"># 默认输入解码、输出编码方案</span></span><br><span class="line">sys.getfilesystemencoding()</span><br><span class="line">	<span class="comment"># 文件名编码，平台默认体系</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>win10中二者都是<code>utf-8</code>，win7中文件名编码是<code>mbcs</code></li>
</ul>
</blockquote>
<h2 id="sysconfig"><a href="#sysconfig" class="headerlink" title="sysconfig"></a><code>sysconfig</code></h2><h2 id="builtins"><a href="#builtins" class="headerlink" title="builtins"></a><code>builtins</code></h2><h2 id="main"><a href="#main" class="headerlink" title="__main__"></a><code>__main__</code></h2><h2 id="warnings"><a href="#warnings" class="headerlink" title="warnings"></a><code>warnings</code></h2><h2 id="dataclass"><a href="#dataclass" class="headerlink" title="dataclass"></a><code>dataclass</code></h2><h2 id="atexit"><a href="#atexit" class="headerlink" title="atexit"></a><code>atexit</code></h2><p><code>atexit</code>：主要用于在<strong>程序结束前</strong>执行代码</p>
<ul>
<li>类似于析构，主要做资源清理工作</li>
</ul>
<h3 id="atexit-register"><a href="#atexit-register" class="headerlink" title="atexit.register"></a><code>atexit.register</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">	func,</span></span></span><br><span class="line"><span class="params"><span class="function">	*arg,</span></span></span><br><span class="line"><span class="params"><span class="function">	**kwargs</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用途：注册回调函数<ul>
<li>在程序退出之前，按照注册顺序反向调用已注册回调函数</li>
<li>如果程序非正常crash、通过<code>os._exit()</code>退出，注册回调
函数不会被调用</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> atexit</span><br><span class="line"></span><br><span class="line">df func1():</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;atexit func 1, last out&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func2</span>(<span class="params">name, age</span>):</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;atexit func 2&quot;</span>)</span><br><span class="line"></span><br><span class="line">atexit.register(func1)</span><br><span class="line">atexit.register(func2, <span class="string">&quot;john&quot;</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@atexit.register</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func3</span>():</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;atexit func 3, first out&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p><code>atexit</code>内部是通过<code>sys.exitfunc</code>实现的</p>
<ul>
<li><p>将注册函数放到列表中，当程序退出时按照<strong>先进后出</strong>方式
调用注册的回调函数，</p>
</li>
<li><p>若回调函数执行过程中抛出异常，<code>atexit</code>捕获异常然后继续
执行之后回调函数，知道所有回调函数执行完毕再抛出异常</p>
</li>
<li><p>二者同时使用，通过<code>atexit.register</code>注册回调函数可能不会
被正常调用</p>
</li>
</ul>
<h2 id="traceback"><a href="#traceback" class="headerlink" title="traceback"></a><code>traceback</code></h2><h3 id="traceback-print-tb"><a href="#traceback-print-tb" class="headerlink" title="traceback.print_tb"></a><code>traceback.print_tb</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> traceback, sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	...</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">	exc_info = sys.exec_info()</span><br><span class="line">	<span class="built_in">print</span>(exec_info[<span class="number">0</span>], exec_info[<span class="number">1</span>])</span><br><span class="line">	traceback.print_tb(exec_info[<span class="number">2</span>])</span><br></pre></td></tr></table></figure>
<h2 id="future"><a href="#future" class="headerlink" title="__future__"></a><code>__future__</code></h2><h2 id="gc"><a href="#gc" class="headerlink" title="gc"></a><code>gc</code></h2><h2 id="inspect"><a href="#inspect" class="headerlink" title="inspect"></a><code>inspect</code></h2><h2 id="site"><a href="#site" class="headerlink" title="site"></a><code>site</code></h2><h2 id="abc"><a href="#abc" class="headerlink" title="abc"></a><code>abc</code></h2><h3 id="ABCMeta"><a href="#ABCMeta" class="headerlink" title="ABCMeta"></a><code>ABCMeta</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IStream</span>(<span class="params">metaclass=ABCMeta</span>):</span></span><br><span class="line"><span class="meta">	@abstractmethod</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">self, maxbytes=-<span class="number">1</span></span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">	@abstractmethod</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">self, data</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SocketStream</span>(<span class="params">IStream</span>):</span></span><br><span class="line">	<span class="comment"># 抽象类目的就是让别的类继承并实现特定抽象方法</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">self, maxbytes=-<span class="number">1</span></span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">self, data</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serialize</span>(<span class="params">obj, stream</span>):</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(stream, IStream):</span><br><span class="line">		<span class="comment"># 抽象基类的主要用途之一：检查某些类是否为特定类型、</span></span><br><span class="line">			<span class="comment"># 实现特定接口</span></span><br><span class="line">		<span class="keyword">raise</span> TypeError(<span class="string">&quot;expect an IStream&quot;</span>)</span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>(<span class="params">metaclass=ABCMeta</span>):</span></span><br><span class="line"><span class="meta">	@property</span></span><br><span class="line"><span class="meta">	@abstract</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">name</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">	@name.setter</span></span><br><span class="line"><span class="meta">	@abstractmethod</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">name</span>(<span class="params">self, value</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">	@classmethod</span></span><br><span class="line"><span class="meta">	@abstractmethod</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">method1</span>(<span class="params">cls</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">	@staticmethod</span></span><br><span class="line"><span class="meta">	@abstractmethod</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">method2</span>():</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># `@abstract`还能注解静态方法、类方法、`@property`</span></span><br><span class="line">	<span class="comment"># 但是需要保证这个方法**紧靠**函数定义</span></span><br></pre></td></tr></table></figure>
<h3 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h3><p>标准库中有很多用到抽象基类的地方</p>
<ul>
<li><p><code>collections</code>模块定义了很多和容器、迭代器（序列、映射、
集合）有关的抽象基类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> collections <span class="keyword">as</span> clt</span><br><span class="line"></span><br><span class="line">clt.<span class="type">Sequence</span></span><br><span class="line">clt.Iterable</span><br><span class="line">clt.Sized</span><br><span class="line">clt.Mapping</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>numbers</code>库定义了跟数据对象：整数、浮点数、有理数有关的
基类</p>
</li>
<li><p><code>IO</code>库定义了很多跟IO操作相关的基类</p>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-09T17:36:53.000Z" title="6/10/2019, 1:36:53 AM">2019-06-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-02T03:46:05.000Z" title="8/2/2021, 11:46:05 AM">2021-08-02</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3Ref/">Py3Ref</a></span><span class="level-item">29 minutes read (About 4308 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3Ref/dm_gfuncs.html">数据模型--函数决定对象</a></h1><div class="content"><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="用户定义函数"><a href="#用户定义函数" class="headerlink" title="用户定义函数"></a>用户定义函数</h3><p>用户定义函数：通过函数定义创建，调用时附带参数列表</p>
<ul>
<li>函数对象支持获取、设置任意属性<ul>
<li>用于给函数附加元数据</li>
<li>使用属性点号<code>.</code>获取、设置此类属性</li>
</ul>
</li>
</ul>
<h4 id="特殊属性"><a href="#特殊属性" class="headerlink" title="特殊属性"></a>特殊属性</h4><ul>
<li><code>__defaults__</code>：有默认值参数的默认值组成元组<ul>
<li>没有具有默认值参数则为<code>None</code></li>
</ul>
</li>
<li><code>__code__</code>：<strong>编译后</strong>函数体代码对象</li>
<li><code>__globals__</code>：存放函数中全局变量的字典的引用<ul>
<li>即引用函数所属模块的全局命名空间</li>
<li>只读</li>
</ul>
</li>
<li><code>__closure__</code>：包含函数<strong>自由变量</strong>绑定单元的元组<ul>
<li>没有则为<code>None</code></li>
<li>只读</li>
</ul>
</li>
<li><code>__annotations__</code>：包含参数注释的字典<ul>
<li>字典键为参数名、<code>return</code>（若包含返回值）</li>
<li>将变量名称（非私有）映射到标注值的特殊字典</li>
<li>若该属性可写、在类或模块体开始执行时，若静态地发现
标注则被自动创建</li>
</ul>
</li>
<li><code>__kwdefaults__</code>：<code>keyword-only</code>参数的默认值字典</li>
</ul>
<blockquote>
<ul>
<li>大部分可写属性会检查赋值类型</li>
<li>自由变量：上层命名空间中变量，不包括顶级命名空间，即
  全局变量不是自由变量</li>
</ul>
</blockquote>
<h3 id="实例-绑定方法"><a href="#实例-绑定方法" class="headerlink" title="实例/绑定方法"></a>实例/绑定方法</h3><p>实例/绑定方法：使用<strong>属性表示法调用</strong>、<strong>定义在类命名空间</strong>
中的函数</p>
<ul>
<li><p>实例方法用于将类、类实例同可调用对象结合起来</p>
<ul>
<li>可调用对象：<strong>须为类属性，即定义在类命名空间中</strong>，
通常为用户定义函数、类方法对象</li>
</ul>
</li>
<li><p>通过实例访问类命名空间定义函数时<strong>创建</strong>实例/绑定方法</p>
<ul>
<li>通过示例、类访问的命名空间定义函数类型不同<ul>
<li><code>wrapper_descriptor</code>转换为<code>method-wrapper</code></li>
<li><code>function</code>转换为<code>method</code></li>
<li>通过类访问方法，得到是普通函数</li>
</ul>
</li>
<li>绑定：此时会将<code>self</code>作为<strong>首个参数</strong>添加到参数列表</li>
<li>调用实例方法时，调用相应下层函数</li>
</ul>
</li>
<li><p>函数对象到实例方法对象的转换每次获取实例该属性时都会发生</p>
<ul>
<li>有时可将属性赋值给本地变量、调用实现性能优化</li>
<li>非用户定义函数、不可调用对象在被获取时不会发生转换</li>
<li>实例属性的用户定义函数不会被转换为绑定方法，仅在函数
是类的属性时才会发生</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>Py3中以上特性依赖于<code>___getattribute__</code>实现</li>
</ul>
</blockquote>
<h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><ul>
<li><p>绑定方法对象支持只读获取底层函数对象任意属性</p>
<ul>
<li>但方法属性实际保存在下层函数对象中</li>
<li>所以不能直接设置绑定方法的方法属性，必须在下层函数
对象中显式设置，否则<code>raise AttributeError</code></li>
</ul>
</li>
<li><p>绑定方法有两个特殊只读属性</p>
<ul>
<li><code>m.__self__</code>：操作该方法的类实例</li>
<li><code>m.__func__</code>：底层实现该方法的函数</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li><code>m(args,...)</code>完全等价于<code>m.__func__(m.__self__,args,...)</code></li>
</ul>
</blockquote>
<h4 id="特殊元属性"><a href="#特殊元属性" class="headerlink" title="特殊元属性"></a>特殊元属性</h4><ul>
<li><code>__self__</code>：类对象实例</li>
<li><code>__func__</code>：函数对象实例</li>
<li><code>__doc__</code>：方法文档，等同于<code>__func__.__doc__</code></li>
<li><code>__name__</code>：方法名，等同于<code>__func__.__name__</code></li>
<li><code>__module__</code>：定义方法所在模块名</li>
</ul>
<h3 id="Class-Method-Objects"><a href="#Class-Method-Objects" class="headerlink" title="Class Method Objects"></a><em>Class Method Objects</em></h3><p>类方法：提供了<strong>始终将类绑定为函数对象首个参数</strong>的方式</p>
<ul>
<li>对其他对象的封装，通常用于封装用户定义方法对象</li>
<li>会改变从类、类实例获取该对象的方式</li>
<li>用途<ul>
<li>实现自定义、多个构造器，如<ul>
<li>只调用<code>__new__()</code>、绕过<code>__init__</code>，创建未初始化
的实例</li>
<li>反序列化对象：从字节串反序列构造符合要求的对象</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>通过<code>classmethod()</code>构造器创建</li>
<li>Py3中以上特性依赖于<code>___getattribute__</code>实现</li>
</ul>
</blockquote>
<h3 id="Static-Method-Objects"><a href="#Static-Method-Objects" class="headerlink" title="Static Method Objects"></a><em>Static Method Objects</em></h3><p>静态方法：提供了<strong>避免将函数对象转换为方法对象</strong>的方式</p>
<ul>
<li>对任意其他对象的封装，通常用于封装用户定义方法对象</li>
<li>从类、类实例获取静态方法对象时，实际返回的是封装的对象，
不会被进一步转换</li>
<li>静态方法对象自身不是可调用的，但其封装的对象通常可调用</li>
</ul>
<blockquote>
<ul>
<li>通过内置<code>staticmethod()</code>构造器创建</li>
<li>Py3中以上特性依赖于<code>___getattribute__</code>实现</li>
</ul>
</blockquote>
<h3 id="内置函数、方法"><a href="#内置函数、方法" class="headerlink" title="内置函数、方法"></a>内置函数、方法</h3><blockquote>
<ul>
<li>内置函数：对C函数的外部封装</li>
<li>内置方法：内置函数另一种形式，（类似实例方法）隐式传入
  当前实例作为C函数额外参数</li>
</ul>
</blockquote>
<ul>
<li>包括以下两种类型<ul>
<li><code>builtin_function_or_method</code></li>
<li><code>wrapper_descriptor</code></li>
</ul>
</li>
<li>参数数量、类型由C函数决定</li>
<li>内置方法由支持其的类型描述</li>
</ul>
<h4 id="特殊元属性-1"><a href="#特殊元属性-1" class="headerlink" title="特殊元属性"></a>特殊元属性</h4><ul>
<li><code>__self__</code>：<code>&lt;module &#39;builtins&#39; (built-in)&gt;</code></li>
<li><code>__doc__</code>：函数/方法文档</li>
<li><code>__name__</code>：函数/方法名</li>
<li><code>__module__</code>：所在模块名</li>
</ul>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><ul>
<li>函数是描述器，函数类<code>function</code>实现有<code>__get__</code>方法</li>
<li><code>function.__get__</code>即将函数首个参数进行绑定，返回绑定方法</li>
</ul>
<blockquote>
<ul>
<li>参见<em>cs_python/py3ref/cls_special_methods</em></li>
</ul>
</blockquote>
<h2 id="Generator-Functions"><a href="#Generator-Functions" class="headerlink" title="Generator Functions"></a><em>Generator Functions</em></h2><p>生成器函数：使用<code>yield</code>语句的函数、方法称为生成器函数</p>
<ul>
<li>生成器函数调用时返回生成器迭代器对象，控制执行函数体</li>
</ul>
<blockquote>
<ul>
<li><code>yield</code>表达式参见<em>cs_python/py3ref/expressions</em></li>
</ul>
</blockquote>
<h3 id="Generator-Iterator"><a href="#Generator-Iterator" class="headerlink" title="Generator-Iterator"></a><em>Generator-Iterator</em></h3><p>生成器迭代器：生成器函数执行得到的迭代器</p>
<ul>
<li><p>实现有迭代器协议<code>__next__</code>的迭代器类实例不同于
生成器迭代器，其仅实现迭代</p>
<ul>
<li>迭代执行过程即<code>__next__</code>函数调用，重入（状态维护）
由类负责</li>
<li>无不同迭代状态区别</li>
<li>不会自动获得<code>.send</code>、<code>.throw</code>、<code>.close</code>等方法</li>
</ul>
</li>
<li><p>或者说生成器迭代器是：利用yield表达式对迭代器的的简化
实现，并预定义<code>.send</code>、<code>.throw</code>、<code>.close</code>方法</p>
</li>
</ul>
<blockquote>
<ul>
<li>迭代器协议参见<em>cs_python/py3ref/cls_special_methods</em></li>
</ul>
</blockquote>
<h4 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h4><ul>
<li>其某方法被调用时，生成器函数开始执行</li>
<li>执行到第一个yield表达式被挂起，保留所有局部状态<ul>
<li>局部变量当前绑定</li>
<li>指令指针</li>
<li>内部求值栈</li>
<li>任何异常处理状态</li>
</ul>
</li>
<li>返回<code>expression_list</code></li>
<li>调用生成器某方法，生成函数继续执行</li>
<li>执行<code>return</code>、函数体执行完毕将<code>raise StopIteration</code></li>
</ul>
<blockquote>
<ul>
<li>生成器表达式、yield表达式参见
  <em>cs_python/py3ref/expressions</em></li>
</ul>
</blockquote>
<h4 id="生成器迭代器状态"><a href="#生成器迭代器状态" class="headerlink" title="生成器迭代器状态"></a>生成器迭代器状态</h4><p>生成器在声明周期中有如下4中状态</p>
<ul>
<li><code>&quot;GEN_CREATED&quot;</code>：等待执行</li>
<li><code>&quot;GEN_RUNNING&quot;</code>：正在执行，只有多线程中才能看到</li>
<li><code>&quot;GEN_SUSPENDED&quot;</code>：在yield表达式处挂起状态</li>
<li><code>&quot;GEN_CLOSED&quot;</code>：关闭状态</li>
</ul>
<blockquote>
<ul>
<li>可通过<code>inspect.getgeneratorstate()</code>方法查看</li>
</ul>
</blockquote>
<h4 id="next"><a href="#next" class="headerlink" title="__next__"></a><code>__next__</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">generator</span>.<span class="title">__next__</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：开始生成器函数执行、或从上次执行yield表达式处恢复
执行</p>
<ul>
<li>生成器函数通过<code>__next__</code>方法恢复执行时，yield表达式
始终取值为<code>None</code></li>
<li>执行至下个yield表达式</li>
</ul>
</li>
<li><p>返回值：生成器迭代器产生的下个值</p>
<ul>
<li>yield表达式中<code>expression_list</code>值</li>
<li>若生成器没有产生下个值就退出，<code>raise StopIteration</code></li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>此方法通常隐式通过<code>for</code>循环、<code>next()</code>函数调用</li>
</ul>
</blockquote>
<h4 id="send"><a href="#send" class="headerlink" title="send"></a><code>send</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">generator</span>.<span class="title">send</span>(<span class="params">value</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：恢复生成器函数执行并向其“发送”值<code>value</code></p>
<ul>
<li><code>value</code>参数作为yield表达式的结果</li>
<li>执行至下个yield表达式</li>
</ul>
</li>
<li><p>返回值：生成器迭代器产生的下个值</p>
<ul>
<li>yield表达式中<code>expression_list</code>值</li>
<li>若生成器没有产生下个值就退出，<code>raise StopIteration</code></li>
</ul>
</li>
<li><p>说明</p>
<ul>
<li>若生成器中包含子迭代器，<code>send</code>传参数值将被传递给
下层迭代器，若子迭代器没有合适接收方法、处理，将
<code>raise AttributeError</code>、<code>raise TypeError</code></li>
<li><code>.send</code>方法参数为<code>None</code>时实际不会有传递参数行为<ul>
<li>调用<code>.send()</code>启动生成器时，必须以<code>None</code>作为调用
参数，因为此时没有可以接收值的yield表达式</li>
<li>子迭代器中没有处理参数时，<code>.send(None)</code>也能正常
工作</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="throw"><a href="#throw" class="headerlink" title="throw"></a><code>throw</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">generator</span>.<span class="title">throw</span>(<span class="params"><span class="built_in">type</span>[, value[, traceback]]</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：在生成器<strong>暂停位置处</strong>引发<code>type</code>类型异常</p>
<ul>
<li>若异常被处理：则执行直至下个yield表达式</li>
<li>若生成器函数没有捕获传入异常、或引发另一个异常：异常
会被传播给调用者</li>
</ul>
</li>
<li><p>返回值：返回生成器产生的下个值（若异常被处理）</p>
<ul>
<li>若生成器没有产生下个值就退出，<code>raise StopIteration</code></li>
</ul>
</li>
<li><p>说明</p>
<ul>
<li>若生成器中包含子迭代器，<code>throw</code>传入异常将被传递给
子迭代器</li>
<li>调用<code>throw</code>启动生成器，会在生成器函数开头引发错误</li>
</ul>
</li>
</ul>
<h4 id="close"><a href="#close" class="headerlink" title="close"></a><code>close</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">generator</span>.<span class="title">close</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用途：在生成器函数暂停处<code>raise GeneratorExit</code><ul>
<li>若之后生成器函数正常退出、关闭、引发<code>GeneratorExit</code>
（生成器中未捕获该异常）：则关闭生成器并返回调用者</li>
<li>若生成器继续产生值：则<code>raise RuntimeError</code></li>
<li>若生成器引发其他异常：则传播给调用者</li>
<li>若生成器由于异常、或正常而退出：则无操作</li>
</ul>
</li>
</ul>
<h3 id="Yield表达式—调用外部函数"><a href="#Yield表达式—调用外部函数" class="headerlink" title="Yield表达式—调用外部函数"></a>Yield表达式—调用外部函数</h3><blockquote>
<ul>
<li>生成器函数执行yield表达式类似<strong>调用外部函数</strong></li>
</ul>
</blockquote>
<ul>
<li>当前函数栈保留当前状态、挂起</li>
<li>执行yield表达式“完毕”后，“返回”到调用处</li>
<li>yield表达式“返回值”取决于生成器恢复执行所调用方法<ul>
<li><code>.__next__</code>：<code>for</code>、<code>next()</code>调用，返回<code>None</code></li>
<li><code>.send()</code>：返回<code>.send()</code>参数</li>
</ul>
</li>
<li>此时整体类似于<ul>
<li>主调函数调用生成器函数</li>
<li>生成器函数调用yield表达式</li>
</ul>
</li>
</ul>
<h3 id="生成器函数—协程"><a href="#生成器函数—协程" class="headerlink" title="生成器函数—协程"></a>生成器函数—协程</h3><blockquote>
<ul>
<li>生成器函数类似协程，也被称为<em>semi-coroutine</em>，是协程子集</li>
</ul>
</blockquote>
<ul>
<li>相似点<ul>
<li>可<code>yield</code>多次，有多个入口点</li>
<li>执行可以被挂起</li>
<li>可在恢复执行时传递参数控制执行</li>
</ul>
</li>
<li>不同点<ul>
<li><code>yield</code>后控制权总是转移给生成器迭代器调用者，生成器
函数不能控制<code>yield</code>后继续执行的位置
（<code>yield</code>表达式仅仅传递值给父程序，并不是指定需要
跳转的、平等的协程）</li>
</ul>
</li>
</ul>
<h3 id="生成器函数—try"><a href="#生成器函数—try" class="headerlink" title="生成器函数—try"></a>生成器函数—<code>try</code></h3><blockquote>
<ul>
<li><code>try</code>结构中任何位置都允许yield表达式</li>
</ul>
</blockquote>
<ul>
<li><p>若生成器在<strong>销毁之前</strong>没有恢复执行（引用计数为0、被垃圾
回收），<code>try</code>结构中的yield表达式挂起可能导致<code>finally</code>
子句执行失败</p>
</li>
<li><p>此时应由运行该异步生成器的事件循环、或任务调度器负责调用
生成器-迭代器<code>close()</code>方法，从而允许任何挂起的<code>finally</code>
子句得以执行</p>
</li>
</ul>
<h3 id="例"><a href="#例" class="headerlink" title="例"></a>例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">echo</span>(<span class="params">value=<span class="literal">None</span></span>):</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;execution start&quot;</span>)</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				value = (<span class="keyword">yield</span> value)</span><br><span class="line">			<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">				value = e</span><br><span class="line">	<span class="keyword">finally</span>:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;clean up when gen.close() is called&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	gen = echo(<span class="number">1</span>)</span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">next</span>(gen))		<span class="comment"># 1</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">next</span>(gen))		<span class="comment"># None</span></span><br><span class="line">	<span class="built_in">print</span>(gen.send(<span class="number">2</span>))		<span class="comment"># 2</span></span><br><span class="line">	<span class="built_in">print</span>(gen.throw(TypeError, <span class="string">&quot;spam&quot;</span>))	<span class="comment"># TypeError(&#x27;spam&#x27;,)</span></span><br><span class="line">	gen.close()				<span class="comment"># clean up...</span></span><br></pre></td></tr></table></figure>
<h2 id="Coroutine-Function"><a href="#Coroutine-Function" class="headerlink" title="Coroutine Function"></a><em>Coroutine Function</em></h2><p>协程函数：使用<code>async def</code>定义的函数、方法</p>
<ul>
<li>调用时返回一个<code>coroutine</code>对象</li>
<li>可能包含<code>await</code>表达式、<code>async with</code>、<code>async for</code>语句<ul>
<li>即协程函数能在执行过程中挂起、恢复</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>协程参见<em>cs_program/#todo</em></li>
</ul>
</blockquote>
<h3 id="Coroutine-Objects"><a href="#Coroutine-Objects" class="headerlink" title="Coroutine Objects"></a><em>Coroutine Objects</em></h3><p>协程对象：属于<em>awaitable</em>对象</p>
<ul>
<li><p>协程执行：调用<code>__await__</code>，迭代其返回值进行控制</p>
<ul>
<li>协程结束执行、返回时，迭代器<code>raise StopIteration</code>，
异常的<code>value</code>属性将指向返回值</li>
<li>等待协程超过一次将<code>raise RuntimeError</code></li>
</ul>
</li>
<li><p>若协程引发异常，其会被迭代器传播</p>
<ul>
<li>协程不应该直接引发未处理的<code>StopIteration</code></li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>可等待对象参见<em>cs_python/py3ref/cls_special_methods</em></li>
</ul>
</blockquote>
<h4 id="send-1"><a href="#send-1" class="headerlink" title="send"></a><code>send</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span>.<span class="title">send</span>(<span class="params">value</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：开始、恢复协程执行</p>
<ul>
<li><code>value is None</code>：相当于等待<code>__await__()</code>返回迭代器
结果下一项</li>
<li><code>value is not None</code>：此方法将委托给导致协程挂起的
迭代器的<code>send()</code>方法</li>
</ul>
</li>
<li><p>返回值：返回值、异常等同对<code>__await__()</code>返回值迭代结果</p>
</li>
</ul>
<h4 id="throw-1"><a href="#throw-1" class="headerlink" title="throw"></a><code>throw</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span>.<span class="title">throw</span>(<span class="params"><span class="built_in">type</span>[, value[, traceback]]</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：在协程内引发指定异常</p>
<ul>
<li>此方法将委托给导致协程内挂起的迭代器的<code>throw()</code>方法
，若其存在</li>
<li>否则异常在挂起点被引发</li>
</ul>
</li>
<li><p>返回值：返回值、异常等同对<code>__await__()</code>返回值迭代结果</p>
<ul>
<li>若异常未在协程内被捕获，则传回给主调者</li>
</ul>
</li>
</ul>
<h4 id="close-1"><a href="#close-1" class="headerlink" title="close"></a><code>close</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span>.<span class="title">close</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用途：清理自身并退出<ul>
<li>若协程被挂起，此方法先被委托给导致该协程挂起的迭代器
的<code>.close()</code>方法，若其存在</li>
<li>然后在挂起点<code>raise GeneratorExit</code>，使得协程立即清理
自身</li>
<li>最后协程被标记为已结束执行，即使未被启动</li>
<li>协程对象将被销毁时，会被自动调用</li>
</ul>
</li>
</ul>
<h2 id="Asynchronous-Generator-Functions"><a href="#Asynchronous-Generator-Functions" class="headerlink" title="Asynchronous Generator Functions"></a><em>Asynchronous Generator Functions</em></h2><p>异步生成器函数：包含<code>yield</code>语句、使用<code>async def</code>定义函数、
方法（即在协程中）</p>
<ul>
<li>返回异步生成器迭代器对象，控制执行函数体</li>
</ul>
<blockquote>
<ul>
<li><code>yield from</code>表达式在异步生成器函数中使用将引发语法错误</li>
</ul>
</blockquote>
<h3 id="Asynchronous-Generator-Iterator"><a href="#Asynchronous-Generator-Iterator" class="headerlink" title="Asynchronous Generator-Iterator"></a><em>Asynchronous Generator-Iterator</em></h3><p>异步生成器迭代器</p>
<ul>
<li><p>异步体现：<code>async def</code>定义协程函数中可以使用异步代码</p>
</li>
<li><p>异步生成器迭代器方法返回的可等待对象<strong>们</strong>执行同一函数栈</p>
<ul>
<li>可等待对象被<code>await</code><strong>运行时才会执行</strong>异步函数体</li>
<li>类似普通生成器迭代器，执行到yield表达式挂起</li>
<li>则连续返回多个可等待对象可以乱序<code>await</code></li>
</ul>
<blockquote>
<ul>
<li>可以视为返回<strong>待执行函数体</strong></li>
</ul>
</blockquote>
</li>
</ul>
<blockquote>
<ul>
<li><p>异步生成器迭代器执行过程、yield表达式、<code>try</code>结构、同异步
  迭代器协议关联， 均参见普通生成器迭代器</p>
</li>
<li><p>异步迭代器协议参见<em>cs_python/py3ref/cls_special_methods</em></p>
</li>
<li><p>异步生成器函数使用<code>yield from</code>语句将引发语法错误</p>
</li>
</ul>
</blockquote>
<h4 id="最终化处理-todo"><a href="#最终化处理-todo" class="headerlink" title="最终化处理#todo"></a>最终化处理#todo</h4><p>处理最终化：事件循环应该定义终结器函数</p>
<ul>
<li>其接收异步生成器迭代器、且可能调用<code>aclose()</code>方法并执行
协程</li>
<li>终结器可以通过调用<code>sys.set_asyncgen_hooks()</code>注册</li>
<li>首次迭代时，异步生成器迭代器将保存已注册终结器以便最终化
时调用</li>
</ul>
<h4 id="anext"><a href="#anext" class="headerlink" title="__anext__"></a><code>__anext__</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span> <span class="title">agen</span>.<span class="title">__anext__</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：返回可等待对象，可等待对象运行时开始、恢复异步
生成器函数执行</p>
<ul>
<li>异步生成器函数通过<code>__anext__</code>方法恢复执行时，返回的
可等待对象中yield表达式始终取值为<code>None</code></li>
</ul>
</li>
<li><p><strong>可等待对象返回值</strong>：返回异步生成器的下个值</p>
<ul>
<li>执行至下个yield表达式，返回<code>expression_list</code>值</li>
<li>若异步生成器没有产生下个值就退出，则
<code>raise StopAsyncIteration</code>，</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>此方法通常由<code>async for</code>异步循环隐式调用</li>
</ul>
</blockquote>
<h4 id="asend"><a href="#asend" class="headerlink" title="asend"></a><code>asend</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span> <span class="title">agen</span>.<span class="title">asend</span>(<span class="params">value</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：返回可等待对象，可等待对象运行时开始、恢复异步
生成器函数执行，并向其“发送”值<code>value</code></p>
<ul>
<li><code>value</code>参数作为yield表达式的结果</li>
<li>执行至下个yield表达式</li>
</ul>
</li>
<li><p>返回值：异步生成器产生的下个值</p>
<ul>
<li>yield表达式中<code>expression_list</code>值</li>
<li>若生成器没有产生下个值就退出，则
<code>raise StopAsyncIteration</code></li>
</ul>
</li>
<li><p>说明</p>
<ul>
<li>调用<code>.asend()</code>启动生成器时，必须以<code>None</code>作为调用参数</li>
</ul>
</li>
</ul>
<h4 id="athrow"><a href="#athrow" class="headerlink" title="athrow"></a><code>athrow</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span> <span class="title">agen</span>.<span class="title">athrow</span>(<span class="params"><span class="built_in">type</span>[, value[, traceback]]</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>用途：返回可等待对象，可等待对象运行时将在异步生成器函数
<strong>暂停位置处</strong>引发<code>type</code>类型异常</p>
<ul>
<li>若异常被处理：则执行直至下个yield表达式</li>
<li>若异步生成器函数没有捕获传入异常、或引发另一个异常：
可等待对象运行时异常会被传播给调用者</li>
</ul>
</li>
<li><p>返回值：返回生成器产生的下个值（若异常被处理）</p>
<ul>
<li>若生成器没有产生下个值就退出，则
<code>raise StopAsyncIteration</code></li>
</ul>
</li>
<li><p>说明</p>
<ul>
<li>调用<code>athrow</code>启动异步生成器，会在函数开头引发错误</li>
</ul>
</li>
</ul>
<h4 id="aclose"><a href="#aclose" class="headerlink" title="aclose"></a><code>aclose</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span>(<span class="params">pre</span>) <span class="title">coroutine</span> <span class="title">agen</span>.<span class="title">aclose</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用途：返回可等待对象，可等待对象运行时在异步生成器函数
暂停处<code>raise GeneratorExit</code><ul>
<li>若异步生成器函数正常退出、关闭、引发<code>GeneratorExit</code>
（生成器中未捕获该异常）：则运行可等待对象将
<code>raise StopIteration</code>？？？</li>
<li>后续调用异步生成器迭代器方法返回其他可等待对象：则
运行可等待对象将<code>raise StopAsyncIteration</code></li>
<li>若异步生成器函数产生值：则运行可等待对象将
<code>raise RuntimeError</code></li>
<li>若异步生成器迭代器已经异常、正常退出，则后续调用
<code>aclose</code>方法将返回无行为可等待对象</li>
</ul>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-09T17:11:37.000Z" title="6/10/2019, 1:11:37 AM">2019-06-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-06-09T17:11:37.000Z" title="6/10/2019, 1:11:37 AM">2019-06-10</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3std/">Py3std</a></span><span class="level-item">2 minutes read (About 366 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3std/data_persistence.html">数据持久化</a></h1><div class="content"><h2 id="DBM"><a href="#DBM" class="headerlink" title="DBM"></a>DBM</h2><p>DBM文件：python库中数据库管理的标准工具之一</p>
<ul>
<li>实现了数据的随机访问<ul>
<li>可以使用键访问存储的文本字符串</li>
</ul>
</li>
<li>DBM文件有多个实现<ul>
<li>python标准库中<code>dbm/dbm.py</code></li>
</ul>
</li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ul>
<li>使用DBM文件和使用内存字典类型非常相似<ul>
<li>支持通过键抓取、测试、删除对象</li>
</ul>
</li>
</ul>
<h2 id="pickle"><a href="#pickle" class="headerlink" title="pickle"></a><code>pickle</code></h2><ul>
<li>将内存中的python对象转换为序列化的字节流，可以写入任何
输出流中</li>
<li>根据序列化的字节流重新构建原来内存中的对象</li>
<li>感觉上比较像XML的表示方式，但是是python专用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line">dbfile = <span class="built_in">open</span>(<span class="string">&quot;people.pkl&quot;</span>, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">pickle.dump(db, dbfile)</span><br><span class="line">dbfile.close()</span><br><span class="line">dbfile = <span class="built_in">open</span>(<span class="string">&quot;people.pkl&quot;</span>, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line">db = pickle.load(dbfile)</span><br><span class="line">dbfile.close()</span><br></pre></td></tr></table></figure>
<ul>
<li>不支持<code>pickle</code>序列化的数据类型<ul>
<li>套接字</li>
</ul>
</li>
</ul>
<h2 id="shelves"><a href="#shelves" class="headerlink" title="shelves"></a><code>shelves</code></h2><ul>
<li>就像能必须打开着的、存储持久化对象的词典<ul>
<li>自动处理内容、文件之间的映射</li>
<li>在程序退出时进行持久化，自动分隔存储记录，只获取、
更新被访问、修改的记录</li>
</ul>
</li>
<li>使用像一堆只存储一条记录的pickle文件<ul>
<li>会自动在当前目录下创建许多文件</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> shelves</span><br><span class="line">db = shelves.<span class="built_in">open</span>(<span class="string">&quot;people-shelves&quot;</span>, writeback=<span class="literal">True</span>)</span><br><span class="line">	// `writeback`：载入所有数据进内存缓存，关闭时再写回，</span><br><span class="line">		// 能避免手动写回，但会消耗内存，关闭变慢</span><br><span class="line">db[<span class="string">&quot;bob&quot;</span>] = <span class="string">&quot;Bob&quot;</span></span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>
<h2 id="copyreg"><a href="#copyreg" class="headerlink" title="copyreg"></a><code>copyreg</code></h2><h2 id="marshal"><a href="#marshal" class="headerlink" title="marshal"></a><code>marshal</code></h2><h2 id="sqlite3"><a href="#sqlite3" class="headerlink" title="sqlite3"></a><code>sqlite3</code></h2></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2019-06-09T17:10:04.000Z" title="6/10/2019, 1:10:04 AM">2019-06-10</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-06-09T17:10:04.000Z" title="6/10/2019, 1:10:04 AM">2019-06-10</time></span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a><span> / </span><a class="link-muted" href="/categories/Python/Py3std/">Py3std</a></span><span class="level-item">4 minutes read (About 649 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/Python/Py3std/binary_data.html">二进制数据服务</a></h1><div class="content"><h2 id="struct"><a href="#struct" class="headerlink" title="struct"></a><code>struct</code></h2><p><code>struct</code>模块：用于打包、拆包C<code>struct</code>格式二进制数据</p>
<ul>
<li>使用python字节串存储C<code>struct</code>数据</li>
<li>需要给出格式声明，指定二进制中存储格式</li>
</ul>
<h3 id="格式说明"><a href="#格式说明" class="headerlink" title="格式说明"></a>格式说明</h3><h4 id="字节序、对齐"><a href="#字节序、对齐" class="headerlink" title="字节序、对齐"></a>字节序、对齐</h4><div class="table-container">
<table>
<thead>
<tr>
<th>格式符</th>
<th>字节序（大、小端）</th>
<th>类型大小</th>
<th>字段对齐方式</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@</code>（缺省值）</td>
<td>原生字节序</td>
<td>原生大小</td>
<td>原生对齐</td>
</tr>
<tr>
<td><code>=</code></td>
<td>原生字节序</td>
<td>标准大小</td>
<td>标准对齐</td>
</tr>
<tr>
<td><code>&lt;</code></td>
<td>lb-endian</td>
<td>标准大小</td>
<td>标准对齐</td>
</tr>
<tr>
<td><code>&gt;</code></td>
<td>bl-endian</td>
<td>标准大小</td>
<td>标准对齐</td>
</tr>
<tr>
<td><code>!</code></td>
<td>同<code>&gt;</code></td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<ul>
<li>原生对齐：C对齐方式，字段起始位置须为其长度整数倍</li>
<li>标准对齐：按字节对齐，无需使用<code>0</code>补齐</li>
</ul>
</blockquote>
<h4 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h4><div class="table-container">
<table>
<thead>
<tr>
<th>Format</th>
<th>C Type</th>
<th>Python</th>
<th>Bytes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>x</code></td>
<td>pad byte</td>
<td>no value</td>
<td>1</td>
</tr>
<tr>
<td><code>?</code></td>
<td><code>_Bool</code></td>
<td><code>bool</code></td>
<td>1</td>
</tr>
<tr>
<td><code>h</code></td>
<td><code>short</code></td>
<td><code>integer</code></td>
<td>2</td>
</tr>
<tr>
<td><code>H</code></td>
<td><code>unsigned short</code></td>
<td><code>integer</code></td>
<td>2</td>
</tr>
<tr>
<td><code>i</code></td>
<td><code>int</code></td>
<td><code>integer</code></td>
<td>4</td>
</tr>
<tr>
<td><code>I</code></td>
<td><code>unsigned int</code></td>
<td><code>integer</code></td>
<td>4</td>
</tr>
<tr>
<td><code>l</code></td>
<td><code>long</code></td>
<td><code>integer</code></td>
<td>4</td>
</tr>
<tr>
<td><code>L</code></td>
<td><code>unsigned long</code></td>
<td><code>long</code></td>
<td>4</td>
</tr>
<tr>
<td><code>q</code></td>
<td><code>long long</code></td>
<td><code>long</code></td>
<td>8</td>
</tr>
<tr>
<td><code>Q</code></td>
<td><code>unsigned long long</code></td>
<td><code>long</code></td>
<td>8</td>
</tr>
<tr>
<td><code>f</code></td>
<td><code>float</code></td>
<td><code>float</code></td>
<td>4</td>
</tr>
<tr>
<td><code>d</code></td>
<td><code>double</code></td>
<td><code>float</code></td>
<td>4</td>
</tr>
<tr>
<td><code>c</code></td>
<td><code>char</code></td>
<td><code>str</code> of length1</td>
<td>1</td>
</tr>
<tr>
<td><code>b</code></td>
<td><code>signed char</code></td>
<td><code>bytes</code> of length1</td>
<td>1</td>
</tr>
<tr>
<td><code>B</code></td>
<td><code>unsigned char</code></td>
<td><code>bytes</code> of length1</td>
<td>1</td>
</tr>
<tr>
<td><code>s</code></td>
<td><code>char[]</code></td>
<td><code>str</code></td>
<td>1</td>
</tr>
<tr>
<td><code>p</code></td>
<td>pascal string，带长度</td>
<td><code>str</code></td>
<td>NA</td>
</tr>
<tr>
<td><code>n</code></td>
<td><code>ssize_t</code></td>
<td><code>integer</code></td>
<td>NA</td>
</tr>
<tr>
<td><code>N</code></td>
<td><code>size_t</code></td>
<td><code>integer</code></td>
<td>NA</td>
</tr>
<tr>
<td><code>P</code></td>
<td><code>void *</code></td>
<td>足够容纳指针的整形</td>
<td>NA</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><p>在类型符前添加数字可以指定类型重复次数</p>
</li>
<li><p>字符、字符串类型实参须以字节串形式给出</p>
<ul>
<li>字符：必须以长度为1字节串形式给出，重复须对应多参数</li>
<li>字符串：可以是任意长度字节串，重复对应单个字符串<ul>
<li>长于格式指定长度被截断</li>
<li>短于格式指定长度用<code>\0x00</code>补齐</li>
</ul>
</li>
</ul>
</li>
<li><p>python按以上长度封装各类型，但C各类型长度取决于平台，
以上近视64位机器最可能对应C类型</p>
<ul>
<li>非64位机器<code>long long</code>类型大部分为4bytes</li>
</ul>
</li>
<li><p>用途</p>
<ul>
<li>封装、解压数据</li>
<li><code>reinterpret_cast</code>类型转换</li>
</ul>
</li>
</ul>
<h3 id="Struct"><a href="#Struct" class="headerlink" title="Struct"></a><code>Struct</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Struct</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, fmt</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用途：根据指定格式<code>fmt</code>编译<code>Sturct</code>对象<ul>
<li><code>Sturct</code>对象可以调用以下方法，无需再次指定<code>fmt</code></li>
</ul>
</li>
</ul>
<h3 id="Pack"><a href="#Pack" class="headerlink" title="Pack"></a><em>Pack</em></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">struct</span>.<span class="title">pack</span>(<span class="params">fmt, v1, v2,...</span>) -&gt; <span class="built_in">bytes</span>:</span></span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">struct</span>.<span class="title">pack_into</span>(<span class="params">fmt, buffer, offset , v1, v2, ...</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>pack</code>：按照指定格式<code>fmt</code>封装数据为字节串</li>
<li><code>pack_into</code>：将字节串写入<code>buffer</code>指定偏移<code>offset</code>处</li>
</ul>
<h3 id="Unpack"><a href="#Unpack" class="headerlink" title="Unpack"></a><em>Unpack</em></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">struct</span>.<span class="title">unpack</span>(<span class="params">fmt, buffer</span>) -&gt; (v1, v2,...):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">struct</span>.<span class="title">unpack</span>(<span class="params">fmt, buffer, offset=<span class="number">0</span></span>) -&gt; (v1, v2, ...):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">struct</span>.<span class="title">iter_unpack</span>(<span class="params">fmt, buffer</span>) -&gt; iterator(v1, v2,...):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>unpack</code>：按照指定格式<code>fmt</code>拆包字节串<code>buffer</code></li>
<li><code>unpack_from</code>：从偏移<code>offset</code>处开始拆包</li>
<li><code>iter_unpack</code>：迭代解压包含多个<code>fmt</code>的<code>buffer</code></li>
</ul>
<h3 id="calsize"><a href="#calsize" class="headerlink" title="calsize"></a><code>calsize</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">struct</span>.<span class="title">calsize</span>(<span class="params">fmt</span>) -&gt; integer:</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用途：计算封装指定格式<code>fmt</code>所需字节数</li>
</ul>
<h2 id="codecs"><a href="#codecs" class="headerlink" title="codecs"></a><code>codecs</code></h2></div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/categories/Python/page/2/">Previous</a></div><div class="pagination-next"><a href="/categories/Python/page/4/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/categories/Python/">1</a></li><li><a class="pagination-link" href="/categories/Python/page/2/">2</a></li><li><a class="pagination-link is-current" href="/categories/Python/page/3/">3</a></li><li><a class="pagination-link" href="/categories/Python/page/4/">4</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/categories/Python/page/9/">9</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Algorithm/"><span class="level-start"><span class="level-item">Algorithm</span></span><span class="level-end"><span class="level-item tag">36</span></span></a><ul><li><a class="level is-mobile" href="/categories/Algorithm/Data-Structure/"><span class="level-start"><span class="level-item">Data Structure</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/categories/Algorithm/Heuristic/"><span class="level-start"><span class="level-item">Heuristic</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Algorithm/Issue/"><span class="level-start"><span class="level-item">Issue</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Algorithm/Problem/"><span class="level-start"><span class="level-item">Problem</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/Algorithm/Specification/"><span class="level-start"><span class="level-item">Specification</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/C-C/"><span class="level-start"><span class="level-item">C/C++</span></span><span class="level-end"><span class="level-item tag">34</span></span></a><ul><li><a class="level is-mobile" href="/categories/C-C/Cppref/"><span class="level-start"><span class="level-item">Cppref</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/C-C/Cstd/"><span class="level-start"><span class="level-item">Cstd</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/C-C/MPI/"><span class="level-start"><span class="level-item">MPI</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/C-C/STL/"><span class="level-start"><span class="level-item">STL</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/CS/"><span class="level-start"><span class="level-item">CS</span></span><span class="level-end"><span class="level-item tag">14</span></span></a><ul><li><a class="level is-mobile" href="/categories/CS/Character/"><span class="level-start"><span class="level-item">Character</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/CS/Network/"><span class="level-start"><span class="level-item">Network</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/CS/Parallel/"><span class="level-start"><span class="level-item">Parallel</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/CS/Program-Design/"><span class="level-start"><span class="level-item">Program Design</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/CS/Storage/"><span class="level-start"><span class="level-item">Storage</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Daily-Life/"><span class="level-start"><span class="level-item">Daily Life</span></span><span class="level-end"><span class="level-item tag">4</span></span></a><ul><li><a class="level is-mobile" href="/categories/Daily-Life/Maxism/"><span class="level-start"><span class="level-item">Maxism</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Database/"><span class="level-start"><span class="level-item">Database</span></span><span class="level-end"><span class="level-item tag">27</span></span></a><ul><li><a class="level is-mobile" href="/categories/Database/Hadoop/"><span class="level-start"><span class="level-item">Hadoop</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Database/SQL-DB/"><span class="level-start"><span class="level-item">SQL DB</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/Database/Spark/"><span class="level-start"><span class="level-item">Spark</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">5</span></span></a><ul><li><a class="level is-mobile" href="/categories/Java/Scala/"><span class="level-start"><span class="level-item">Scala</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">42</span></span></a><ul><li><a class="level is-mobile" href="/categories/Linux/Bash-Programming/"><span class="level-start"><span class="level-item">Bash Programming</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/Configuration/"><span class="level-start"><span class="level-item">Configuration</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/File-System/"><span class="level-start"><span class="level-item">File System</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/IPC/"><span class="level-start"><span class="level-item">IPC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/Network/"><span class="level-start"><span class="level-item">Network</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/Process-Schedual/"><span class="level-start"><span class="level-item">Process Schedual</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/Shell/"><span class="level-start"><span class="level-item">Shell</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/Tool/"><span class="level-start"><span class="level-item">Tool</span></span><span class="level-end"><span class="level-item tag">14</span></span></a><ul><li><a class="level is-mobile" href="/categories/Linux/Tool/Vi/"><span class="level-start"><span class="level-item">Vi</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="/categories/ML-Model/"><span class="level-start"><span class="level-item">ML Model</span></span><span class="level-end"><span class="level-item tag">21</span></span></a><ul><li><a class="level is-mobile" href="/categories/ML-Model/Linear-Model/"><span class="level-start"><span class="level-item">Linear Model</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Model/Model-Component/"><span class="level-start"><span class="level-item">Model Component</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Model/Nolinear-Model/"><span class="level-start"><span class="level-item">Nolinear Model</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Model/Unsupervised-Model/"><span class="level-start"><span class="level-item">Unsupervised Model</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/ML-Specification/"><span class="level-start"><span class="level-item">ML Specification</span></span><span class="level-end"><span class="level-item tag">17</span></span></a><ul><li><a class="level is-mobile" href="/categories/ML-Specification/Click-Through-Rate/"><span class="level-start"><span class="level-item">Click Through Rate</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul><li><a class="level is-mobile" href="/categories/ML-Specification/Click-Through-Rate/Recommandation-System/"><span class="level-start"><span class="level-item">Recommandation System</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/ML-Specification/Computer-Vision/"><span class="level-start"><span class="level-item">Computer Vision</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Specification/FinTech/"><span class="level-start"><span class="level-item">FinTech</span></span><span class="level-end"><span class="level-item tag">5</span></span></a><ul><li><a class="level is-mobile" href="/categories/ML-Specification/FinTech/Risk-Control/"><span class="level-start"><span class="level-item">Risk Control</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/ML-Specification/Graph-Analysis/"><span class="level-start"><span class="level-item">Graph Analysis</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Specification/NLP/"><span class="level-start"><span class="level-item">NLP</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/ML-Technique/"><span class="level-start"><span class="level-item">ML Technique</span></span><span class="level-end"><span class="level-item tag">10</span></span></a><ul><li><a class="level is-mobile" href="/categories/ML-Technique/Feature-Engineering/"><span class="level-start"><span class="level-item">Feature Engineering</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Technique/Neural-Network/"><span class="level-start"><span class="level-item">Neural Network</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/ML-Theory/"><span class="level-start"><span class="level-item">ML Theory</span></span><span class="level-end"><span class="level-item tag">11</span></span></a><ul><li><a class="level is-mobile" href="/categories/ML-Theory/Loss/"><span class="level-start"><span class="level-item">Loss</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Theory/Model-Enhencement/"><span class="level-start"><span class="level-item">Model Enhencement</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/ML-Theory/Optimization/"><span class="level-start"><span class="level-item">Optimization</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Math-Algebra/"><span class="level-start"><span class="level-item">Math Algebra</span></span><span class="level-end"><span class="level-item tag">4</span></span></a><ul><li><a class="level is-mobile" href="/categories/Math-Algebra/Linear-Algebra/"><span class="level-start"><span class="level-item">Linear Algebra</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Math-Algebra/Universal-Algebra/"><span class="level-start"><span class="level-item">Universal Algebra</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Math-Analysis/"><span class="level-start"><span class="level-item">Math Analysis</span></span><span class="level-end"><span class="level-item tag">23</span></span></a><ul><li><a class="level is-mobile" href="/categories/Math-Analysis/Fourier-Analysis/"><span class="level-start"><span class="level-item">Fourier Analysis</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Math-Analysis/Functional-Analysis/"><span class="level-start"><span class="level-item">Functional Analysis</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Math-Analysis/Optimization/"><span class="level-start"><span class="level-item">Optimization</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile" href="/categories/Math-Analysis/Real-Analysis/"><span class="level-start"><span class="level-item">Real Analysis</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Math-Mixin/"><span class="level-start"><span class="level-item">Math Mixin</span></span><span class="level-end"><span class="level-item tag">18</span></span></a><ul><li><a class="level is-mobile" href="/categories/Math-Mixin/Statistics/"><span class="level-start"><span class="level-item">Statistics</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Math-Mixin/Time-Series/"><span class="level-start"><span class="level-item">Time Series</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Probability/"><span class="level-start"><span class="level-item">Probability</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">89</span></span></a><ul><li><a class="level is-mobile" href="/categories/Python/Cookbook/"><span class="level-start"><span class="level-item">Cookbook</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Jupyter/"><span class="level-start"><span class="level-item">Jupyter</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Keras/"><span class="level-start"><span class="level-item">Keras</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Matplotlib/"><span class="level-start"><span class="level-item">Matplotlib</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Numpy/"><span class="level-start"><span class="level-item">Numpy</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Pandas/"><span class="level-start"><span class="level-item">Pandas</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Py3Ref/"><span class="level-start"><span class="level-item">Py3Ref</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Py3std/"><span class="level-start"><span class="level-item">Py3std</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Pywin32/"><span class="level-start"><span class="level-item">Pywin32</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Readme/"><span class="level-start"><span class="level-item">Readme</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/TensorFlow/"><span class="level-start"><span class="level-item">TensorFlow</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/Twists/"><span class="level-start"><span class="level-item">Twists</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/RLang/"><span class="level-start"><span class="level-item">RLang</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Rust/"><span class="level-start"><span class="level-item">Rust</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/Set/"><span class="level-start"><span class="level-item">Set</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Tool/"><span class="level-start"><span class="level-item">Tool</span></span><span class="level-end"><span class="level-item tag">13</span></span></a><ul><li><a class="level is-mobile" href="/categories/Tool/Editor/"><span class="level-start"><span class="level-item">Editor</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Tool/Markup-Language/"><span class="level-start"><span class="level-item">Markup Language</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Tool/Web-Browser/"><span class="level-start"><span class="level-item">Web Browser</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Tool/Windows/"><span class="level-start"><span class="level-item">Windows</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Web/"><span class="level-start"><span class="level-item">Web</span></span><span class="level-end"><span class="level-item tag">6</span></span></a><ul><li><a class="level is-mobile" href="/categories/Web/CSS/"><span class="level-start"><span class="level-item">CSS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/NPM/"><span class="level-start"><span class="level-item">NPM</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/Proxy/"><span class="level-start"><span class="level-item">Proxy</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Web/Thrift/"><span class="level-start"><span class="level-item">Thrift</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://octodex.github.com/images/hula_loop_octodex03.gif" alt="UBeaRLy"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">UBeaRLy</p><p class="is-size-6 is-block">Protector of Proxy</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Earth, Solar System</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">392</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">93</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">522</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/xyy15926" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/xyy15926"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-04T15:07:54.896Z">2021-08-04</time></p><p class="title"><a href="/uncategorized/README.html"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-03T07:46:51.000Z">2021-08-03</time></p><p class="title"><a href="/Web/NPM/hexo_config.html">Hexo 建站</a></p><p class="categories"><a href="/categories/Web/">Web</a> / <a href="/categories/Web/NPM/">NPM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-03T02:32:45.000Z">2021-08-03</time></p><p class="title"><a href="/Web/NPM/config.html">NPM 总述</a></p><p class="categories"><a href="/categories/Web/">Web</a> / <a href="/categories/Web/NPM/">NPM</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-08-02T08:11:11.000Z">2021-08-02</time></p><p class="title"><a href="/Python/Py3std/internet_data.html">互联网数据</a></p><p class="categories"><a href="/categories/Python/">Python</a> / <a href="/categories/Python/Py3std/">Py3std</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-29T13:55:00.000Z">2021-07-29</time></p><p class="title"><a href="/Linux/Shell/sh_apps.html">Shell 应用程序</a></p><p class="categories"><a href="/categories/Linux/">Linux</a> / <a href="/categories/Linux/Shell/">Shell</a></p></div></article></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">Advertisement</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="pub-5385776267343559" data-ad-slot="6995841235" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="https://api.follow.it/subscription-form/WWxwMVBsOUtoNTdMSlJ4Z1lWVnRISERsd2t6ek9MeVpEUWs0YldlZGxUdXlKdDNmMEZVV1hWaFZFYWFSNmFKL25penZodWx3UzRiaVkxcnREWCtOYUJhZWhNbWpzaUdyc1hPangycUh5RTVjRXFnZnFGdVdSTzZvVzJBcTJHKzl8aXpDK1ROWWl4N080YkFEK3QvbEVWNEJuQjFqdWdxODZQcGNoM1NqbERXST0=/8" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="UBeaRLy" height="28"></a><p class="is-size-7"><span>&copy; 2021 UBeaRLy</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/xyy15926/proxy"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>